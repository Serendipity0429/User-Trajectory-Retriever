{% extends "base.html" %}

{% block title %}Benchmark Dashboard{% endblock %}

{% block content %}
<div class="container mt-5 px-lg-4">
    <div class="pb-3 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-speedometer2 me-2"></i>Benchmark Dashboard</h1>
        <p class="text-muted mb-0">Select a benchmark to run or configure LLM settings.</p>
    </div>

    <div class="row">
        <!-- Benchmark Types -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Benchmark Types</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'benchmark:interactive_llm' %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Multi-Turn LLM Benchmark</h6>
                        </div>
                        <p class="mb-1 small text-muted">Evaluate model performance over multiple turns with corrective feedback.</p>
                    </a>
                    <a href="{% url 'benchmark:adhoc_llm' %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Ad-hoc LLM Benchmark</h6>
                        </div>
                        <p class="mb-1 small text-muted">Run the model against the full QA pipeline and evaluate its performance.</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- LLM Configuration -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseConfig" style="cursor: pointer;">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>LLM Configuration</h5>
                </div>
                <div id="collapseConfig" class="collapse show">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="llm_base_url" class="form-label">Base URL</label>
                            <input type="text" class="form-control" id="llm_base_url" value="{{ llm_settings.llm_base_url|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="llm_model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="llm_model" value="{{ llm_settings.llm_model|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="llm_api_key" class="form-label">API Key</label>
                            <input type="text" class="form-control" id="llm_api_key" value="{{ llm_settings.llm_api_key|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="max_retries" class="form-label">Max Retries</label>
                            <input type="number" class="form-control" id="max_retries" value="{{ llm_settings.max_retries }}">
                        </div>
                        <hr>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-primary me-2" id="save-settings-btn"><i class="bi bi-save me-1"></i> Save</button>
                            <button type="button" class="btn btn-outline-info me-2" id="test-connection-btn"><i class="bi bi-person-check me-1"></i> Test Connection</button>
                            <button type="button" class="btn btn-outline-secondary" id="restore-defaults-btn"><i class="bi bi-server me-1"></i> Load .env</button>
                        </div>
                        <div id="test-connection-result" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function testConnection() {
        const resultDiv = document.getElementById('test-connection-result');
        const btn = document.getElementById('test-connection-btn');
        const originalText = btn.innerHTML;
        
        resultDiv.innerHTML = '';
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';

        const data = {
            llm_base_url: document.getElementById('llm_base_url').value,
            llm_api_key: document.getElementById('llm_api_key').value,
        };
        const csrfToken = '{{ csrf_token }}';

        fetch("{% url 'benchmark:test_llm_connection' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            if (status === 200) {
                resultDiv.innerHTML = `<div class="alert alert-success" role="alert">${body.message}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger" role="alert">${body.message}</div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger" role="alert">A network error occurred.</div>`;
            console.error('Error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }

    function saveSettings() {
        const data = {
            llm_base_url: document.getElementById('llm_base_url').value,
            llm_api_key: document.getElementById('llm_api_key').value,
            llm_model: document.getElementById('llm_model').value,
            max_retries: document.getElementById('max_retries').value
        };
        fetch("{% url 'benchmark:save_llm_settings' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok') {
                const btn = document.getElementById('save-settings-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Saved!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-primary');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 1500);
            } else {
                alert('Error saving settings: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An network error occurred while saving settings.');
        });
    }

    function restoreDefaults() {
        fetch("{% url 'benchmark:get_llm_env_vars' %}")
            .then(response => response.json())
            .then(data => {
                if(data.error) {
                    alert('Error loading .env variables: ' + data.error);
                } else {
                    document.getElementById('llm_base_url').value = data.llm_base_url;
                    document.getElementById('llm_api_key').value = data.llm_api_key;
                    document.getElementById('llm_model').value = data.llm_model;
                    saveSettings();
                }
            });
    }

    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    document.getElementById('test-connection-btn').addEventListener('click', testConnection);
    document.getElementById('restore-defaults-btn').addEventListener('click', restoreDefaults);
});
</script>
{% endblock %}
