<div class="card shadow-sm mb-4">
    <div class="card-header" id="headingConfig" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="{% if card_expanded %}true{% else %}false{% endif %}" aria-controls="collapseConfig" style="cursor: pointer;">
        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>LLM Configuration</h5>
    </div>
    <div id="collapseConfig" class="collapse {% if card_expanded %}show{% endif %}">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="llm_base_url" class="form-label">Base URL</label>
                    <input type="text" class="form-control" id="llm_base_url" placeholder="Optional: e.g., http://localhost:11434/v1" value="{{ llm_settings.llm_base_url|safe }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="llm_model" class="form-label">Model Name</label>
                    <input type="text" class="form-control" id="llm_model" placeholder="e.g., gpt-4o" value="{{ llm_settings.llm_model|safe }}">
                </div>
                <div class="col-md-12">
                    <label for="llm_api_key" class="form-label">API Key</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                        <input type="password" class="form-control" id="llm_api_key" placeholder="Enter your API Key" value="{{ llm_settings.llm_api_key|safe }}">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-llm-key-visibility">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                {% if show_retries %}
                <div class="col-md-12 mt-3">
                    <label for="max_retries" class="form-label">Max Retries</label>
                    <input type="number" class="form-control" id="max_retries" value="{{ llm_settings.max_retries }}">
                </div>
                {% endif %}
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                // toggle visibility
                const llmApiKey = document.getElementById('llm_api_key');
                const toggleLlmKeyBtn = document.getElementById('toggle-llm-key-visibility');

                if (toggleLlmKeyBtn) {
                    toggleLlmKeyBtn.addEventListener('click', function() {
                        const type = llmApiKey.getAttribute('type') === 'password' ? 'text' : 'password';
                        llmApiKey.setAttribute('type', type);
                        this.querySelector('i').classList.toggle('bi-eye');
                        this.querySelector('i').classList.toggle('bi-eye-slash');
                    });
                }

                // Shared LLM Configuration Logic
                function getElementValue(id) {
                    const el = document.getElementById(id);
                    return el ? el.value : null;
                }
                
                function setElementValue(id, value) {
                    const el = document.getElementById(id);
                    if (el) el.value = value || '';
                }

                function saveLlmSettings() {
                    if (!window.benchmarkUrls || !window.benchmarkUrls.saveLlmSettings) {
                        console.error("Benchmark URLs not initialized");
                        return;
                    }
                    const maxRetries = getElementValue('max_retries');
                    const data = {
                        llm_base_url: getElementValue('llm_base_url'),
                        llm_api_key: getElementValue('llm_api_key'),
                        llm_model: getElementValue('llm_model'),
                    };
                    if (maxRetries !== null) {
                        data.max_retries = maxRetries;
                    }

                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    BenchmarkUtils.saveSettings(window.benchmarkUrls.saveLlmSettings, csrfToken, data, 'save-llm-settings-btn');
                }

                function restoreLlmDefaults() {
                    if (!window.benchmarkUrls || !window.benchmarkUrls.getLlmEnvVars) return;
                    BenchmarkUtils.restoreDefaults(window.benchmarkUrls.getLlmEnvVars, function(data) {
                        setElementValue('llm_base_url', data.llm_base_url);
                        setElementValue('llm_api_key', data.llm_api_key);
                        setElementValue('llm_model', data.llm_model);
                        saveLlmSettings();
                    });
                }

                function testLlmConnection() {
                    if (!window.benchmarkUrls || !window.benchmarkUrls.testLlmConnection) return;
                    const data = {
                        llm_base_url: getElementValue('llm_base_url'),
                        llm_api_key: getElementValue('llm_api_key'),
                    };
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    BenchmarkUtils.testConnection(window.benchmarkUrls.testLlmConnection, csrfToken, data, 'test-connection-result', 'test-connection-btn');
                }

                // Attach Event Listeners
                const saveBtn = document.getElementById('save-llm-settings-btn');
                if (saveBtn) saveBtn.addEventListener('click', saveLlmSettings);
                
                const restoreBtn = document.getElementById('restore-defaults-btn');
                if (restoreBtn) restoreBtn.addEventListener('click', restoreLlmDefaults);
                
                const testBtn = document.getElementById('test-connection-btn');
                if (testBtn) testBtn.addEventListener('click', testLlmConnection);

                // Autosave
                if (typeof BenchmarkUtils !== 'undefined' && BenchmarkUtils.debounce) {
                    const autosaveLlmSettings = BenchmarkUtils.debounce(saveLlmSettings, 1000);
                    ['llm_base_url', 'llm_model', 'llm_api_key', 'max_retries'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.addEventListener('input', autosaveLlmSettings);
                        }
                    });
                }
            });
            </script>
            </div>
            <hr>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-primary me-2" id="save-llm-settings-btn"><i class="bi bi-save me-1"></i> Save</button>
                <button type="button" class="btn btn-outline-info me-2" id="test-connection-btn"><i class="bi bi-person-check me-1"></i> Test Connection</button>
                <button type="button" class="btn btn-outline-secondary" id="restore-defaults-btn"><i class="bi bi-server me-1"></i> Load .env</button>
            </div>
            <div id="test-connection-result" class="mt-3"></div>
        </div>
    </div>
</div>
