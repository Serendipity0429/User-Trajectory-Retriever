{% extends "base.html" %}

{% block title %}Multi-Turn LLM Benchmark{% endblock %}

{% block content %}
<div class="container-fluid mt-5 px-lg-4">
    <div class="pb-3 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-person-check me-2"></i>Multi-Turn LLM Benchmark</h1>
        <p class="text-muted mb-0">Evaluate model performance over multiple turns with corrective feedback.</p>
    </div>

    <div class="row">
        <!-- Left Sidebar: Sessions & Questions -->
        <div class="col-lg-4">
            <!-- LLM Configuration -->
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseConfig" style="cursor: pointer;">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>LLM Configuration</h5>
                </div>
                <div id="collapseConfig" class="collapse">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="llm_base_url" class="form-label">Base URL</label>
                            <input type="text" class="form-control" id="llm_base_url" value="{{ llm_settings.llm_base_url|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="llm_model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="llm_model" value="{{ llm_settings.llm_model|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="llm_api_key" class="form-label">API Key</label>
                            <input type="text" class="form-control" id="llm_api_key" value="{{ llm_settings.llm_api_key|safe }}">
                        </div>
                        <div class="mb-3">
                            <label for="max_retries" class="form-label">Max Retries</label>
                            <input type="number" class="form-control" id="max_retries" value="{{ llm_settings.max_retries }}">
                        </div>
                        <hr>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-primary me-2" id="save-settings-btn"><i class="bi bi-save me-1"></i> Save</button>
                            <button type="button" class="btn btn-outline-info me-2" id="test-connection-btn"><i class="bi bi-person-check me-1"></i> Test Connection</button>
                            <button type="button" class="btn btn-outline-secondary" id="restore-defaults-btn"><i class="bi bi-server me-1"></i> Load .env</button>
                        </div>
                        <div id="test-connection-result" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- QA Pipeline -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>QA Pipeline</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Run all questions through the LLM and get aggregate results.</p>
                    <div class="d-grid gap-2">
                        <button id="run-pipeline-btn" class="btn btn-success">Run QA Pipeline</button>
                        <button id="stop-pipeline-btn" class="btn btn-danger" style="display: none;">Stop Pipeline</button>
                    </div>
                    <div id="pipeline-progress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div id="pipeline-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div id="pipeline-status" class="mt-2 text-muted small"></div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statistics-container" class="my-4" style="display: none;">
                <h4 id="results-header-text">Pipeline Results</h4>
                <!-- Summary Stats -->
                <div class="row my-4" id="summary-container">
                    <div class="col-lg-4 mb-4 mb-lg-0">
                        <div class="card text-center text-white bg-primary summary-card h-100">
                            <div class="card-body">
                                <h5 class="card-title" id="stats-accuracy">0.00%</h5>
                                <p class="card-text text-white small">Overall Accuracy</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4 mb-lg-0">
                        <div class="card text-center text-dark bg-light summary-card h-100">
                            <div class="card-body">
                                <h5 class="card-title" id="stats-avg-trials">0.00</h5>
                                <p class="card-text text-muted small">Avg. Trials</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card text-center text-dark bg-light summary-card h-100">
                            <div class="card-body">
                                <h5 class="card-title" id="stats-total-questions">0</h5>
                                <p class="card-text text-muted small">Total Questions</p>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="card shadow-sm">
                    <div class="card-body p-3">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light text-uppercase small fw-bold text-muted">
                                    <tr>
                                        <th class="px-4 py-3" style="width: 5%;">#</th>
                                        <th class="px-4 py-3" style="width: 70%;">Question</th>
                                        <th class="px-4 py-3 text-center" style="width: 15%;">Result</th>
                                        <th class="px-4 py-3 text-center" style="width: 10%;">Trials</th>
                                    </tr>
                                </thead>
                                <tbody id="stats-details-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Session -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Start New Session</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="question-select" class="form-label">Select a question:</label>
                        <select id="question-select" class="form-select">
                            <option value="" selected disabled>Choose a question...</option>
                            {% for q in questions %}
                            <option value="{{ forloop.counter0 }}">{{ q.question }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="start-session-btn" class="btn btn-primary w-100">Start</button>
                </div>
            </div>
            
            <!-- Saved Sessions -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-archive me-2"></i>Benchmark Sessions</h5>
                    <button id="delete-selected-btn" class="btn btn-sm btn-danger" style="display: none;"><i class="bi bi-trash me-1"></i>Delete Selected</button>
                </div>
                <div id="session-list" class="list-group list-group-flush">
                    {% if groups or individual_sessions %}
                    <div class="list-group-item bg-light" id="select-all-container">
                        <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                        <label class="form-check-label ms-2" for="select-all-checkbox">Select All</label>
                    </div>
                    {% endif %}

                    {% for group in groups %}
                    <div class="list-group-item">
                        <details open>
                            <summary class="fw-bold" style="cursor: pointer;">
                                <i class="bi bi-collection me-1"></i>
                                {{ group.name }}
                                <small class="text-muted">({{ group.sessions.count }} sessions)</small>
                            </summary>
                            <div class="list-group list-group-flush mt-2">
                                {% for session in group.sessions.all %}
                                <div class="list-group-item d-flex align-items-center session-item-container ps-4">
                                    <input class="form-check-input session-checkbox" type="checkbox" value="{{ session.id }}" data-session-id="{{ session.id }}">
                                    <div class="ms-3 flex-grow-1 session-details" data-session-id="{{ session.id }}" style="cursor: pointer;">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">Session #{{ session.id }}</h6>
                                            <small class="text-muted">{{ session.created_at|date:"Y-m-d H:i" }}</small>
                                        </div>
                                        <p class="mb-1 small text-muted">{{ session.question|truncatechars:80 }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </details>
                    </div>
                    {% endfor %}

                    {% for session in individual_sessions %}
                    <div class="list-group-item d-flex align-items-center session-item-container">
                        <input class="form-check-input session-checkbox" type="checkbox" value="{{ session.id }}" data-session-id="{{ session.id }}">
                        <div class="ms-3 flex-grow-1 session-details" data-session-id="{{ session.id }}" style="cursor: pointer;">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Session #{{ session.id }}</h6>
                                <small class="text-muted">{{ session.created_at|date:"Y-m-d H:i" }}</small>
                            </div>
                            <p class="mb-1 small text-muted">{{ session.question|truncatechars:100 }}</p>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not groups and not individual_sessions %}
                    <div class="list-group-item no-sessions">No sessions found.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Content: Conversation -->
        <div class="col-lg-8">
            <div id="session-container" class="card shadow-sm" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="session-header" class="mb-0"></h5>
                    <div>
                        <button id="export-session-btn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download me-1"></i> Export</button>
                        <button id="delete-session-btn" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i> Delete</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Question:</h6>
                        <p id="session-question" class="text-muted"></p>
                        <h6>Ground Truths:</h6>
                        <div id="session-ground-truths"></div>
                    </div>
                    <hr>
                    <div id="trials-container"></div>
                </div>
            </div>
            <div id="no-session-selected" class="text-center mt-5">
                <i class="bi bi-chat-left-dots-fill" style="font-size: 3rem; color: #ccc;"></i>
                <p class="text-muted mt-2">Select a question to start a new session or choose a saved session.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = {{ questions|safe }};
    let activeSessionId = null;
    let sessionTrials = [];
    let pipelineController = { aborted: false };

    const startBtn = document.getElementById('start-session-btn');
    const questionSelect = document.getElementById('question-select');
        const sessionList = document.getElementById('session-list');
        const sessionContainer = document.getElementById('session-container');
        const noSessionSelected = document.getElementById('no-session-selected');
    
        // --- Batch Delete ---
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    
        function getSelectAllCheckbox() { return document.getElementById('select-all-checkbox'); }
        function getSessionCheckboxes() { return document.querySelectorAll('.session-checkbox'); }
    
        function toggleDeleteButton() {
            const anyChecked = Array.from(getSessionCheckboxes()).some(cb => cb.checked);
            deleteSelectedBtn.style.display = anyChecked ? 'inline-block' : 'none';
    
            const selectAllCheckbox = getSelectAllCheckbox();
            if (selectAllCheckbox) {
                const allChecked = Array.from(getSessionCheckboxes()).every(cb => cb.checked);
                selectAllCheckbox.checked = anyChecked && allChecked;
            }
        }
    
        function selectAllHandler(e) {
            getSessionCheckboxes().forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            toggleDeleteButton();
        }
    
        if (getSelectAllCheckbox()) {
            getSelectAllCheckbox().addEventListener('change', selectAllHandler);
        }
        
        sessionList.addEventListener('change', function(e) {
            if (e.target.classList.contains('session-checkbox')) {
                toggleDeleteButton();
            }
        });
    
        deleteSelectedBtn.addEventListener('click', function() {
            const selectedIds = Array.from(getSessionCheckboxes())
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.sessionId);
    
            if (selectedIds.length === 0 || !confirm(`Are you sure you want to delete ${selectedIds.length} selected sessions?`)) {
                return;
            }
    
            fetch('/benchmark/api/interactive/batch_delete_sessions/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ session_ids: selectedIds })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    data.deleted_ids.forEach(id => {
                        const el = document.querySelector(`.session-item-container input[data-session-id='${id}']`);
                        if (el) {
                            el.closest('.session-item-container').remove();
                        }
                    });
                    if (selectedIds.includes(String(activeSessionId))) {
                        sessionContainer.style.display = 'none';
                        noSessionSelected.style.display = 'block';
                        activeSessionId = null;
                    }
                    toggleDeleteButton();
                     // Check if any sessions are left
                    if (getSessionCheckboxes().length === 0) {
                        document.getElementById('select-all-container')?.remove();
                        sessionList.innerHTML = '<div class="list-group-item no-sessions">No sessions found.</div>';
                    }
                } else {
                    alert('Error deleting sessions: ' + (data.message || 'Unknown error'));
                }
            });
        });
    
        // --- Session Management ---
        startBtn.addEventListener('click', function() {
            const selectedIndex = questionSelect.value;
            if (!selectedIndex) {
                alert('Please select a question.');
                return;
            }
            const questionData = questions[selectedIndex];
            
            startBtn.disabled = true;
            startBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting...';
    
            fetch("{% url 'benchmark:create_session' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({
                    question: questionData.question,
                    ground_truths: questionData.answer
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    alert('Error starting session: ' + data.error);
                    return;
                }
                addNewSessionToList(data.session_id, questionData);
                loadSession(data.session_id, data.trial_id);
            })
            .finally(() => {
                startBtn.disabled = false;
                startBtn.innerHTML = 'Start';
            });
        });
    
        sessionList.addEventListener('click', function(e) {
            const target = e.target.closest('.session-details');
            if (target) {
                e.preventDefault();
                const sessionId = target.dataset.sessionId;
                loadSession(sessionId);
            }
        });
    function loadSession(sessionId, initialTrialId = null) {
        activeSessionId = sessionId;
        fetch(`/benchmark/api/interactive/get_session/${sessionId}/`)
            .then(res => res.json())
            .then(data => {
                renderSession(data.session, data.trials);
                sessionContainer.style.display = 'block';
                noSessionSelected.style.display = 'none';

                if (initialTrialId) {
                    executeTrial(initialTrialId, sessionId);
                } else {
                    const lastTrial = data.trials[data.trials.length - 1];
                    const session = data.session;
                    if (lastTrial && lastTrial.status === 'completed' && lastTrial.is_correct === false && !session.is_completed) {
                        if (data.trials.length < session.max_retries) {
                            // Automatically retry after a short delay to allow user to see the feedback
                            setTimeout(() => {
                                window.retryTrial(lastTrial.id);
                            }, 1500);
                        }
                    }
                }
            });
    }

    function executeTrial(trialId, sessionId) {
        fetch(`/benchmark/api/interactive/run_trial/${trialId}/`)
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    alert(`Error in trial #${trialId}: ${data.error}`);
                }
                // Reload the session to get the updated trial data
                if (sessionId) {
                    loadSession(sessionId);
                }
            })
            .catch(err => {
                alert(`A network error occurred while running trial #${trialId}.`);
                if (sessionId) {
                    loadSession(sessionId);
                }
            });
    }

    // --- Rendering ---
    function renderSession(session, trials) {
        sessionTrials = trials;
        document.getElementById('session-header').textContent = `Session #${session.id}`;
        document.getElementById('session-question').textContent = session.question;

        const gtContainer = document.getElementById('session-ground-truths');
        gtContainer.innerHTML = '';
        session.ground_truths.forEach(gt => {
            const el = document.createElement('span');
            el.className = 'badge bg-secondary me-1';
            el.textContent = gt;
            gtContainer.appendChild(el);
        });

        const trialsContainer = document.getElementById('trials-container');
        trialsContainer.innerHTML = '';
        trials.forEach(trial => {
            trialsContainer.appendChild(renderTrial(trial, session.is_completed, trials.length, session.max_retries));
        });
    }

    function renderTrial(trial, isCompleted, trialCount, maxRetries) {
        const trialDiv = document.createElement('div');
        trialDiv.className = 'mb-4';
        trialDiv.id = `trial-${trial.id}`;

        let trialBody = '';
        if (trial.status === 'processing') {
            trialBody = `<div class="d-flex align-items-center">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Processing...</span>
                         </div>`;
        } else if (trial.status === 'error') {
            trialBody = `<div class="alert alert-danger">An error occurred while running this trial.</div>`;
        } else { // completed
            let feedbackControls = '';
            if (!isCompleted && trialCount < maxRetries) {
                if (trial.is_correct === false) {
                    feedbackControls = `<div class="d-flex align-items-center mt-3 text-warning">
                                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            <span>Answer was incorrect. Automatically retrying...</span>
                                         </div>`;
                } else if (trial.is_correct === null) {
                    feedbackControls = `<p class="mt-2 text-muted">Awaiting automated judgment...</p>`;
                }
            }

            trialBody = `<blockquote class="blockquote">
                            <p class="mb-0">“${trial.answer}”</p>
                         </blockquote>`;
            if (trial.feedback) {
                const isCorrect = trial.is_correct;
                const alertClass = isCorrect ? 'alert-success' : 'alert-danger';
                const icon = isCorrect ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-x-circle-fill me-2"></i>';
                trialBody += `<div class="alert ${alertClass} d-flex align-items-center mt-3" role="alert">
                                ${icon}
                                <div>
                                    <strong>Judge's Verdict:</strong> ${trial.feedback}
                                </div>
                              </div>`;
            }
            trialBody += feedbackControls;
        }

        const isLastAttempt = trialCount >= maxRetries;
        let statusBadge = '';
        if (isCompleted || isLastAttempt || trial.is_correct === true) {
            if (trial.is_correct) {
                statusBadge = '<span class="badge bg-success">Final Answer: Correct</span>';
            } else if (trial.is_correct === false) {
                 statusBadge = '<span class="badge bg-danger">Final Answer: Incorrect</span>';
            }
        }

        trialDiv.innerHTML = `
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0 d-flex"><div class="me-2">Trial #${trial.trial_number}</div><div>${statusBadge}</div></h6>
                </div>
                <div class="card-body">
                    ${trialBody}
                </div>
            </div>`;
        return trialDiv;
    }

    // --- Actions ---
    window.retryTrial = function(trialId) {
        const trial = sessionTrials.find(t => t.id === trialId);
        const feedback = trial ? trial.feedback : "";

        fetch(`/benchmark/api/interactive/retry_session/${trialId}/`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ feedback: feedback, is_correct: false })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }

            // Reload session to show the new trial in 'processing' state
            loadSession(activeSessionId);

            if (data.status === 'retrying') {
                executeTrial(data.new_trial_id, activeSessionId);
            }
        });
    }

    document.getElementById('delete-session-btn').addEventListener('click', function() {
        if (!activeSessionId || !confirm('Are you sure you want to delete this session?')) return;

        fetch(`/benchmark/api/interactive/delete_session/${activeSessionId}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                document.querySelector(`#session-list [data-session-id='${activeSessionId}']`).remove();
                sessionContainer.style.display = 'none';
                noSessionSelected.style.display = 'block';
                activeSessionId = null;
            } else {
                alert('Error deleting session: ' + data.message);
            }
        });
    });

    document.getElementById('export-session-btn').addEventListener('click', function() {
        if (!activeSessionId) return;
        window.location.href = `/benchmark/api/interactive/export_session/${activeSessionId}/`;
    });

    function testConnection() {
        const resultDiv = document.getElementById('test-connection-result');
        const btn = document.getElementById('test-connection-btn');
        const originalText = btn.innerHTML;
        
        resultDiv.innerHTML = '';
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';

        const data = {
            llm_base_url: document.getElementById('llm_base_url').value,
            llm_api_key: document.getElementById('llm_api_key').value,
        };
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        fetch("{% url 'benchmark:test_llm_connection' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(({status, body}) => {
            if (status === 200) {
                resultDiv.innerHTML = `<div class="alert alert-success" role="alert">${body.message}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger" role="alert">${body.message}</div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger" role="alert">A network error occurred.</div>`;
            console.error('Error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }

    function saveSettings() {
        const data = {
            llm_base_url: document.getElementById('llm_base_url').value,
            llm_api_key: document.getElementById('llm_api_key').value,
            llm_model: document.getElementById('llm_model').value,
            max_retries: document.getElementById('max_retries').value
        };
        fetch("{% url 'benchmark:save_llm_settings' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok') {
                const btn = document.getElementById('save-settings-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Saved!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-primary');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 1500);
            } else {
                alert('Error saving settings: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An network error occurred while saving settings.');
        });
    }

    function restoreDefaults() {
        fetch("{% url 'benchmark:get_llm_env_vars' %}")
            .then(response => response.json())
            .then(data => {
                if(data.error) {
                    alert('Error loading .env variables: ' + data.error);
                } else {
                    document.getElementById('llm_base_url').value = data.llm_base_url;
                    document.getElementById('llm_api_key').value = data.llm_api_key;
                    document.getElementById('llm_model').value = data.llm_model;
                    saveSettings(); // Automatically save the loaded settings
                }
            });
    }

    document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
    document.getElementById('test-connection-btn').addEventListener('click', testConnection);
    document.getElementById('restore-defaults-btn').addEventListener('click', restoreDefaults);


    // --- QA Pipeline ---
    document.getElementById('run-pipeline-btn').addEventListener('click', runQAPipeline);
    document.getElementById('stop-pipeline-btn').addEventListener('click', () => {
        if (pipelineController) {
            pipelineController.aborted = true;
        }
    });

    function addNewSessionToList(sessionId, questionData, groupId = null, groupName = null) {
        // If this is the first session ever, remove "no sessions" and add select-all header
        if (document.querySelector('.no-sessions')) {
            document.querySelector('.no-sessions').remove();
            const selectAllContainer = document.createElement('div');
            selectAllContainer.className = 'list-group-item bg-light';
            selectAllContainer.id = 'select-all-container';
            selectAllContainer.innerHTML = `
                <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                <label class="form-check-label ms-2" for="select-all-checkbox">Select All</label>`;
            sessionList.prepend(selectAllContainer);
            getSelectAllCheckbox().addEventListener('change', selectAllHandler);
        }

        const newSessionItem = document.createElement('div');
        newSessionItem.className = 'list-group-item d-flex align-items-center session-item-container';
        newSessionItem.innerHTML = `
            <input class="form-check-input session-checkbox" type="checkbox" value="${sessionId}" data-session-id="${sessionId}">
            <div class="ms-3 flex-grow-1 session-details" data-session-id="${sessionId}" style="cursor: pointer;">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">Session #${sessionId}</h6>
                    <small class="text-muted">Now</small>
                </div>
                <p class="mb-1 small text-muted">${questionData.question.substring(0, 100)}...</p>
            </div>`;
        
        if (groupId) {
            let groupContainer = document.getElementById(`session-group-${groupId}`);
            if (!groupContainer) {
                // Create the group container if it doesn't exist
                const groupEl = document.createElement('div');
                groupEl.className = 'list-group-item';
                groupEl.innerHTML = `
                    <details open>
                        <summary class="fw-bold" style="cursor: pointer;">
                            <i class="bi bi-collection me-1"></i>
                            ${groupName}
                            <small class="text-muted" id="group-session-count-${groupId}">(1 sessions)</small>
                        </summary>
                        <div class="list-group list-group-flush mt-2" id="session-group-${groupId}">
                        </div>
                    </details>
                `;
                const selectAllDiv = document.getElementById('select-all-container');
                selectAllDiv.after(groupEl);
                groupContainer = document.getElementById(`session-group-${groupId}`);
            }
            newSessionItem.classList.add("ps-4");
            groupContainer.prepend(newSessionItem);
            
            // Update session count
            const countEl = document.getElementById(`group-session-count-${groupId}`);
            const currentCount = groupContainer.children.length;
            countEl.textContent = `(${currentCount} sessions)`;

        } else {
            const selectAllDiv = document.getElementById('select-all-container');
            selectAllDiv.after(newSessionItem);
        }
    }

    async function processQuestion(questionData, groupId = null) {
        const createResponse = await fetch("{% url 'benchmark:create_session' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({
                question: questionData.question,
                ground_truths: questionData.answer,
                group_id: groupId
            })
        });
        const createData = await createResponse.json();
        if (createData.error) {
            throw new Error(createData.error);
        }
        const { session_id, trial_id } = createData;

        // Load the session UI to show it's processing, then kick off the trial
        loadSession(session_id, trial_id);

        return new Promise((resolve, reject) => {
            const poll = setInterval(async () => {
                if (pipelineController.aborted) {
                    clearInterval(poll);
                    return reject(new Error("Pipeline aborted by user."));
                }
                try {
                    const sessionResponse = await fetch(`/benchmark/api/interactive/get_session/${session_id}/`);
                    if (!sessionResponse.ok) {
                        // Stop polling if the session can't be fetched
                        clearInterval(poll);
                        return reject(new Error(`HTTP error! status: ${sessionResponse.status}`));
                    }
                    const sessionData = await sessionResponse.json();
                    
                    if (sessionData.session.is_completed) {
                        clearInterval(poll);
                        const lastTrial = sessionData.trials[sessionData.trials.length - 1];
                        resolve({
                            question: sessionData.session.question,
                            correct: lastTrial.is_correct,
                            trials: sessionData.trials.length,
                            session_id: session_id
                        });
                    }
                } catch (error) {
                    clearInterval(poll);
                    console.error(`Polling failed for session ${session_id}:`, error);
                    reject(error);
                }
            }, 3000); 
        });
    }
    
    function displayStats(results, groupName) {
        const totalQuestions = results.length;
        if (totalQuestions === 0) return;

        document.getElementById("results-header-text").textContent = `Results for ${groupName}`;

        const correctCount = results.filter(r => r.correct === true).length;
        const totalTrials = results.reduce((sum, r) => sum + (r.trials || 0), 0);
        const accuracy = (correctCount / totalQuestions) * 100;
        const avgTrials = totalTrials > 0 ? totalTrials / totalQuestions : 0;

        document.getElementById('stats-accuracy').textContent = `${accuracy.toFixed(2)}%`;
        document.getElementById('stats-avg-trials').textContent = avgTrials.toFixed(2);
        document.getElementById('stats-total-questions').textContent = totalQuestions;

        const tbody = document.getElementById('stats-details-tbody');
        tbody.innerHTML = '';
        results.forEach((result, index) => {
            const row = document.createElement('tr');
            row.style.cursor = "pointer";
            row.onclick = () => {
                // To avoid interrupting the user, we scroll to the session container if it's out of view.
                const sessionContainer = document.getElementById('session-container');
                sessionContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                loadSession(result.session_id);
            };

            let resultBadge = '';
            if (result.correct === true) {
                resultBadge = '<span class="badge bg-success">Correct</span>';
            } else if (result.correct === false) {
                resultBadge = '<span class="badge bg-danger">Incorrect</span>';
            } else {
                resultBadge = '<span class="badge bg-warning text-dark">Error</span>';
            }
            row.innerHTML = `
                <td class="px-4 fw-bold text-muted small">${index + 1}</td>
                <td class="px-4">${result.question}</td>
                <td class="px-4 text-center">${resultBadge}</td>
                <td class="px-4 text-center">${result.trials}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('statistics-container').style.display = 'block';
        // Scroll to the results
        document.getElementById('statistics-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function runQAPipeline() {
        const runBtn = document.getElementById('run-pipeline-btn');
        const stopBtn = document.getElementById('stop-pipeline-btn');

        runBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        pipelineController.aborted = false;

        document.getElementById('statistics-container').style.display = 'none';
        document.getElementById('pipeline-progress').style.display = 'block';

        const results = [];
        let completedCount = 0;
        
        const progressBar = document.getElementById('pipeline-progress-bar');
        const statusDiv = document.getElementById('pipeline-status');

        let groupId = null;
        let groupName = `Pipeline Run ${new Date().toLocaleString()}`;
        try {
            const groupResponse = await fetch("{% url 'benchmark:create_session_group' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ name: groupName })
            });
            const groupData = await groupResponse.json();
            if (groupData.error) throw new Error(groupData.error);
            groupId = groupData.group_id;
            groupName = groupData.group_name;
        } catch (error) {
            alert('Failed to create a session group for the pipeline run.');
            stopBtn.style.display = 'none';
            runBtn.style.display = 'block';
            return;
        }

        for (const questionData of questions) {
            if (pipelineController.aborted) {
                statusDiv.textContent = `Pipeline stopped by user. Processed ${completedCount} questions.`;
                break;
            }

            const progress = Math.round((completedCount / questions.length) * 100);
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            statusDiv.textContent = `Processing question ${completedCount + 1} of ${questions.length}...`;

            try {
                const result = await processQuestion(questionData, groupId);
                results.push(result);
                addNewSessionToList(result.session_id, questionData, groupId, groupName);
            } catch (error) {
                console.error('Failed to process question:', questionData.question, error);
                results.push({ question: questionData.question, correct: 'error', trials: 0, session_id: null });
            } finally {
                completedCount++;
            }
        }
        
        const finalProgress = Math.round((completedCount / questions.length) * 100);
        progressBar.style.width = `${finalProgress}%`;
        progressBar.textContent = `${finalProgress}%`;
        progressBar.setAttribute('aria-valuenow', finalProgress);
        if (!pipelineController.aborted) {
            statusDiv.textContent = `Pipeline finished. Processed ${completedCount} of ${questions.length} questions.`;
        }

        if (results.length > 0) {
            displayStats(results, groupName);
        }
        
        stopBtn.style.display = 'none';
        runBtn.style.display = 'block';
    }
});
</script>

{% endblock %}
