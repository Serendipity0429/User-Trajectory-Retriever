{% extends "base.html" %}
{% load query_extras %}
{% load static %}

{% block title %}Admin Dashboard - User Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
        <h1 class="mt-4">Administrator Dashboard</h1>
        <div class="mt-4 gap-2 d-flex flex-wrap">
            <a href="{% url 'dashboard:manage_extension_versions' %}" class="btn btn-primary"><i class="bi bi-git me-1"></i> Manage Extension Versions</a>
            <a href="{% url 'task_manager:dataset_qa_list' %}" class="btn btn-secondary"><i class="bi bi-question-circle me-1"></i> View Dataset Questions</a>
        </div>
    </div>
    <p>Welcome to the admin dashboard. Here you can manage users and other site settings.</p>

    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#userStatisticsCollapse" role="button" aria-expanded="true" aria-controls="userStatisticsCollapse">
                    <i class="bi bi-person-badge me-2"></i>
                    User Statistics
                </div>
                <div class="collapse show" id="userStatisticsCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-12 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-users fa-2x text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-primary small fw-bold">Total Users</div>
                                        <div class="h4 mb-0 fw-bold">{{ total_users }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-user-shield fa-2x text-success"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-success small fw-bold">Superusers</div>
                                        <div class="h4 mb-0 fw-bold">{{ superusers }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-user-clock fa-2x text-info"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-info small fw-bold">Active / 30D</div>
                                        <div class="h4 mb-0 fw-bold">{{ active_users }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#taskStatisticsCollapse" role="button" aria-expanded="true" aria-controls="taskStatisticsCollapse">
                    <i class="bi bi-card-checklist me-2"></i>
                    Task Statistics
                </div>
                <div class="collapse show" id="taskStatisticsCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-tasks fa-2x text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-primary small fw-bold">Total</div>
                                        <div class="h4 mb-0 fw-bold">{{ total_tasks }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-check-circle fa-2x text-success"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-success small fw-bold">Completed</div>
                                        <div class="h4 mb-0 fw-bold">{{ completed_tasks }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-times-circle fa-2x text-danger"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-danger small fw-bold">Cancelled</div>
                                        <div class="h4 mb-0 fw-bold">{{ cancelled_tasks }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-spinner fa-2x text-warning"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-warning small fw-bold">Active</div>
                                        <div class="h4 mb-0 fw-bold">{{ active_tasks }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#discussionStatisticsCollapse" role="button" aria-expanded="true" aria-controls="discussionStatisticsCollapse">
                    <i class="bi bi-chat-dots me-2"></i>
                    Discussion Statistics
                </div>
                <div class="collapse show" id="discussionStatisticsCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-12 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-bullhorn fa-2x text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-primary small fw-bold">Bulletins</div>
                                        <div class="h4 mb-0 fw-bold">{{ total_bulletins }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-comments fa-2x text-success"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-success small fw-bold">Posts</div>
                                        <div class="h4 mb-0 fw-bold">{{ total_posts }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm">
                                    <div class="me-3">
                                        <i class="fas fa-comment-dots fa-2x text-info"></i>
                                    </div>
                                    <div>
                                        <div class="text-uppercase text-info small fw-bold">Comments</div>
                                        <div class="h4 mb-0 fw-bold">{{ total_comments }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#userDataAnalysisCollapse" role="button" aria-expanded="true" aria-controls="userDataAnalysisCollapse">
                    <i class="bi bi-graph-up me-2"></i>
                    User Data Analysis
                </div>
                <div class="collapse show" id="userDataAnalysisCollapse">
                    <div class="card-body">
                        <div class="analysis-loader d-flex flex-column justify-content-center align-items-center" style="min-height: 400px;">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mt-3 fw-bold">Loading Analysis Data...</h5>
                            <p class="text-muted">Please wait while we fetch the latest statistics.</p>
                        </div>
                        <div class="analysis-content" style="display: none;">
                            <h5 class="text-muted fw-bold mb-3 border-bottom pb-2">Growth Metrics</h5>
                            <div class="row">
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-graph-up me-2 text-primary"></i>
                                            <h6 class="mb-0 fw-bold">New User Signups (Last 30 Days)</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 220px;"><canvas id="userSignupsChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-graph-up-arrow me-2 text-danger"></i>
                                            <h6 class="mb-0 fw-bold">New Task Creations (Last 30 Days)</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 220px;"><canvas id="taskCreationsChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-muted fw-bold my-3 border-bottom pb-2">User Demographics</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Gender Distribution</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="genderDistributionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Occupation Distribution</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="occupationDistributionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Education Distribution</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="educationDistributionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-muted fw-bold my-3 border-bottom pb-2">User Skills & Preferences</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-success"></i>
                                            <h6 class="mb-0 fw-bold">LLM Frequency</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="llmFrequencyChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-success"></i>
                                            <h6 class="mb-0 fw-bold">English Proficiency</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="englishProficiencyChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-success"></i>
                                            <h6 class="mb-0 fw-bold">Web Search Proficiency</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="webSearchProficiencyChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- New Success & Efficiency Analysis Section -->
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#successAnalysisCollapse" role="button" aria-expanded="true" aria-controls="successAnalysisCollapse">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Success & Efficiency Analysis
                </div>
                <div class="collapse show" id="successAnalysisCollapse">
                    <div class="card-body">
                         <div class="analysis-loader d-flex flex-column justify-content-center align-items-center" style="min-height: 200px;">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div class="analysis-content" style="display: none;">
                            <div class="row g-3">
                                <!-- KPI Cards -->
                                <div class="col-md-3">
                                    <div class="card h-100 border-start border-4 border-success shadow-sm">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Success Rate</h6>
                                            <h2 class="mb-0 fw-bold text-success display-6"><span id="successRateVal">--</span>%</h2>
                                            <small class="text-muted">of completed tasks</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card h-100 border-start border-4 border-danger shadow-sm">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Cancel Rate</h6>
                                            <h2 class="mb-0 fw-bold text-danger display-6"><span id="cancelRateVal">--</span>%</h2>
                                            <small class="text-muted">of all tasks</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card h-100 border-start border-4 border-info shadow-sm">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Self-Correction</h6>
                                            <h2 class="mb-0 fw-bold text-info display-6"><span id="selfRecoveryRateVal">--</span>%</h2>
                                            <small class="text-muted">of successful tasks</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card h-100 border-start border-4 border-primary shadow-sm">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">First Try Success</h6>
                                            <h2 class="mb-0 fw-bold text-primary display-6"><span id="firstTrySuccessRateVal">--</span>%</h2>
                                            <small class="text-muted">of successful tasks</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-lg-6 mb-4">
                                     <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart me-2 text-primary"></i>
                                            <h6 class="mb-0 fw-bold">Success Composition</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 250px;"><canvas id="successCompositionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-lg-6 mb-4">
                                    <div class="card bg-light h-100 border-0">
                                        <div class="card-body">
                                            <h6 class="fw-bold text-dark mb-3"><i class="bi bi-info-circle me-2"></i>Metric Definitions</h6>
                                            <ul class="list-unstyled small text-muted">
                                                <li class="mb-2"><strong>Success Rate:</strong> Tasks that were completed and had at least one correct trial.</li>
                                                <li class="mb-2"><strong>Cancel Rate:</strong> Tasks that were explicitly cancelled by the user.</li>
                                                <li class="mb-2"><strong>Self-Correction Rate:</strong> Successful tasks where the user failed on the first attempt but eventually succeeded.</li>
                                                <li class="mb-2"><strong>First Try Success:</strong> Successful tasks where the user got the correct answer on the very first attempt.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation & Behavior Analysis Section -->
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#navBehaviorCollapse" role="button" aria-expanded="true" aria-controls="navBehaviorCollapse">
                    <i class="bi bi-compass me-2"></i>
                    Navigation & Behavior Analysis
                </div>
                <div class="collapse show" id="navBehaviorCollapse">
                    <div class="card-body">
                         <div class="analysis-loader d-flex flex-column justify-content-center align-items-center" style="min-height: 200px;">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div class="analysis-content" style="display: none;">
                            <div class="row g-3 mb-4">
                                <!-- KPI Cards -->
                                <div class="col-md-4">
                                    <div class="card h-100 bg-light border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Avg Trajectory Length</h6>
                                            <h2 class="mb-0 fw-bold text-dark display-6"><span id="avgTrajectoryLengthVal">--</span></h2>
                                            <small class="text-muted">pages visited per task</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 bg-light border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Avg Pre-Task Time</h6>
                                            <h2 class="mb-0 fw-bold text-dark display-6"><span id="avgPreTaskTimeVal">--</span>s</h2>
                                            <small class="text-muted">annotation duration</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100 bg-light border-0">
                                        <div class="card-body text-center">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Avg Post-Task Time</h6>
                                            <h2 class="mb-0 fw-bold text-dark display-6"><span id="avgPostTaskTimeVal">--</span>s</h2>
                                            <small class="text-muted">annotation duration</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                     <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-globe me-2 text-primary"></i>
                                            <h6 class="mb-0 fw-bold">Top 10 Visited Domains</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="w-100" style="height: 300px;"><canvas id="topDomainsChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header" data-bs-toggle="collapse" href="#taskDataAnalysisCollapse" role="button" aria-expanded="true" aria-controls="taskDataAnalysisCollapse">
                    <i class="bi bi-bar-chart-line-fill me-2"></i>
                    Task Data Analysis
                </div>
                <div class="collapse show" id="taskDataAnalysisCollapse">
                    <div class="card-body">
                        <div class="analysis-loader d-flex flex-column justify-content-center align-items-center" style="min-height: 400px;">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mt-3 fw-bold">Loading Analysis Data...</h5>
                            <p class="text-muted">Please wait while we fetch the latest statistics.</p>
                        </div>
                        <div class="analysis-content" style="display: none;">
                            <h5 class="text-muted fw-bold mb-3 border-bottom pb-2">Task Sentiment & Difficulty</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-warning"></i>
                                            <h6 class="mb-0 fw-bold">Task Familiarity</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="taskFamiliarityChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-warning"></i>
                                            <h6 class="mb-0 fw-bold">Pre-Task Difficulty</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="preTaskDifficultyChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-warning"></i>
                                            <h6 class="mb-0 fw-bold">Post-Task Difficulty</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="postTaskDifficultyChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Effort Distribution</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="effortDistributionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-primary"></i>
                                            <h6 class="mb-0 fw-bold">Confidence Distribution</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 220px;"><canvas id="confidenceDistributionChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-muted fw-bold my-3 border-bottom pb-2">Task Outcomes</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-pie-chart-fill me-2 text-success"></i>
                                            <h6 class="mb-0 fw-bold">Trial Correctness</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="trialCorrectnessChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-secondary"></i>
                                            <h6 class="mb-0 fw-bold">Top Cancellation Reasons</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="cancellationReasonsChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-fill me-2 text-secondary"></i>
                                            <h6 class="mb-0 fw-bold">Top Reflection Failure Categories</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="reflectionFailuresChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-muted fw-bold my-3 border-bottom pb-2">User Behavior Analysis</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-lightbulb-fill me-2 text-warning"></i>
                                            <h6 class="mb-0 fw-bold">Aha! Moment Types</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="ahaMomentChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-card-text me-2 text-secondary"></i>
                                            <h6 class="mb-0 fw-bold">Answer Formulation</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="answerFormulationChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-file-earmark-text-fill me-2 text-danger"></i>
                                            <h6 class="mb-0 fw-bold">Evidence Types</h6>
                                        </div>
                                        <div class="card-body d-flex align-items-center justify-content-center p-2">
                                            <div class="w-100" style="height: 200px;"><canvas id="evidenceTypeChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-muted fw-bold my-3 border-bottom pb-2">Time & Trial Analysis</h5>
                            <div class="row">
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-bar-chart-line me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Task Time (Histogram)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div id="taskTimeHistogramChart" style="height: 220px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-box-seam me-2 text-primary"></i>
                                            <h6 class="mb-0 fw-bold">Task Time (Box Plot)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div id="taskTimeBoxPlotChart" style="height: 220px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-clock-history me-2 text-info"></i>
                                            <h6 class="mb-0 fw-bold">Dwell Time (Box Plot)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div id="dwellTimeBoxPlotChart" style="height: 220px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-distribute-vertical me-2 text-success"></i>
                                            <h6 class="mb-0 fw-bold">Trial Time Distribution (Box Plot Series)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div id="trialTimeBoxPlotChart" style="height: 300px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-light d-flex align-items-center">
                                            <i class="bi bi-list-ol me-2 text-warning"></i>
                                            <h6 class="mb-0 fw-bold">Task Trial Count Distribution</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div id="trialCountDistributionChart" style="height: 220px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header" data-bs-toggle="collapse" href="#consentManagementCollapse" role="button" aria-expanded="true" aria-controls="consentManagementCollapse">
            <i class="bi bi-shield-check me-2"></i>
            Informed Consent Management
        </div>
        <div class="collapse show" id="consentManagementCollapse">
            <div class="card-body">
                <p>Update the informed consent form for all users. When a new version is published, all users will be required to re-consent.</p>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{% url 'dashboard:manage_informed_consent' %}" class="btn btn-primary">Update Informed Consent</a>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#viewConsentModal">
                        View Current Form
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="viewConsentModal" tabindex="-1" aria-labelledby="viewConsentModalLabel" aria-hidden="true" data-url="{% url 'dashboard:view_current_consent' %}">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewConsentModalLabel">Current Informed Consent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">Version</h6>
                                    <h3 class="text-primary mb-0 fw-bold" id="consent-version"></h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">Last Updated</h6>
                                    <div class="d-flex align-items-center justify-content-center h-75">
                                        <span class="fw-bold" id="consent-date"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">Signed / Total</h6>
                                    <h3 class="text-success mb-0 fw-bold" id="consent-stats"></h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h6 class="mb-0 fw-bold"><i class="bi bi-file-text me-2"></i>Content Preview</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="consent-content" class="p-4" style="max-height: 60vh; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Export/Import Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" data-bs-toggle="collapse" href="#dataExportImportCollapse" role="button" aria-expanded="true" aria-controls="dataExportImportCollapse">
            <i class="bi bi-database me-2"></i>
            Data Export / Import
        </div>
        <div class="collapse show" id="dataExportImportCollapse">
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="exportImportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-panel" type="button" role="tab" aria-controls="export-panel" aria-selected="true">
                            <i class="bi bi-cloud-download me-1"></i> Export
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-panel" type="button" role="tab" aria-controls="import-panel" aria-selected="false">
                            <i class="bi bi-cloud-upload me-1"></i> Import
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="exportImportTabContent">
                    <!-- Export Panel -->
                    <div class="tab-pane fade show active" id="export-panel" role="tabpanel" aria-labelledby="export-tab">
                        <div class="row">
                            <div class="col-lg-8">
                                <!-- User Selection -->
                                <h6 class="fw-bold mb-3"><i class="bi bi-people me-2"></i>Select Users to Export</h6>
                                <div class="mb-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="export-select-all">Select All</button>
                                        <button type="button" class="btn btn-outline-secondary" id="export-deselect-all">Deselect All</button>
                                    </div>
                                    <span class="ms-3 text-muted" id="export-selected-count">0 users selected</span>
                                </div>
                                <div id="export-user-list-wrapper" class="position-relative">
                                    <div id="export-user-list-overlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center" style="display: none !important; z-index: 10;">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Updating...</span>
                                    </div>
                                    <div id="export-user-list" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading users...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <!-- Dataset Selection -->
                                <h6 class="fw-bold mb-3"><i class="bi bi-folder me-2"></i>Datasets</h6>
                                <div id="export-dataset-list" class="border rounded p-2 mb-3" style="max-height: 120px; overflow-y: auto;">
                                    <div class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span class="ms-2">Loading...</span>
                                    </div>
                                </div>

                                <!-- Export Options -->
                                <h6 class="fw-bold mb-3"><i class="bi bi-gear me-2"></i>Options</h6>
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="export-anonymize" checked>
                                            <label class="form-check-label" for="export-anonymize">
                                                <strong>Anonymize Data</strong>
                                                <br><small class="text-muted">Replace PII with placeholders</small>
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="export-preview" class="mb-3" style="display: none;">
                                            <h6 class="fw-bold text-muted small">Export Preview</h6>
                                            <ul class="list-unstyled small mb-0">
                                                <li><i class="bi bi-person me-1"></i> <span id="preview-participants">-</span> participants</li>
                                                <li><i class="bi bi-card-checklist me-1"></i> <span id="preview-tasks">-</span> tasks</li>
                                                <li><i class="bi bi-arrow-repeat me-1"></i> <span id="preview-trials">-</span> trials</li>
                                                <li><i class="bi bi-globe me-1"></i> <span id="preview-webpages">-</span> webpages</li>
                                            </ul>
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary w-100 mb-2" id="export-preview-btn">
                                            <i class="bi bi-eye me-1"></i> Preview
                                        </button>
                                        <button type="button" class="btn btn-primary w-100" id="export-download-btn" disabled>
                                            <i class="bi bi-download me-1"></i> Download Export
                                        </button>
                                        <div id="export-progress" class="mt-2" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import Panel -->
                    <div class="tab-pane fade" id="import-panel" role="tabpanel" aria-labelledby="import-tab">
                        <div class="row">
                            <div class="col-lg-6">
                                <h6 class="fw-bold mb-3"><i class="bi bi-file-earmark-arrow-up me-2"></i>Upload Data File</h6>
                                <div class="card bg-light border-0 mb-3">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="import-file" class="form-label">Select JSONL file</label>
                                            <input class="form-control" type="file" id="import-file" accept=".jsonl,.json">
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary w-100" id="import-validate-btn" disabled>
                                            <i class="bi bi-check-circle me-1"></i> Validate & Preview
                                        </button>
                                    </div>
                                </div>

                                <div id="import-preview" style="display: none;">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>Warning:</strong> Import will <strong>DELETE</strong> all existing data (except admin accounts) and replace with imported data.
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <div class="card border-danger">
                                                <div class="card-header bg-danger text-white py-1">
                                                    <small class="fw-bold">Will Delete</small>
                                                </div>
                                                <div class="card-body py-2">
                                                    <ul class="list-unstyled small mb-0">
                                                        <li><span id="delete-users">-</span> users</li>
                                                        <li><span id="delete-tasks">-</span> tasks</li>
                                                        <li><span id="delete-webpages">-</span> webpages</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="card border-success">
                                                <div class="card-header bg-success text-white py-1">
                                                    <small class="fw-bold">Will Import</small>
                                                </div>
                                                <div class="card-body py-2">
                                                    <ul class="list-unstyled small mb-0">
                                                        <li><span id="import-participants">-</span> participants</li>
                                                        <li><span id="import-tasks">-</span> tasks</li>
                                                        <li><span id="import-webpages">-</span> webpages</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div id="import-auth" style="display: none;">
                                    <h6 class="fw-bold mb-3"><i class="bi bi-shield-lock me-2"></i>Confirm Import</h6>
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <p class="text-muted small">Enter your admin password to confirm the import operation.</p>
                                            <div class="mb-3">
                                                <label for="import-password" class="form-label">Admin Password</label>
                                                <input type="password" class="form-control" id="import-password" placeholder="Enter password">
                                            </div>
                                            <button type="button" class="btn btn-danger w-100" id="import-execute-btn">
                                                <i class="bi bi-database-fill-up me-1"></i> Execute Import
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div id="import-result" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6 class="fw-bold"><i class="bi bi-check-circle me-2"></i>Import Completed</h6>
                                        <ul class="mb-0 small">
                                            <li><span id="result-participants">-</span> participants imported</li>
                                            <li><span id="result-tasks">-</span> tasks imported</li>
                                            <li><span id="result-trials">-</span> trials imported</li>
                                            <li><span id="result-webpages">-</span> webpages imported</li>
                                        </ul>
                                    </div>
                                </div>

                                <div id="import-error" class="alert alert-danger" style="display: none;">
                                    <i class="bi bi-exclamation-octagon me-2"></i>
                                    <span id="import-error-message"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header" data-bs-toggle="collapse" href="#userManagementCollapse" role="button" aria-expanded="true" aria-controls="userManagementCollapse">
            <i class="bi bi-people-fill me-2"></i>
            User Management
        </div>
        <div class="collapse show" id="userManagementCollapse">
            <div class="card-body">
                <div class="mb-3">
                    <form id="user-filter-form" method="get" action="{% url 'dashboard:index' %}" class="d-flex">
                        <input type="text" name="user_search" class="form-control me-2" placeholder="Search by username, email, or name" value="{{ user_search_query }}">
                        <button type="submit" class="btn btn-primary">Search</button>
                    </form>
                </div>
                <div id="user-table-container">
                    {% include 'dashboard/partials/_user_table.html' %}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header" data-bs-toggle="collapse" href="#taskManagementCollapse" role="button" aria-expanded="true" aria-controls="taskManagementCollapse">
            <i class="bi bi-card-checklist me-2"></i>
            Task Management
        </div>
        <div class="collapse show" id="taskManagementCollapse">
            <div class="card-body">
                <a class="btn btn-light w-100 mb-3 task-filter-toggle" data-bs-toggle="collapse" href="#taskFilterCollapse" role="button" aria-expanded="false" aria-controls="taskFilterCollapse">
                    <i class="bi bi-funnel me-2"></i> Filter Tasks
                </a>
                <div class="collapse" id="taskFilterCollapse">
                    <form id="task-filter-form" method="get" class="card card-body p-2 mb-3">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="task_id" class="form-label mb-1">Task ID</label>
                                <input type="text" name="task_id" id="task_id" class="form-control" value="{{ task_id_filter }}">
                            </div>
                            <div class="col-md-4">
                                <label for="task_user" class="form-label mb-1">User</label>
                                <select name="task_user" id="task_user" class="form-select">
                                    <option value="">All Users</option>
                                    {% for user in all_users %}
                                        <option value="{{ user.id }}" {% if task_user_filter == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="task_status" class="form-label mb-1">Status</label>
                                <select name="task_status" id="task_status" class="form-select">
                                    <option value="">All Statuses</option>
                                    <option value="active" {% if task_status_filter == 'active' %}selected{% endif %}>Active</option>
                                    <option value="completed" {% if task_status_filter == 'completed' %}selected{% endif %}>Completed</option>
                                    <option value="cancelled" {% if task_status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="task_date_start" class="form-label mb-1">Start Date</label>
                                <input type="date" name="task_date_start" id="task_date_start" class="form-control" value="{{ task_date_start_filter }}">
                            </div>
                            <div class="col-md-6">
                                <label for="task_date_end" class="form-label mb-1">End Date</label>
                                <input type="date" name="task_date_end" id="task_date_end" class="form-control" value="{{ task_date_end_filter }}">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-2">
                            <button type="button" class="btn btn-secondary me-2" id="clear-task-filter-btn">Clear</button>
                            <button type="submit" class="btn btn-primary">Filter</button>
                        </div>
                    </form>
                </div>
                <div id="task-table-container">
                    {% include 'dashboard/partials/_task_table.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'js/admin.js' %}" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loaders = document.querySelectorAll('.analysis-loader');
    const contents = document.querySelectorAll('.analysis-content');

    fetch("{% url 'dashboard:admin_statistics_api' %}")
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(statistics => {
            loaders.forEach(loader => loader.remove());
            contents.forEach(content => content.style.display = 'block');
            
            // Dark mode detection for charts - use functions to get current state
            const getIsDarkMode = () => document.documentElement.classList.contains('dark-mode');
            const getTextColor = () => getIsDarkMode() ? '#f6f6f6' : '#666';
            const getGridColor = () => getIsDarkMode() ? '#444' : '#e0e0e0';
            const getMutedTextColor = () => getIsDarkMode() ? '#adb5bd' : '#6c757d';

            // Initial values
            let textColor = getTextColor();
            let gridColor = getGridColor();
            let mutedTextColor = getMutedTextColor();

            // Store chart instances for updating on dark mode toggle
            const chartInstances = [];

            const CHART_COLORS = {
                red: 'rgb(255, 99, 132)',
                orange: 'rgb(255, 159, 64)',
                yellow: 'rgb(255, 205, 86)',
                green: 'rgb(75, 192, 192)',
                blue: 'rgb(54, 162, 235)',
                purple: 'rgb(153, 102, 255)',
                grey: 'rgb(201, 203, 207)'
            };
            const chartColorsArray = Object.values(CHART_COLORS);

            // --- No Data Plugin ---
            const noDataPlugin = {
                id: 'noData',
                afterDraw: (chart) => {
                    const hasData = chart.data.datasets.some(dataset =>
                        dataset.data && dataset.data.length > 0 && dataset.data.some(val => val !== 0 && val !== null && val !== undefined)
                    );

                    if (!hasData) {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;

                        chart.clear();
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '20px "Noto Sans", sans-serif';
                        ctx.fillStyle = mutedTextColor;
                        ctx.fillText('No Data Available', width / 2, height / 2);
                        ctx.restore();
                    }
                }
            };
            Chart.register(noDataPlugin);

            // Ensure numeric data for Dwell Time to prevent categorical plotting
            if (statistics.dwell_time_distribution) {
                statistics.dwell_time_distribution = statistics.dwell_time_distribution.map(Number);
            }

            const renderPlotlyChart = (elementId, data, layout) => {
                if (data && data.length > 0) {
                    Plotly.newPlot(elementId, data, layout);
                    plotlyChartIds.push(elementId);
                } else {
                     const noDataLayout = {
                        xaxis: { showgrid: false, zeroline: false, showticklabels: false },
                        yaxis: { showgrid: false, zeroline: false, showticklabels: false },
                        annotations: [{
                            text: "No Data Available",
                            xref: "paper",
                            yref: "paper",
                            showarrow: false,
                            font: { size: 20, color: mutedTextColor }
                        }],
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        margin: { l: 0, r: 0, b: 0, t: 0 },
                        height: 220
                    };
                    Plotly.newPlot(elementId, [], noDataLayout);
                }
            };

            // --- Enhanced Chart Configurations ---
            const chartJsDefaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { font: { size: 14 }, color: textColor } }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { font: { size: 14 }, color: textColor },
                        title: { display: true, font: { size: 16 }, color: textColor },
                        grid: { color: gridColor }
                    },
                    y: {
                        ticks: { font: { size: 14 }, color: textColor },
                        title: { display: true, font: { size: 16 }, color: textColor },
                        grid: { color: gridColor }
                    }
                }
            };

            const doughnutPieOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { font: { size: 14 }, color: textColor } }
                }
            };

            const plotlyLayout = {
                margin: { l: 80, r: 50, b: 80, t: 50 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: textColor },
                xaxis: {
                    gridcolor: gridColor,
                    title: { font: { size: 18, color: textColor } },
                    tickfont: { size: 14, color: textColor }
                },
                yaxis: {
                    gridcolor: gridColor,
                    title: { font: { size: 18, color: textColor } },
                    tickfont: { size: 14, color: textColor }
                },
                legend: { font: { size: 14, color: textColor } }
            };


            // --- Chart Factories ---
            const ChartFactory = {
                createLine: (id, labels, data, label, color) => {
                    const chart = new Chart(document.getElementById(id), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{ label: label, data: data, borderColor: color, tension: 0.1, fill: false }]
                        },
                        options: chartJsDefaultOptions
                    });
                    chartInstances.push({ chart, type: 'line' });
                },
                createDoughnut: (id, labels, data, colors = chartColorsArray) => {
                    const chart = new Chart(document.getElementById(id), {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{ data: data, backgroundColor: colors }]
                        },
                        options: doughnutPieOptions
                    });
                    chartInstances.push({ chart, type: 'doughnut' });
                },
                createPie: (id, labels, data, colors = chartColorsArray) => {
                    const chart = new Chart(document.getElementById(id), {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{ data: data, backgroundColor: colors }]
                        },
                        options: doughnutPieOptions
                    });
                    chartInstances.push({ chart, type: 'pie' });
                },
                createBar: (id, labels, data, label, color, isHorizontal = false) => {
                    const options = isHorizontal ? {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { font: { size: 14 }, color: textColor } }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { font: { size: 14 }, color: textColor },
                                title: { display: true, font: { size: 16 }, color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: {
                                    font: { size: 14 },
                                    color: textColor,
                                    autoSkip: false
                                },
                                title: { display: true, font: { size: 16 }, color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    } : chartJsDefaultOptions;

                    const chart = new Chart(document.getElementById(id), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{ label: label, data: data, backgroundColor: color }]
                        },
                        options: options
                    });
                    chartInstances.push({ chart, type: 'bar', isHorizontal });
                }
            };

            // Store Plotly chart IDs for updating on dark mode toggle
            const plotlyChartIds = [];

            // Function to update all charts when dark mode changes
            const updateChartsForDarkMode = () => {
                textColor = getTextColor();
                gridColor = getGridColor();
                mutedTextColor = getMutedTextColor();

                // Update Chart.js instances
                chartInstances.forEach(({ chart, type, isHorizontal }) => {
                    // Update legend color
                    if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }

                    // Update scales for non-pie/doughnut charts
                    if (type !== 'doughnut' && type !== 'pie') {
                        if (chart.options.scales) {
                            if (chart.options.scales.x) {
                                if (chart.options.scales.x.ticks) chart.options.scales.x.ticks.color = textColor;
                                if (chart.options.scales.x.title) chart.options.scales.x.title.color = textColor;
                                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
                            }
                            if (chart.options.scales.y) {
                                if (chart.options.scales.y.ticks) chart.options.scales.y.ticks.color = textColor;
                                if (chart.options.scales.y.title) chart.options.scales.y.title.color = textColor;
                                if (chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
                            }
                        }
                    }

                    chart.update();
                });

                // Update Plotly charts
                const plotlyUpdate = {
                    'font.color': textColor,
                    'xaxis.gridcolor': gridColor,
                    'yaxis.gridcolor': gridColor,
                    'xaxis.tickfont.color': textColor,
                    'yaxis.tickfont.color': textColor,
                    'xaxis.title.font.color': textColor,
                    'yaxis.title.font.color': textColor,
                    'legend.font.color': textColor
                };
                plotlyChartIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.data) {
                        Plotly.relayout(id, plotlyUpdate);
                    }
                });
            };

            // Listen for dark mode toggle
            const darkModeSwitch = document.getElementById('darkModeSwitch');
            if (darkModeSwitch) {
                darkModeSwitch.addEventListener('change', () => {
                    // Small delay to ensure dark mode class is applied
                    setTimeout(updateChartsForDarkMode, 50);
                });
            }

            const PlotlyFactory = {
                createHistogram: (id, data, xLabel, yLabel, color, options = {}) => {
                    const layout = { 
                        ...plotlyLayout, 
                        xaxis: { ...plotlyLayout.xaxis, title: xLabel }, 
                        yaxis: { ...plotlyLayout.yaxis, title: yLabel },
                        bargap: options.bargap !== undefined ? options.bargap : 0.1
                    };

                    if (options.logScaleX) {
                        layout.xaxis.type = 'log';
                        layout.xaxis.autorange = true;
                    } else {
                        layout.xaxis.type = 'linear';
                    }

                    const trace = (data && data.length > 0) ? [{
                        x: data,
                        type: 'histogram',
                        marker: { color: color },
                        nbinsx: options.nbinsx
                    }] : [];
                    renderPlotlyChart(id, trace, layout);
                },
                createBoxPlot: (id, data, yLabel, name, color) => {
                    const layout = { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, title: yLabel }};
                    const trace = (data && data.length > 0) ? [{
                        y: data,
                        type: 'box',
                        name: name,
                        marker: { color: color }
                    }] : [];
                    renderPlotlyChart(id, trace, layout);
                },
                createBar: (id, labels, data, xLabel, yLabel, color) => {
                    const layout = { ...plotlyLayout, xaxis: { ...plotlyLayout.xaxis, title: xLabel }, yaxis: { ...plotlyLayout.yaxis, title: yLabel }};
                    const trace = (data && data.length > 0) ? [{
                        x: labels,
                        y: data,
                        type: 'bar',
                        marker: { color: color }
                    }] : [];
                    renderPlotlyChart(id, trace, layout);
                }
            };

            // --- Chart.js Instances ---
            ChartFactory.createLine('userSignupsChart', statistics.user_signups.labels, statistics.user_signups.data, 'New Users', CHART_COLORS.blue);
            ChartFactory.createDoughnut('genderDistributionChart', statistics.gender_distribution.labels, statistics.gender_distribution.data);
            ChartFactory.createDoughnut('occupationDistributionChart', statistics.occupation_distribution.labels, statistics.occupation_distribution.data);
            ChartFactory.createDoughnut('educationDistributionChart', statistics.education_distribution.labels, statistics.education_distribution.data);
            
            ChartFactory.createBar('llmFrequencyChart', statistics.llm_frequency_distribution.labels, statistics.llm_frequency_distribution.data, 'LLM Frequency', CHART_COLORS.purple, true);
            ChartFactory.createBar('englishProficiencyChart', statistics.english_proficiency_distribution.labels, statistics.english_proficiency_distribution.data, 'English Proficiency', CHART_COLORS.green, true);
            ChartFactory.createBar('webSearchProficiencyChart', statistics.web_search_proficiency_distribution.labels, statistics.web_search_proficiency_distribution.data, 'Web Search Proficiency', CHART_COLORS.orange, true);
            
            // --- Success & Efficiency Metrics ---
            if (statistics.success_rate !== undefined) {
                document.getElementById('successRateVal').textContent = statistics.success_rate;
                document.getElementById('cancelRateVal').textContent = statistics.cancel_rate;
                document.getElementById('selfRecoveryRateVal').textContent = statistics.self_correction_rate;
                document.getElementById('firstTrySuccessRateVal').textContent = statistics.first_try_success_rate;
                
                // Success Composition Chart
                const successCounts = statistics.success_metrics_counts;
                ChartFactory.createDoughnut(
                    'successCompositionChart', 
                    ['First Try Success', 'Self-Corrected'], 
                    [successCounts.first_try_success, successCounts.self_corrected],
                    [CHART_COLORS.blue, CHART_COLORS.orange]
                );
            }

            // --- Navigation & Behavior Metrics ---
            if (statistics.avg_trajectory_length !== undefined) {
                document.getElementById('avgTrajectoryLengthVal').textContent = statistics.avg_trajectory_length;
                document.getElementById('avgPreTaskTimeVal').textContent = statistics.avg_pre_task_duration;
                document.getElementById('avgPostTaskTimeVal').textContent = statistics.avg_post_task_duration;
                
                ChartFactory.createBar('topDomainsChart', statistics.top_domains.labels, statistics.top_domains.data, 'Visit Count', CHART_COLORS.blue, true);
            }

            ChartFactory.createLine('taskCreationsChart', statistics.task_creations.labels, statistics.task_creations.data, 'New Tasks', CHART_COLORS.red);
            
            ChartFactory.createPie('taskFamiliarityChart', statistics.familiarity_distribution.labels, statistics.familiarity_distribution.data);
            ChartFactory.createPie('preTaskDifficultyChart', statistics.pre_task_difficulty_distribution.labels, statistics.pre_task_difficulty_distribution.data);
            ChartFactory.createPie('postTaskDifficultyChart', statistics.post_task_difficulty_distribution.labels, statistics.post_task_difficulty_distribution.data);
            
            ChartFactory.createBar('cancellationReasonsChart', statistics.cancellation_reasons.labels, statistics.cancellation_reasons.data, 'Count', CHART_COLORS.yellow, true);
            ChartFactory.createBar('reflectionFailuresChart', statistics.reflection_failures.labels, statistics.reflection_failures.data, 'Count', CHART_COLORS.grey, true);
            
            ChartFactory.createPie('effortDistributionChart', statistics.effort_distribution.labels, statistics.effort_distribution.data);
            ChartFactory.createPie('trialCorrectnessChart', statistics.trial_correctness_distribution.labels, statistics.trial_correctness_distribution.data, [CHART_COLORS.green, CHART_COLORS.red, CHART_COLORS.grey]);
            
            ChartFactory.createBar('confidenceDistributionChart', statistics.confidence_distribution.labels, statistics.confidence_distribution.data, 'Confidence', CHART_COLORS.blue, true);
            ChartFactory.createBar('ahaMomentChart', statistics.aha_moment_distribution.labels, statistics.aha_moment_distribution.data, 'Count', CHART_COLORS.yellow, true);
            ChartFactory.createBar('answerFormulationChart', statistics.answer_formulation_method_distribution.labels, statistics.answer_formulation_method_distribution.data, 'Count', CHART_COLORS.purple, true);
            ChartFactory.createPie('evidenceTypeChart', statistics.evidence_type_distribution.labels, statistics.evidence_type_distribution.data);


            // --- Plotly.js Instances ---
            PlotlyFactory.createHistogram('taskTimeHistogramChart', statistics.task_time_distribution, 'Time (seconds)', 'Count', CHART_COLORS.blue);
            PlotlyFactory.createBoxPlot('taskTimeBoxPlotChart', statistics.task_time_distribution, 'Time (seconds)', 'Task Time', CHART_COLORS.purple);
            PlotlyFactory.createBoxPlot('dwellTimeBoxPlotChart', statistics.dwell_time_distribution, 'Time (seconds)', 'Dwell Time', CHART_COLORS.green);
            
            // Trial Time Box Plot Series (Custom Logic)
            const trialTimeBoxPlotLayout = { ...plotlyLayout, yaxis: { ...plotlyLayout.yaxis, title: 'Time (seconds)' }};
            let trialTimeBoxPlotData = [];
            if (statistics.trial_time_distribution_detail && statistics.trial_time_distribution_detail.data.length > 0) {
                trialTimeBoxPlotData = statistics.trial_time_distribution_detail.labels.map((label, i) => ({
                    y: statistics.trial_time_distribution_detail.data[i],
                    type: 'box',
                    name: label
                }));
            }
            renderPlotlyChart('trialTimeBoxPlotChart', trialTimeBoxPlotData, trialTimeBoxPlotLayout);

            PlotlyFactory.createBar('trialCountDistributionChart', statistics.trial_count_distribution.labels, statistics.trial_count_distribution.data, 'Number of Trials', 'Number of Tasks', CHART_COLORS.orange);

        })
        .catch(error => {
            console.error('Error fetching statistics:', error);
            const errorMsg = `
                <div class="text-danger text-center">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">Failed to Load Statistics</h5>
                    <p class="text-muted">Could not fetch analysis data. Please try again later.</p>
                </div>`;
            document.querySelectorAll('.card-body .analysis-loader').forEach(loader => {
                loader.innerHTML = errorMsg;
            });
        });
});
</script>
{% endblock %}