{% extends 'base.html' %}
{% load discussion_extras %}

{% block content %}
<div class="container discussion-page">
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center">
        <h1 class="mt-4">Discussion Forum</h1>
        <button id="refresh-btn" class="btn btn-outline-secondary" onclick="location.reload();">
            Refresh <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <div class="card my-4">
        <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-center">
            <div class="d-flex align-items-center mb-2 mb-lg-0">
                <h5 class="mb-0">Bulletin</h5>
            </div>
            {% if user.is_staff %}
                <a href="{% url 'manage_bulletin' %}" class="btn btn-outline-secondary btn-sm">Manage Announcements</a>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="list-group">
            {% for bulletin in pinned_bulletins %}
                <a href="{% url 'bulletin_detail' bulletin.pk %}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 bulletin-title flex-fill">
                            {% if bulletin.pinned %}<i class="bi bi-pin-angle-fill me-2"></i>{% endif %}
                            <span class="badge {{ bulletin.get_category_display|category_badge_subtle_class }} me-2">
                                <span class="d-none d-md-inline">{{ bulletin.get_category_display }}</span>
                                <span class="d-md-none">{{ bulletin.get_category_display|abbreviate_category }}</span>
                            </span>
                            {{ bulletin.title }}
                        </h5>
                        <small class="text-muted">{{ bulletin.updated_at|short_timesince }} {% if bulletin|was_updated %}(edited){% endif %}
                            {% if user.is_staff and bulletin.expiry_date and bulletin.expiry_date < now %}<span class="text-danger">(Expired)</span>{% endif %}
                        </small>
                    </div>
                </a>
            {% endfor %}
            {% for bulletin in bulletins %}
                <a href="{% url 'bulletin_detail' bulletin.pk %}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 bulletin-title flex-fill">
                            {% if bulletin.pinned %}<i class="bi bi-pin-angle-fill me-2"></i>{% endif %}
                            <span class="badge {{ bulletin.get_category_display|category_badge_subtle_class }} me-2">
                                <span class="d-none d-md-inline">{{ bulletin.get_category_display }}</span>
                                <span class="d-md-none">{{ bulletin.get_category_display|abbreviate_category }}</span>
                            </span>
                            {{ bulletin.title }}
                        </h5>
                        <small class="text-muted">{{ bulletin.updated_at|short_timesince }} {% if bulletin|was_updated %}(edited){% endif %}
                            {% if user.is_staff and bulletin.expiry_date and bulletin.expiry_date < now %}<span class="text-danger">(Expired)</span>{% endif %}
                        </small>
                    </div>
                </a>
            {% endfor %}
            </div>

            {% if not bulletins and not pinned_bulletins %}
                <p>No announcements.</p>
            {% endif %}

            <nav aria-label="Bulletin page navigation">
                <ul class="pagination justify-content-center mt-4">
                    {% if bulletins.has_previous %}
                        <li class="page-item"><a class="page-link" href="?bpage=1">&laquo; First</a></li>
                        <li class="page-item"><a class="page-link" href="?bpage={{ bulletins.previous_page_number }}">Previous</a></li>
                    {% endif %}

                    {% for i in bulletin_page_range %}
                        {% if bulletins.number == i %}
                            <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?bpage={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if bulletins.has_next %}
                        <li class="page-item"><a class="page-link" href="?bpage={{ bulletins.next_page_number }}">Next</a></li>
                        <li class="page-item"><a class="page-link" href="?bpage={{ bulletins.paginator.num_pages }}">Last &raquo;</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>

    <div class="card my-4">
        <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-center">
            <div class="d-flex align-items-center mb-2 mb-lg-0">
                <h5 class="mb-0">Discussions</h5>
            </div>
            <div class="category-filters mt-2 mt-lg-0 d-flex flex-wrap justify-content-center">
                <a href="{% url 'discussion_home' %}" class="btn btn-sm {% if not request.GET.category %}btn-primary{% else %}btn-outline-primary{% endif %} m-1" data-button-class="primary">All</a>
    {% for category in categories %}
        {% with button_class=category.1|category_button_class %}
        <a href="?category={{ category.0 }}" class="btn btn-sm m-1 {% if active_category == category.0|stringformat:"s" %}btn-{{ button_class }}{% else %}btn-outline-{{ button_class }}{% endif %}" data-button-class="{{ button_class }}">
            {{ category.1 }}
        </a>
        {% endwith %}
    {% endfor %}
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex flex-column mb-3">
                <div id="utility-buttons" class="d-flex flex-wrap justify-content-center justify-content-lg-start align-items-center">
                    {% if user.is_staff or not post_limit_reached %}
                        <a href="{% url 'create_post' %}" class="btn btn-primary m-1">Create New Post</a>
                    {% else %}
                        <button class="btn btn-primary m-1" disabled data-bs-toggle="tooltip" title="You have reached your post limit for today.">Create New Post</button>
                    {% endif %}
                    <a href="{% url 'discussion_home' %}" class="btn btn-outline-secondary m-1 {% if not request.GET.show %}active{% endif %}">All Posts</a>
                    <a href="?show=my_posts" class="btn btn-outline-secondary m-1 {% if request.GET.show == 'my_posts' %}active{% endif %}">My Posts</a>
                    <a href="?show=open" class="btn btn-outline-success m-1 {% if request.GET.show == 'open' %}active{% endif %}">Open</a>
                    <a href="?show=closed" class="btn btn-outline-danger m-1 {% if request.GET.show == 'closed' %}active{% endif %}">Closed</a>
                    {% if user.is_staff %}
                        <a href="?show=hidden" class="btn btn-outline-warning m-1 {% if request.GET.show == 'hidden' %}active{% endif %}">Hidden Posts</a>
                        <a href="{% url 'discussion_settings' %}" class="btn btn-outline-secondary m-1"><i class="bi bi-gear-fill"></i></a>
                    {% endif %}
                </div>
                <form action="{% url 'discussion_home' %}" method="get" class="d-flex w-100 mt-3">
                    <div class="input-group">
                        <input type="search" class="form-control" placeholder="Search discussions..." aria-label="Search" name="q" value="{{ request.GET.q | default:'' }}">
                        <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
                    </div>
                </form>
            </div>

            <div id="post-list-container">
                {% include '_post_list.html' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    function fetchPosts(url) {
        $.ajax({
            url: url,
            type: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#post-list-container').html(data);
                window.history.pushState({path:url},'',url);
            }
        });
    }

    $('.category-filters').on('click', 'a', function(e) {
        e.preventDefault();
        
        var $clickedLink = $(this);

        // Reset all buttons to their inactive (outline) state.
        $('.category-filters a').each(function() {
            var $link = $(this);
            var buttonClass = $link.data('button-class');
            if (buttonClass) {
                $link.removeClass('btn-' + buttonClass).addClass('btn-outline-' + buttonClass);
            }
        });

        // Activate the clicked button.
        var clickedButtonClass = $clickedLink.data('button-class');
        if (clickedButtonClass) {
            $clickedLink.removeClass('btn-outline-' + clickedButtonClass).addClass('btn-' + clickedButtonClass);
        }

        var url = $(this).attr('href');
        fetchPosts(url);
    });

    $('#post-list-container').on('click', '.pagination a', function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        fetchPosts(url);
    });
});
</script>
{% endblock %}