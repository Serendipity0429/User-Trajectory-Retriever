{% extends 'base.html' %}

{% block content %}
<div class="container">
    {% if request.user == message.sender %}
        <a href="{% url 'msg_system:sent_message_list' %}" class="btn btn-outline-secondary mt-3 mb-3">&laquo; Back to Sent Messages</a>
    {% else %}
        <a href="{% url 'msg_system:message_list' %}" class="btn btn-outline-secondary mt-3 mb-3">&laquo; Back to Inbox</a>
    {% endif %}

    <h1 class="my-4">{{ message.subject }}</h1>

    {% for msg in conversation_messages %}
    <div class="card mb-3
        {% if msg.sender == request.user %}border-primary{% else %}border-secondary{% endif %}">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2 p-3
            {% if msg.level == 'INFO' %}alert-info
            {% elif msg.level == 'WARNING' %}alert-warning
            {% elif msg.level == 'ERROR' %}alert-danger
            {% endif %}">
            <div>
                <strong>{{ msg.sender.username }}</strong>
                <span class="text-muted"> | {{ msg.timestamp }}</span>
            </div>
            {% if forloop.last and request.user != msg.sender %}
            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'msg_system:reply_message' msg.pk %}" class="btn btn-primary btn-sm">Reply</a>
                <form action="{% url 'msg_system:pin_message' msg.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary btn-sm">
                        {% if recipient_status.is_pinned %}Unpin{% else %}Pin{% endif %}
                    </button>
                </form>
                <form action="{% url 'msg_system:delete_message' msg.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            {{ msg.body|safe }}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}