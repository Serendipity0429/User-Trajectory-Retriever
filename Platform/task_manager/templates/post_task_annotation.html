{% extends 'base.html' %}
{% load task_manager_extras %}
{% load static %}

{% block title %}Post-Task Annotation{% endblock %}

{% block css %}
<link href="{% static 'css/task_manager_overrides.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-4">
                <h2 class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Congratulations!</h2>
                <p class="lead">Your answer is correct. Please review the search process and provide your feedback.</p>
            </div>

            <!-- Trajectories -->
            <div class="accordion mb-4" id="parentTrajectoriesAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingParentTrajectories">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParentTrajectories" aria-expanded="false" aria-controls="collapseParentTrajectories">
                            <i class="bi bi-signpost-split-fill me-2"></i> <strong>View Trajectories</strong>&nbsp;(Click to expand)
                        </button>
                    </h2>
                    <div id="collapseParentTrajectories" class="accordion-collapse collapse" aria-labelledby="headingParentTrajectories" data-bs-parent="#parentTrajectoriesAccordion">
                        <div class="accordion-body">
                            <div class="accordion" id="trajectoriesAccordion">
                                {% for trial in trials %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingTrial{{ trial.num_trial }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrial{{ trial.num_trial }}" aria-expanded="false" aria-controls="collapseTrial{{ trial.num_trial }}">
                                            <i class="bi bi-signpost-split-fill me-2"></i> <strong>Trial {{ trial.num_trial }}</strong>
                                        </button>
                                    </h2>
                                    <div id="collapseTrial{{ trial.num_trial }}" class="accordion-collapse collapse" aria-labelledby="headingTrial{{ trial.num_trial }}" data-bs-parent="#trajectoriesAccordion">
                                        <div class="accordion-body">
                                            {% for webpage in trial.webpages %}
                                            <div class="d-flex flex-column align-items-center mb-5 p-4 border rounded shadow-sm bg-light">
                                                <p class="h5"><a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                                <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}" data-webpage-id="{{ webpage.id }}" style="margin-top: 20px;"></div>
                                            </div>
                                            {% endfor %}
                                            {% if not trial.webpages %}
                                            <p>No trajectories recorded for this trial.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseParentTrajectories" aria-expanded="false" aria-controls="collapseParentTrajectories">
                                    Fold
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Annotation Form -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="mb-0"><i class="bi bi-card-checklist me-2"></i>Task Completion Annotation</h4>
                </div>
                <div class="card-body">
                    <form id="query-form" action="" method="post" enctype='multipart/form-data'>
                        {% csrf_token %}
                        <input type="hidden" name="annotation_id" value="{{ annotation_id }}">
                        <input type="hidden" name="duration" id="duration">
                        <!-- Task Info -->
                        <div class="mb-4 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0"><strong>1. Task Review</strong></h5>
                                <div>
                                    <span class="text-muted me-3 fw-normal"><i class="bi bi-clock-history me-1"></i> Last Trial: {{ last_trial_duration|format_duration }}</span>
                                    <span class="text-muted fw-normal"><i class="bi bi-calendar-check me-1"></i> Total: {{ total_duration|format_duration }}</span>
                                </div>
                            </div>
                            <p><strong>Question:</strong></p>
                            <div class="p-3 bg-light rounded mb-3 loaded-box">
                                <div class="question-text">{{ question }}</div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <p class="mb-0"><strong>Correct Answer(s):</strong></p>
                                <div class="mt-2">
                                    <a href="#" id="show-all-answers" class="btn btn-outline-secondary btn-sm" style="display: none;">Show all...</a>
                                    <a href="#" id="show-fewer-answers" class="btn btn-outline-secondary btn-sm" style="display: none;">Show fewer...</a>
                                </div>
                            </div>
                            <ul id="answer-list" class="list-group mt-2">
                                <li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                                    <span>{{ user_answer }}</span>
                                    <span class="badge bg-success-light">Your Answer</span>
                                </li>
                                {% for item in answer %}
                                    {% if item != user_answer %}
                                    <li class="list-group-item">{{ item }}</li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Overall Difficulty -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>2. Overall Difficulty</strong></h5>
                            <p>How would you rate the actual difficulty of the search process you completed?</p>
                            <div class="btn-group w-100 btn-group-responsive btn-group-responsive btn-group-responsive" role="group" aria-label="Difficulty">
                                {% for key, value in DIFFICULTY_MAP.items %}
                                <input type="radio" class="btn-check" name="difficulty_actual" id="difficulty{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="difficulty{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please rate the overall difficulty.</div>
                        </div>

                        <!-- "Aha!" Moment -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>3. The "Aha!" Moment</strong></h5>
                            <p>What type of information was most critical to solving this task? <strong>Please select only one answer</strong></p>
                            <div class="w-100" role="group" aria-label="Aha! Moment">
                                {% for key, value in AHA_MOMENT_MAP.items %}
                                <div class="d-flex mb-2">
                                    <input type="radio" class="btn-check" name="aha_moment_type" id="aha{{ key }}" value="{{ key }}" autocomplete="off" required>
                                    <label class="btn btn-outline-primary {% if key != 'other' %}w-100{% endif %} text-start" for="aha{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ AHA_MOMENT_EXPLANATION_MAP|get_item:key }}">{{ value }}</label>
                                    {% if key == 'other' %}
                                    <input type="text" name="aha_moment_other" class="form-control ms-2" disabled placeholder="Please specify...">
                                    <div class="invalid-feedback">Please specify your "Other" Aha! moment.</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select your "Aha!" moment.</div>
                        </div>

                        <!-- Unhelpful Paths -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>4. Unhelpful Paths</strong></h5>
                            <p>Which of these roadblocks did you encounter? <small class="text-muted fw-bold">Check all that apply</small></p>
                            <div class="w-100" role="group" aria-label="Unhelpful Paths">
                                {% for key, value in UNHELPFUL_PATHS_MAP.items %}
                                {% if key == 'no_major_roadblocks' %}
                                <div class="d-flex mb-2">
                                    <input type="checkbox" class="btn-check" name="unhelpful_paths" id="unhelpful{{ key }}" value="{{ key }}" autocomplete="off">
                                    <label class="btn btn-outline-primary w-100 text-start" for="unhelpful{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ UNHELPFUL_PATHS_EXPLANATION_MAP|get_item:key }}">{{ value|safe }}</label>
                                </div>
                                <hr>
                                {% endif %}
                                {% endfor %}
                                {% for key, value in UNHELPFUL_PATHS_MAP.items %}
                                {% if key != 'no_major_roadblocks' %}
                                <div class="d-flex mb-2">
                                    <input type="checkbox" class="btn-check" name="unhelpful_paths" id="unhelpful{{ key }}" value="{{ key }}" autocomplete="off">
                                    <label class="btn btn-outline-primary {% if key != 'other' %}w-100{% endif %} text-start" for="unhelpful{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ UNHELPFUL_PATHS_EXPLANATION_MAP|get_item:key }}">{{ value|safe }}</label>
                                    {% if key == 'other' %}
                                    <input type="text" name="unhelpful_paths_other" class="form-control ms-2" disabled placeholder="Please specify...">
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Strategic Shift -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>5. Strategic Shift</strong></h5>
                            <p>How did your successful strategy evolve from your initial plan? <small class="text-muted fw-bold">Check all that apply</small></p>
                            <div class="w-100" role="group" aria-label="Strategic Shift">
                                {% for key, value in STRATEGY_SHIFT_MAP.items %}
                                {% if key == 'no_change' %}
                                <div class="d-flex mb-2">
                                    <input type="checkbox" class="btn-check" name="strategy_shift" id="strategy{{ key }}" value="{{ key }}" autocomplete="off">
                                    <label class="btn btn-outline-primary w-100 text-start" for="strategy{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ STRATEGY_SHIFT_EXPLANATION_MAP|get_item:key }}">{{ value|safe }}</label>
                                </div>
                                <hr>
                                {% endif %}
                                {% endfor %}
                                {% for key, value in STRATEGY_SHIFT_MAP.items %}
                                {% if key != 'no_change' %}
                                <div class="d-flex mb-2">
                                    <input type="checkbox" class="btn-check" name="strategy_shift" id="strategy{{ key }}" value="{{ key }}" autocomplete="off">
                                    <label class="btn btn-outline-primary {% if key != 'other' %}w-100{% endif %} text-start" for="strategy{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ STRATEGY_SHIFT_EXPLANATION_MAP|get_item:key }}">{{ value|safe }}</label>
                                    {% if key == 'other' %}
                                    <input type="text" name="strategy_shift_other" class="form-control ms-2" disabled placeholder="Please specify...">
                                    <div class="invalid-feedback">Please specify your "Other" strategic shift.</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select a strategic shift.</div>
                        </div>

                        <div class="d-grid">
                            <button type="button" id="query-btn" class="btn btn-primary-custom btn-lg btn-submit">Submit Annotation</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% load static %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    $(function () {
        const startTime = new Date().getTime();
        // Answer list toggle
        var answerList = $('#answer-list');
        var listItems = answerList.find('li');
        var showAllButton = $('#show-all-answers');
        var showFewerButton = $('#show-fewer-answers');
        var initialItemCount = 2;

        if (listItems.length > initialItemCount) {
            listItems.slice(initialItemCount).hide();
            showAllButton.show();
        }

        showAllButton.on('click', function(e) {
            e.preventDefault();
            listItems.show();
            $(this).hide();
            showFewerButton.show();
        });

        showFewerButton.on('click', function(e) {
            e.preventDefault();
            listItems.slice(initialItemCount).hide();
            $(this).hide();
            showAllButton.show();
        });

        // Enable/disable "other" text fields
        $('input[name="aha_moment_type"]').change(function() {
            $('input[name="aha_moment_other"]').prop('disabled', $(this).val() !== 'other');
        });
        $('input[name="unhelpful_paths"][value="other"]').change(function() {
            $('input[name="unhelpful_paths_other"]').prop('disabled', !$(this).is(':checked'));
        });
        $('input[name="strategy_shift"]').change(function() {
            $('input[name="strategy_shift_other"]').prop('disabled', $(this).val() !== 'other');
        });

        // Unhelpful paths mutual exclusivity
        const noRoadblocks = $('#unhelpfulno_major_roadblocks');
        const otherRoadblocks = $('input[name="unhelpful_paths"]').not(noRoadblocks);

        noRoadblocks.change(function() {
            if ($(this).is(':checked')) {
                otherRoadblocks.prop('checked', false);
                // Manually trigger change on 'other' to disable text input
                $('input[name="unhelpful_paths"][value="other"]').trigger('change');
            }
        });

        otherRoadblocks.change(function() {
            if ($(this).is(':checked')) {
                noRoadblocks.prop('checked', false);
            }
        });

        // Strategic shift mutual exclusivity
        const noChange = $('#strategyno_change');
        const otherStrategies = $('input[name="strategy_shift"]').not(noChange);

        noChange.change(function() {
            if ($(this).is(':checked')) {
                otherStrategies.prop('checked', false);
                // Manually trigger change on 'other' to disable text input
                $('input[name="strategy_shift"][value="other"]').trigger('change');
            }
        });

        otherStrategies.change(function() {
            if ($(this).is(':checked')) {
                noChange.prop('checked', false);
            }
        });

        // Form submission
        let is_submitted = false;
        $('#query-btn').click(function () {
            // Reset validation states
            $('.is-invalid').removeClass('is-invalid');
            let isValid = true;
            let firstInvalidElement = null;

            // Helper to set focus
            const setFocus = (element) => {
                if (!firstInvalidElement) {
                    firstInvalidElement = element;
                }
            };

            // Validation for overall difficulty
            if (!$('input[name="difficulty_actual"]:checked').val()) {
                const container = $('input[name="difficulty_actual"]').closest('.btn-group');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            }

            // Validation for "Aha!" moment
            const ahaMoment = $('input[name="aha_moment_type"]:checked');
            const ahaMomentOther = $('input[name="aha_moment_other"]');
            if (!ahaMoment.val()) {
                const container = $('input[name="aha_moment_type"]').closest('.w-100');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            } else if (ahaMoment.val() === 'other' && ahaMomentOther.val().trim() === '') {
                ahaMomentOther.addClass('is-invalid');
                setFocus(ahaMomentOther);
                isValid = false;
            }

            // Validation for strategic shift
            const strategyShift = $('input[name="strategy_shift"]:checked');
            const strategyShiftOther = $('input[name="strategy_shift_other"]');
            if (strategyShift.length === 0) {
                const container = $('input[name="strategy_shift"]').closest('.w-100');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            } else {
                let isOtherChecked = false;
                strategyShift.each(function() {
                    if ($(this).val() === 'other') {
                        isOtherChecked = true;
                    }
                });
                if (isOtherChecked && strategyShiftOther.val().trim() === '') {
                    strategyShiftOther.addClass('is-invalid');
                    setFocus(strategyShiftOther);
                    isValid = false;
                }
            }

            if (!isValid) {
                if (firstInvalidElement) {
                    firstInvalidElement.focus();
                }
                return;
            }

            if (confirm("Are you sure you want to submit?")) {
                is_submitted = true;
                const endTime = new Date().getTime();
                const duration = Math.round((endTime - startTime) / 1000);
                $('#duration').val(duration);
                // Disable button and show loading state
                $(this).prop('disabled', true);
                $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
                $('#query-form').submit();
            }
        });

        // Clear validation on input
        $('input[name="difficulty_actual"]').change(() => $('input[name="difficulty_actual"]').closest('.btn-group').removeClass('is-invalid'));
        $('input[name="aha_moment_type"]').change(() => {
            $('input[name="aha_moment_type"]').closest('.w-100').removeClass('is-invalid');
            $('input[name="aha_moment_other"]').removeClass('is-invalid');
        });
        $('input[name="aha_moment_other"]').on('input', () => $('input[name="aha_moment_other"]').removeClass('is-invalid'));
        $('input[name="strategy_shift"]').change(() => {
            $('input[name="strategy_shift"]').closest('.w-100').removeClass('is-invalid');
            $('input[name="strategy_shift_other"]').removeClass('is-invalid');
        });
        $('input[name="strategy_shift_other"]').on('input', () => $('input[name="strategy_shift_other"]').removeClass('is-invalid'));
    });

    var trajectoriesCollapse = document.getElementById('collapseTrajectories');
    if (trajectoriesCollapse) {
        trajectoriesCollapse.addEventListener('shown.bs.collapse', function () {
            window.dispatchEvent(new Event('resize'));
        });
    }
</script>
<script src="{% static 'js/rrweb_player_loader.js' %}"></script>
{% include "_stop_annotation_script.html" %}
{% endblock %}