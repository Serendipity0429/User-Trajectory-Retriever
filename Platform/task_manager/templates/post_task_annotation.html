{% extends 'base.html' %}

{% block title %}Post-Task Annotation{% endblock %}
{% block content_title %}Post-Task Annotation{% endblock %}

{% block content %}
{% load task_manager_extras %}
    <style>
        .choice-container {
            display: flex;
            align-items: center;
            margin-right: 20px; /* Add space between options */
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip-button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            margin-left: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tooltip-text {
            visibility: hidden;
            min-width: 220px;
            max-width: 300px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <div class="row text-center">
        <h2>
            Your answer is
            <span style="color:limegreen">RIGHT!</span>
        </h2>
        <h4>
            Please review the search process and select the appropriate options.
        </h4>
    </div>
    <div class="row">
        <div class="col-xs-offset-1 col-xs-10">
            <details>
                <summary class="col-xs-12 list-header">
                    <b>Trajectories of this task...</b> (Click to expand)
                </summary>
                <div class="col-xs-offset-1 col-xs-10" id="trajectories">
                    {% for webpage in webpages %}
                        <div class="col-xs-12 list-row webpage-wrapper">
                            <p style="font-size: 20px">Webpage {{ forloop.counter }}:&ensp;<a href="{{ webpage.url }}"
                                                                                              target="_blank">{{ webpage.title }}</a>
                            </p>
                            <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}"></div>
                            <script>
                                var rrweb_record_{{ webpage.id }} = {{ webpage.rrweb_record | safe }};
                                const player_{{ webpage.id }} = new rrwebPlayer({
                                    target: document.getElementById(`rrweb-player-{{ webpage.id }}`),
                                    props: {
                                        events: rrweb_record_{{ webpage.id }},
                                        autoPlay: false,
                                        width: 800,
                                        height: 377,
                                    },
                                });
                            </script>
                        </div>
                    {% endfor %}
                </div>
            </details>
        </div>
        <div class="col-xs-offset-1 col-xs-10">
            <div class="col-xs-12 list-header">
                <b>Task Completion Annotation</b>
            </div>
            <form id="query-form" action="" method="post" onsubmit="validateForm()"
                  enctype='multipart/form-data'>
                {% csrf_token %}
                <div class="col-xs-12 sheet">
                    <div class="question-wrapper col-xs-12">
                        <span class="col-xs-12 list-row question-text">
                            <b>1. Task Description</b>: You need to answer the following question:
                            </span>
                        <br/>
                        <div class="static-task-info">{{ question }}</div>
                        <span class="col-xs-12 list-row question-text">
                            &emsp;<b>Whose answer is:</b>
                        </span>
                        <div class="static-task-info" style="font-size: 16px;">
                            <ul id="answer-list" style="padding-left: 20px; margin-top: 5px; list-style-position: inside; column-count: 1; -webkit-column-count: 1; -moz-column-count: 1; margin-bottom: 5px;">
                                {% for item in answer %}
                                    <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                            <a href="#" id="show-all-answers" style="display: none; margin-top: 10px; cursor: pointer;">Click here to see all possible correct answers</a>
                            <a href="#" id="show-fewer-answers" style="display: none; margin-top: 10px; cursor: pointer;">Show fewer answers</a>
                        </div> 
                    </div>

                    <div class="question-wrapper col-xs-12">
                        <span class="col-xs-12 list-row question-text">
                            <b>2. Task Completion Criteria</b>: The criteria for task completion.</span>
                        <br/>
                        <div class="static-task-info">Exact Match (EM)</div>
                    </div>

                    <div class="question-wrapper col-xs-12">
                        <label class="ratio col-xs-12 list-row question-text">
                            <b>3. Overall Difficulty</b>: How would you rate the actual difficulty of the search process you completed?
                        </label>
                        <div class="ratio col-xs-12 user_fill">
                            {% for key, value in DIFFICULTY_MAP.items %}
                                <div class="choice-container">
                                    <label>
                                        <input type="radio" name="difficulty_actual" value="{{ key }}" required/> {{ value }}
                                    </label>
                                    <div class="tooltip-container">
                                        <span class="tooltip-button">?</span>
                                        <span class="tooltip-text">{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="question-wrapper col-xs-12">
                        <label class="col-xs-12 list-row question-text">
                            <b>4. The "Aha!" Moment</b>: What type of information was most critical to solving this task?
                        </label>
                        <div class="ratio col-xs-12 list-row">
                            {% for key, value in AHA_MOMENT_MAP.items %}
                                <div class="choice-container">
                                    <label>
                                        <input type="radio" name="aha_moment_type" value="{{ key }}" required/> {{ value }}
                                    </label>
                                    <div class="tooltip-container">
                                        <span class="tooltip-button">?</span>
                                        <span class="tooltip-text">{{ AHA_MOMENT_EXPLANATION_MAP|get_item:key }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                            <label><input type="text" name="aha_moment_other" style="margin-left: 10px; font-size: normal; width: 100%;" disabled placeholder="Please specify..." /></label>
                            <br>
                        </div>
                        <label for="aha_moment_source" class="col-xs-12 list-row" style="margin-top: 5px;">
                            (Optional) Paste the source URL or search query for this "Aha!" moment.
                        </label>
                        <input type="text" class="col-xs-12 list-row" id="aha_moment_source" name="aha_moment_source" style="margin:0 20px;">
                    </div>


                    <div class="question-wrapper col-xs-12">
                        <label class="col-xs-12 list-row question-text">
                            <b>5. Unhelpful Paths</b>: Which of these roadblocks did you encounter? (Check all that apply)
                        </label>
                        <div class="ratio col-xs-12 list-row">
                            {% for key, value in UNHELPFUL_PATHS_MAP.items %}
                                <div class="choice-container">
                                    <label>
                                        <input type="checkbox" name="unhelpful_paths" value="{{ key }}"/> {{ value }}
                                    </label>
                                    <div class="tooltip-container">
                                        <span class="tooltip-button">?</span>
                                        <span class="tooltip-text">{{ UNHELPFUL_PATHS_EXPLANATION_MAP|get_item:key }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                            <label><input type="text" name="unhelpful_paths_other" style="margin-left: 10px; font-size: normal; width: 100%;" disabled placeholder="Please specify..." /></label><br>
                        </div>
                    </div>

                    <div class="question-wrapper col-xs-12">
                        <label class="col-xs-12 list-row question-text">
                            <b>6. Strategic Shift</b>: How did your successful strategy evolve from your initial plan?
                        </label>
                        <div class="ratio col-xs-12 list-row">
                            {% for key, value in STRATEGY_SHIFT_MAP.items %}
                                <div class="choice-container">
                                    <label>
                                        <input type="radio" name="strategy_shift" value="{{ key }}" required/> {{ value }}
                                    </label>
                                    <div class="tooltip-container">
                                        <span class="tooltip-button">?</span>
                                        <span class="tooltip-text">{{ STRATEGY_SHIFT_EXPLANATION_MAP|get_item:key }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                            <label><input type="text" name="strategy_shift_other" style="margin-left: 10px; font-size: normal; width: 100%;" disabled placeholder="Please specify..." /></label>
                        </div>
                    </div>

                    <div class="question-wrapper col-xs-12">
                        <label for="additional_reflection" class="col-xs-12 list-row question-text">
                            <b>7. (Optional) Additional Reflection</b>: Do you have any additional thoughts or reflections on this task?
                        <textarea class="col-xs-12 list-row" id="reflection" name="additional_reflection" rows="3" required></textarea>
                    </div>

                </div>
            </form>
            <div class="col-xs-12">
                <div id="query-btn" class="col-xs-6 submit-btn btn btn-block btn-lg btn-primary"
                     style="margin-top:10px;">
                    Submit
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block scripts %}
<script>
    function validateForm() {
        let checks = $('input[type="checkbox"]:checked').map(function () {
            return $(this).val();
        }).get();
    }
</script>
<script type="application/x-javascript">
    $(function () {
        var answerList = $('#answer-list');
        var listItems = answerList.find('li');
        var showAllButton = $('#show-all-answers');
        var showFewerButton = $('#show-fewer-answers');
        var initialItemCount = 2;

        if (listItems.length > initialItemCount) {
            listItems.slice(initialItemCount).hide();
            showAllButton.show();
        }

        showAllButton.on('click', function(e) {
            e.preventDefault();
            answerList.find('li:hidden').show();
            $(this).hide();
            showFewerButton.show();
            answerList.css({
                'column-count': 2,
                '-webkit-column-count': 2,
                '-moz-column-count': 2
            });
        });

        showFewerButton.on('click', function(e) {
            e.preventDefault();
            listItems.slice(initialItemCount).hide();
            $(this).hide();
            showAllButton.show();
            answerList.css({
                'column-count': 1,
                '-webkit-column-count': 1,
                '-moz-column-count': 1
            });
        });

        $('input[name="aha_moment_type"]').change(function() {
            if ($(this).val() === 'other' && $(this).is(':checked')) {
                $('input[name="aha_moment_other"]').prop('disabled', false);
            } else {
                $('input[name="aha_moment_other"]').prop('disabled', true).val('');
            }
        });

        $('input[name="unhelpful_paths"]').change(function() {
            var otherChecked = $('input[name="unhelpful_paths"][value="other"]:checked').length > 0;
            if (otherChecked) {
                $('input[name="unhelpful_paths_other"]').prop('disabled', false);
            } else {
                $('input[name="unhelpful_paths_other"]').prop('disabled', true).val('');
            }
        });
        
        $('input[name="unhelpful_paths"]').change(function() {
            if ($(this).val() === 'no_major_roadblocks' && $(this).is(':checked')) {
                $('input[name="unhelpful_paths"]').not(this).prop('checked', false);
                $('input[name="unhelpful_paths_other"]').prop('disabled', true).val('');
            } else if ($(this).val() !== 'no_major_roadblocks' && $(this).is(':checked')) {
                $('input[name="unhelpful_paths"][value="no_major_roadblocks"]').prop('checked', false);
            }
        });

        $('input[name="strategy_shift"]').change(function() {
            if ($(this).val() === 'other' && $(this).is(':checked')) {
                $('input[name="strategy_shift_other"]').prop('disabled', false);
            } else {
                $('input[name="strategy_shift_other"]').prop('disabled', true).val('');
            }
        });

        let is_submitted = false;
        $('#query-btn').click(
            function () {
                let difficulty_actual = $('input[name="difficulty_actual"]:checked');
                let aha_moment_type = $('input[name="aha_moment_type"]:checked');
                let aha_moment_other = $('input[name="aha_moment_other"]');
                let strategy_shift = $('input[name="strategy_shift"]:checked');
                let roadblocks = $('input[name="unhelpful_paths"]:checked');
                
                if(difficulty_actual.val() == null)
                {
                    alert('Please select the actual difficulty of the task!');
                    $('input[name="difficulty_actual"]').focus();
                    return;
                }

                if(aha_moment_type.val() == null)
                {
                    alert('Please select the type of "Aha!" moment!');
                    $('input[name="aha_moment_type"]').focus();
                    return;
                } else {
                    if (aha_moment_type.val() === 'other') {
                        if (aha_moment_other.val() === '') {
                            alert('Please specify the type of "Aha!" moment!');
                            aha_moment_other.focus();
                            return;
                        }
                    } else {
                        aha_moment_other.val('');
                    }
                }
                if(strategy_shift.val() == null)
                {
                    alert('Please select the strategic shift! (You can select "No change" if applicable.)');
                    $('input[name="strategy_shift"]').focus();
                    return;
                }
                if (roadblocks.length === 0) {
                    alert('Please select at least one roadblock you encountered! (You can select "No major roadblocks" if applicable.)');
                    $('input[name="roadblocks"]').focus();
                    return;
                }

                if (confirm("Are you sure to submit all the annotations?")) {
                    is_submitted = true;
                    $('#query-form').submit();
                }
            }
        );
        window.addEventListener('beforeunload', function (e) {
            if (!is_submitted) {
                navigator.sendBeacon('/task/stop_annotation/', new Blob());
            }
        });
    });
</script>
{% endblock %}