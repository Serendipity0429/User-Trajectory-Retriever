{% extends "base.html" %}
{% load task_manager_extras %}
{% block title %} Pre-Task Annotation {% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-custom-dark-blue">
                    <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Pre-Task Annotation</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Please answer the following questions before you begin the task.</p>
                    <hr>
                    <form id="query-form" action="" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="entry_id" id="entry-id" value="{{entry_id}}">

                        <!-- Task Description -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>1. Understand the Task</strong></h5>
                            <p>Your goal is to answer the following question accurately.</p>
                            <div class="p-3 bg-light rounded loaded-box">
                                <div class="question-text">
                                    {{ question }}
                                </div>
                            </div>                        </div>

                        <!-- Task Completion Criteria -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>2. How to Format Your Answer</strong></h5>
                            <p class="text-muted mb-0">
                                Your answer must be an <strong>exact match</strong>. Do not include extra words or sentences. Capitalization will be ignored.
                            </p>
                            <div class="mt-2" style="font-size: 1rem; line-height: 1.4;">
                                <p class="mb-1">For example:</p>
                                <div class="p-2 bg-light rounded">
                                    <p class="mb-1"><strong>Question:</strong></p>
                                    <div class="border rounded bg-white mb-2 py-1 px-2">
                                        What is the capital of France?
                                    </div>

                                    <p class="mb-1"><strong>Correct Answer:</strong></p>
                                    <div class="border rounded bg-white mb-2 py-1 px-2">
                                        Paris
                                    </div>

                                    <p class="mb-1"><strong>Incorrect Answers:</strong></p>
                                    <ul class="list-group">
                                        <li class="list-group-item list-group-item py-1 px-2">"The capital of France is Paris." <span class="text-muted">(contains extra words)</span></li>
                                        <li class="list-group-item py-1 px-2">"Paris is the capital of France." <span class="text-muted">(contains extra words)</span></li>
                                        <li class="list-group-item py-1 px-2">"Paris." <span class="text-muted">(contains a period)</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Familiarity -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>3. Your Familiarity with the Topic</strong></h5>
                            <p>How familiar are you with the subject of this question?</p>
                            <div class="btn-group" role="group" aria-label="Familiarity">
                                {% for key, value in FAMILIARITY_MAP.items %}
                                <input type="radio" class="btn-check" name="familiarity" id="familiarity{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-custom-dark-blue" for="familiarity{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ FAMILIARITY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select your familiarity with the topic.</div>
                        </div>

                        <!-- Difficulty -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>4. Perceived Task Difficulty</strong></h5>
                            <p>How difficult do you think this task will be?</p>
                            <div class="btn-group" role="group" aria-label="Difficulty">
                                {% for key, value in DIFFICULTY_MAP.items %}
                                <input type="radio" class="btn-check" name="difficulty" id="difficulty{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-custom-dark-blue" for="difficulty{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select the perceived task difficulty.</div>
                        </div>

                        <!-- Effort -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>5. Estimated Time Commitment</strong></h5>
                            <p>Estimate the time you'll need for this task. This helps us understand the complexity of the task.</p>
                            <div class="btn-group" role="group" aria-label="Effort">
                                {% for key, value in EFFORT_MAP.items %}
                                <input type="radio" class="btn-check" name="effort" id="effort{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-custom-dark-blue" for="effort{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ EFFORT_EXPLANATION_MAP|get_item:key }}">
                                    {{ value }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select the estimated time commitment.</div>
                        </div>

                        <!-- Initial Strategy -->
                        <div class="mb-4 p-3 border rounded">
                            <label for="first_search_query" class="form-label"><h5><strong>6. Your First Search Query</strong></h5></label>
                            <p>Please enter the first search query you will use to start this task.</p>
                            <input type="text" class="form-control" id="first_search_query" name="first_search_query" required placeholder="e.g., 'capital of France'">
                            <div class="invalid-feedback">Please enter your first search query.</div>
                        </div>

                        <!-- Initial Guess -->
                        <div class="mb-4 p-3 border rounded">
                            <label for="initial_guess" class="form-label"><h5><strong>7. Initial Guess</strong></h5></label>
                            <p>If you have an initial idea of the answer, or a possible range for it, please specify it below.</p>
                            <input type="text" class="form-control" id="initial_guess" name="initial_guess" placeholder="Your initial guess or range">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="initial_guess_unknown" id="initial_guess_unknown">
                                <label class="form-check-label" for="initial_guess_unknown">
                                    I don't know
                                </label>
                            </div>
                            <div class="invalid-feedback">Please provide an initial guess or check "I don't know".</div>
                        </div>

                        <!-- Expected Source of Answer -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>8. Expected Source of Answer</strong></h5>
                            <p>Where do you think you will find the answer? (You can select multiple options)</p>
                            <div class="btn-group flex-wrap" role="group" aria-label="Expected Source">
                                {% for key, value in EXPECTED_SOURCES_MAP.items %}
                                <input type="checkbox" class="btn-check" name="expected_source" id="source_{{ key }}" value="{{ key }}" autocomplete="off">
                                <label class="btn btn-outline-custom-dark-blue mb-2 me-2" for="source_{{ key }}">{{ value }}</label>
                                {% endfor %}
                            </div>
                            <input type="text" class="form-control mt-2" id="expected_source_other" name="expected_source_other" placeholder="If other, please specify" style="display: none;">
                            <div class="invalid-feedback">Please select at least one expected source.</div>
                            <div class="invalid-feedback" id="expected_source_other_feedback">Please specify the other expected source.</div>
                        </div>

                        <!-- Pre-Task Checklist -->
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>9. Pre-Task Checklist</strong></h5>
                            <p class="text-danger">
                                <strong>Important:</strong> Before you begin, please ensure that you have saved any important work in other browser tabs. <strong>The task will close tabs or navigate away from your current pages.</strong>
                            </p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="preTaskCheck" required>
                                <label class="form-check-label" for="preTaskCheck">
                                    I have checked my other tabs and saved any important work.
                                </label>
                                <div class="invalid-feedback">You must confirm this before starting the task.</div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="button" id="query-btn" class="btn btn-custom-dark-blue btn-lg btn-submit" disabled>Start Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    $(function () {
        let is_submitted = false;

        // Initial Guess Logic
        $('#initial_guess_unknown').change(function() {
            if ($(this).is(':checked')) {
                $('#initial_guess').val('').prop('disabled', true);
            } else {
                $('#initial_guess').prop('disabled', false);
            }
        });

        // Show/hide 'other' source text input
        $('#source_other').change(function() {
            if ($(this).is(':checked')) {
                $('#expected_source_other').show();
            } else {
                $('#expected_source_other').hide();
            }
        });

        // Enable/disable submit button based on pre-task check
        $('#preTaskCheck').change(function() {
            if ($(this).is(':checked')) {
                $('#query-btn').prop('disabled', false);
            } else {
                $('#query-btn').prop('disabled', true);
            }
        });

        $('#query-btn').click(function () {
            // Reset validation states
            $('.is-invalid').removeClass('is-invalid');
            let isValid = true;
            let firstInvalidElement = null;

            // Helper to set focus
            const setFocus = (element) => {
                if (!firstInvalidElement) {
                    firstInvalidElement = element;
                }
            };

            // Validation for familiarity
            if (!$("input[name='familiarity']:checked").val()) {
                const container = $("input[name='familiarity']").closest('.btn-group');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            }

            // Validation for difficulty
            if (!$("input[name='difficulty']:checked").val()) {
                const container = $("input[name='difficulty']").closest('.btn-group');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            }

            // Validation for effort
            if (!$("input[name='effort']:checked").val()) {
                const container = $("input[name='effort']").closest('.btn-group');
                container.addClass('is-invalid');
                setFocus(container.find('input').first());
                isValid = false;
            }

            // Validation for first search query
            const firstSearchQuery = $('#first_search_query');
            if (firstSearchQuery.val().trim() === '') {
                firstSearchQuery.addClass('is-invalid');
                setFocus(firstSearchQuery);
                isValid = false;
            }

            // Validation for initial guess
            const initialGuess = $('#initial_guess');
            const initialGuessUnknown = $('#initial_guess_unknown');
            if (!initialGuessUnknown.is(':checked') && initialGuess.val().trim() === '') {
                initialGuess.addClass('is-invalid');
                setFocus(initialGuess);
                isValid = false;
            }

            // Validation for expected source
            const expectedSourceCheckboxes = $("input[name='expected_source']:checked");
            const expectedSourceContainer = $("input[name='expected_source']").closest('.btn-group');
            const expectedSourceOther = $('#expected_source_other');
            const otherIsChecked = $('#source_other').is(':checked');
            const genericFeedback = expectedSourceContainer.nextAll('.invalid-feedback').first();
            const otherFeedback = $('#expected_source_other_feedback');

            if (expectedSourceCheckboxes.length === 0) {
                expectedSourceContainer.addClass('is-invalid');
                genericFeedback.css('display', 'block');
                otherFeedback.css('display', 'none');
                setFocus(expectedSourceContainer.find('input').first());
                isValid = false;
            } else if (otherIsChecked && expectedSourceOther.val().trim() === '') {
                expectedSourceOther.addClass('is-invalid');
                genericFeedback.css('display', 'none');
                otherFeedback.css('display', 'block');
                setFocus(expectedSourceOther);
                isValid = false;
            }

            // Validation for pre-task check
            if (!$('#preTaskCheck').is(':checked')) {
                $('#preTaskCheck').addClass('is-invalid');
                setFocus($('#preTaskCheck'));
                isValid = false;
            }


            if (!isValid) {
                if (firstInvalidElement) {
                    firstInvalidElement.focus();
                }
                return;
            }

            if (confirm("Are you sure you want to submit?")) {
                is_submitted = true;
                // Disable button and show loading state
                $(this).prop('disabled', true);
                $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Starting...');
                $('#query-form').submit();
            }
        });

        // Clear validation on input
        $("input[name='familiarity']").change(() => $("input[name='familiarity']").closest('.btn-group').removeClass('is-invalid'));
        $("input[name='difficulty']").change(() => $("input[name='difficulty']").closest('.btn-group').removeClass('is-invalid'));
        $("input[name='effort']").change(() => $("input[name='effort']").closest('.btn-group').removeClass('is-invalid'));
        $('#first_search_query').on('input', () => $('#first_search_query').removeClass('is-invalid'));
        $('#initial_guess, #initial_guess_unknown').on('input change', () => $('#initial_guess').removeClass('is-invalid'));
        $("input[name='expected_source']").change(() => {
            const container = $("input[name='expected_source']").closest('.btn-group');
            container.removeClass('is-invalid');
            $('#expected_source_other').removeClass('is-invalid');
            // Reset display styles to allow Bootstrap's CSS to take over again
            container.nextAll('.invalid-feedback').first().css('display', '');
            $('#expected_source_other_feedback').css('display', '');
        });
        $('#expected_source_other').on('input', () => {
            $('#expected_source_other').removeClass('is-invalid');
            $('#expected_source_other_feedback').hide();
        });
        $('#preTaskCheck').change(() => $('#preTaskCheck').removeClass('is-invalid'));

        window.addEventListener('beforeunload', function (e) {
            if (!is_submitted) {
                navigator.sendBeacon('/task/stop_annotation/', new Blob());
            }
        });
    });
</script>
{% endblock %}