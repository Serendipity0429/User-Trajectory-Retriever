{% extends "base.html" %}
{% load task_manager_extras %}
{% block title %} Pre-Task Annotation {% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Pre-Task Annotation</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">Please answer the following questions before you begin the task.</p>
                    <hr>
                    <form id="query-form" action="" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="entry_id" id="entry-id" value="{{entry_id}}">

                        <!-- Task Description -->
                        <div class="mb-4 p-3 border rounded">
                            <h5>1. Task Description</h5>
                            <p>You need to answer the following question:</p>
                            <div class="p-3 bg-light rounded">{{ question }}</div>
                        </div>

                        <!-- Task Completion Criteria -->
                        <div class="mb-4 p-3 border rounded">
                            <h5>2. Task Completion Criteria</h5>
                            <p>The criteria for task completion is <strong>Exact Match (EM)</strong>. This means your answer must be <strong>precise</strong> and contain <strong>only the requested information</strong>. It is crucial that you provide just the answer itself, without any additional explanatory text or sentences.</p>
                            <h6>Example:</h6>
                            <ul class="list-group">
                                <li class="list-group-item"><em>Question:</em> What is the capital of France?</li>
                                <li class="list-group-item list-group-item-success"><em>Expected Answer:</em> Paris</li>
                                <li class="list-group-item list-group-item-danger"><em>Wrong Answer 1:</em> The capital of France is Paris. (Redundant information)</li>
                                <li class="list-group-item list-group-item-danger"><em>Wrong Answer 2:</em> Beijing (Incorrect answer)</li>
                            </ul>
                        </div>

                        <!-- Domain Familiarity -->
                        <div class="mb-4">
                            <h5>3. Domain Familiarity</h5>
                            <p>How familiar are you with the topic of this question?</p>
                            <div class="btn-group" role="group" aria-label="Familiarity">
                                {% for key, value in FAMILIARITY_MAP.items %}
                                <input type="radio" class="btn-check" name="familiarity" id="familiarity{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="familiarity{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ FAMILIARITY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Difficulty -->
                        <div class="mb-4">
                            <h5>4. Difficulty</h5>
                            <p>How do you evaluate the difficulty of the task?</p>
                            <div class="btn-group" role="group" aria-label="Difficulty">
                                {% for key, value in DIFFICULTY_MAP.items %}
                                <input type="radio" class="btn-check" name="difficulty" id="difficulty{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="difficulty{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Effort -->
                        <div class="mb-4">
                            <label for="effort" class="form-label"><h5>5. Effort</h5></label>
                            <p>How much time do you expect to spend on this task? <span class="badge bg-secondary" id="effort_val">5</span></p>
                            <input type="range" class="form-range" name="effort" id="effort" min="3" max="30" value="5" step="1" oninput="setEffort()">
                        </div>

                        <!-- Initial Strategy -->
                        <div class="mb-4">
                            <label for="initial_strategy" class="form-label"><h5>6. Initial Strategy</h5></label>
                            <p>Briefly describe your initial plan. For example, what search queries or keywords will you start with?</p>
                            <textarea class="form-control" id="initial_strategy" name="initial_strategy" rows="5" required></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="button" id="query-btn" class="btn btn-primary btn-lg btn-submit">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function setEffort() {
        let effortInput = document.getElementsByName("effort")[0];
        let effortVal = document.getElementById("effort_val");
        let value = parseInt(effortInput.value);
        let min = parseInt(effortInput.min);
        let max = parseInt(effortInput.max);

        if (value === min) {
            effortVal.innerText = value + " minutes and shorter";
        } else if (value === max) {
            effortVal.innerText = value + " minutes and longer";
        } else {
            effortVal.innerText = value + " minutes";
        }
    }

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    $(function () {
        setEffort();
        let is_submitted = false;
        $('#query-btn').click(function () {
            if (!$("input[name='familiarity']:checked").val()) {
                alert('Please select your domain familiarity!');
                return;
            }
            if (!$("input[name='difficulty']:checked").val()) {
                alert('Please select the task difficulty!');
                return;
            }
            if ($('#initial_strategy').val().trim() === '') {
                alert('Please describe your initial strategy!');
                $('#initial_strategy').focus();
                return;
            }

            if (confirm("Are you sure you want to submit?")) {
                is_submitted = true;
                $('#query-form').submit();
            }
        });

        window.addEventListener('beforeunload', function (e) {
            if (!is_submitted) {
                navigator.sendBeacon('/task/stop_annotation/', new Blob());
            }
        });
    });
</script>
{% endblock %}