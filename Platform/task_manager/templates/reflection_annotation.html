{% extends "base.html" %}
{% load task_manager_extras %}

{% block title %}Reflection Annotation{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Reflection Required</h4>
                </div>
                <div class="card-body">
                                    <p class="lead text-center"><span class="text-danger">Your answer was incorrect.</span> Please provide feedback and reflection on this trial.</p>
                
                                    <div class="accordion mb-4" id="trajectoriesAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingOne">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                                    <i class="bi bi-signpost-split-fill me-2"></i> <strong>View Trajectories</strong>&nbsp;(Click to expand)
                                                </button>
                                            </h2>
                                            <div id="collapseTrajectories" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#trajectoriesAccordion">
                                                <div class="accordion-body">
                                                    {% for webpage in webpages %}
                                                    <div class="d-flex flex-column align-items-center mb-5 p-4 border rounded shadow-sm bg-light">
                                                        <p class="h5"><a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                                        <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}" style="margin-top: 20px;"></div>
                                                        <script>
                                                            (function() {
                                                                var target = document.getElementById('rrweb-player-{{ webpage.id }}');
                                                                var events = {{ webpage.rrweb_record|safe }};
                                                                
                                                                if (!Array.isArray(events) || events.length === 0) {
                                                                    return;
                                                                }

                                                                // Get screen width and height ratio
                                                                var screenRatio = window.innerHeight / window.innerWidth;

                                                                var accordionWidth = document.querySelector('.card-body').clientWidth;
                                                                var containerWidth = 0.8 * accordionWidth;
                                                                var calculatedHeight = containerWidth * screenRatio;

                                                                new rrwebPlayer({
                                                                    target: target,
                                                                    props: {
                                                                        events: events,
                                                                        autoPlay: false,
                                                                        width: containerWidth,
                                                                        height: calculatedHeight,
                                                                        UNSAFE_replayCanvas: true,
                                                                    },
                                                                });
                                                            })();
                                                        </script>
                                                    </div>
                                                    {% endfor %}
                                                    <div class="text-center mt-3">
                                                        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                                            Fold
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                
                                    <form id="query-form" action="" method="post" enctype='multipart/form-data'>
                                        {% csrf_token %}
                                        <!-- Task Description -->
                                        <div class="mb-4 p-3 border rounded">
                                            <h5><strong>1. Understand the Task</strong></h5>
                                            <p>Your goal is to answer the following question accurately.</p>
                                            <div class="p-3 bg-light rounded loaded-box">
                                                <div class="question-text">
                                                    {{ question }}
                                                </div>
                                            </div>
                                        </div>
                
                                        <!-- User's Answer -->
                                        <div class="mb-4 p-3 border rounded">
                                            <h5><strong>2. Your Answer</strong></h5>
                                            <p>This is the answer you submitted in the previous trial.</p>
                                            <div class="p-3 bg-light rounded loaded-box">
                                                <div class="question-text">
                                                    {{ user_answer }}
                                                </div>
                                            </div>
                                        </div>
                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>3. Primary Reasons for Failure</strong></h5>
                            <p><strong>Select at least one reason and drag to reorder by priority.</strong></p>
                            <div id="selected-failure-categories" class="sortable-list list-group mb-2"></div>
                            <hr id="failure-separator" style="display: none;">
                            <div id="unselected-failure-categories" class="list-group">
                                {% for key, value in FAILURE_CATEGORY_MAP.items %}
                                <div class="list-group-item drag-option d-flex align-items-center mb-2" data-value="{{ key }}">
                                    <input class="form-check-input me-2" type="checkbox" name="failure_category" value="{{ key }}">
                                    <span class="drag-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                                    <span class="priority-number me-2"></span>
                                    {% if key == 'other' %}
                                    <span>{{ value }}</span>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <input type="text" name="failure_category_other" class="form-control form-control-sm ms-2" style="display:none;" placeholder="Please specify...">
                                        <div class="invalid-feedback">Please specify your "Other" failure reason.</div>
                                    </div>
                                    {% else %}
                                    <span class="flex-grow-1">{{ value }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select at least one primary reason for failure.</div>
                            <input type="hidden" name="failure_category_list" id="failure_category_list" />
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>4. Failure Analysis</strong></h5>
                            <p>Please elaborate on what went wrong (e.g., "I trusted an outdated blog post," "I misread the column header.").</p>
                            <textarea class="form-control" id="failure_reason" name="failure_reason" rows="3" required></textarea>
                            <div class="invalid-feedback">Please provide a failure analysis.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>5. Corrective Plan</strong></h5>
                            <p><strong>What will you do in your next attempt? Select at least one and drag to reorder.</strong></p>
                            <div id="selected-corrective-actions" class="sortable-list list-group mb-2"></div>
                            <hr id="corrective-separator" style="display: none;">
                            <div id="unselected-corrective-actions" class="list-group">
                                {% for key, value in CORRECTIVE_PLAN_MAP.items %}
                                <div class="list-group-item drag-option d-flex align-items-center mb-2" data-value="{{ key }}">
                                    <input class="form-check-input me-2" type="checkbox" name="future_plan_actions" value="{{ key }}">
                                    <span class="drag-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                                    <span class="priority-number me-2"></span>
                                    {% if key == 'other' %}
                                    <span>{{ value }}</span>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <input type="text" name="future_plan_other" class="form-control form-control-sm ms-2" style="display:none;" placeholder="Please specify...">
                                        <div class="invalid-feedback">Please specify your "Other" corrective action.</div>
                                    </div>
                                    {% else %}
                                    <span class="flex-grow-1">{{ value }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select at least one corrective action.</div>
                            <input type="hidden" name="future_plan_actions_list" id="future_plan_actions_list" />
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>6. Estimated Time Left</strong></h5>
                            <p>Please estimate how much more time you think you'll need to complete this task.</p>
                            <div class="btn-group" role="group" aria-label="Effort">
                                {% for key, value in EFFORT_MAP.items %}
                                <input type="radio" class="btn-check" name="estimated_time" id="effort{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="effort{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ EFFORT_EXPLANATION_MAP|get_item:key }}">
                                    {{ value }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please estimate the time left.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>7. Adjusted Difficulty</strong></h5>
                            <p>After this attempt, how would you rate the difficulty of the task?</p>
                            <div class="btn-group" role="group" aria-label="Adjusted Difficulty">
                                {% for key, value in DIFFICULTY_MAP.items %}
                                <input type="radio" class="btn-check" name="adjusted_difficulty" id="adjusted_difficulty{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="adjusted_difficulty{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select the adjusted difficulty.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>8. (Optional) Additional Reflection</strong></h5>
                            <p>Any other thoughts on this attempt?</p>
                            <textarea class="form-control" id="additional_reflection" name="additional_reflection" rows="3"></textarea>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" id="query-btn" class="btn btn-primary btn-lg btn-submit">Submit Reflection</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(function () {
    function initializeSortable(selectedListId, unselectedListId, inputName, hiddenInputId, separatorId) {
        const selectedList = $("#" + selectedListId);
        const unselectedList = $("#" + unselectedListId);

        selectedList.sortable({
            handle: ".drag-handle",
            placeholder: "sortable-placeholder list-group-item",
            update: function(event, ui) {
                updateOrderAndPriority(selectedList, hiddenInputId);
            }
        }).disableSelection();

        $('input[name="' + inputName + '"]').change(function() {
            const option = $(this).closest('.drag-option');
            if (this.checked) {
                option.appendTo(selectedList);
            } else {
                option.appendTo(unselectedList);
                option.find('.priority-number').text(''); // Clear the priority number
            }
            
            // Handle 'other' text input visibility
            if (inputName === 'future_plan_actions' && option.data('value') === 'other') {
                option.find('input[type="text"]').toggle(this.checked);
            }
            if (inputName === 'failure_category' && option.data('value') === 'other') {
                option.find('input[type="text"]').toggle(this.checked);
            }

            updateOrderAndPriority(selectedList, hiddenInputId);
            $('#' + separatorId).toggle(selectedList.children().length > 0 && unselectedList.children().length > 0);
        });
    }

    function updateOrderAndPriority(selectedList, hiddenInputId) {
        const order = [];
        selectedList.children('.drag-option').each(function(index) {
            const value = $(this).data('value');
            order.push(value);
            $(this).find('.priority-number').text(index + 1);
        });
        $('#' + hiddenInputId).val(JSON.stringify(order));
    }

    initializeSortable("selected-failure-categories", "unselected-failure-categories", "failure_category", "failure_category_list", "failure-separator");
    initializeSortable("selected-corrective-actions", "unselected-corrective-actions", "future_plan_actions", "future_plan_actions_list", "corrective-separator");

    let is_submitted = false;
    $('#query-btn').click(function () {
        // Reset validation states
        $('.is-invalid').removeClass('is-invalid');
        let isValid = true;

        // Validation for failure categories
        const failureCategories = $('input[name="failure_category"]:checked');
        const failureCategoryOther = $('input[name="failure_category_other"]');
        if (failureCategories.length === 0) {
            $('#unselected-failure-categories').addClass('is-invalid');
            isValid = false;
        } else if ($('input[name="failure_category"][value="other"]').is(':checked') && failureCategoryOther.val().trim() === '') {
            failureCategoryOther.addClass('is-invalid');
            isValid = false;
        }

        // Validation for failure reason
        const failureReason = $('#failure_reason');
        if (failureReason.val().trim() === '') {
            failureReason.addClass('is-invalid');
            isValid = false;
        }

        // Validation for corrective plan
        const correctiveActions = $('input[name="future_plan_actions"]:checked');
        const correctiveActionOther = $('input[name="future_plan_other"]');
        if (correctiveActions.length === 0) {
            $('#unselected-corrective-actions').addClass('is-invalid');
            isValid = false;
        } else if ($('input[name="future_plan_actions"][value="other"]').is(':checked') && correctiveActionOther.val().trim() === '') {
            correctiveActionOther.addClass('is-invalid');
            isValid = false;
        }

        // Validation for estimated time left
        if (!$('input[name="estimated_time"]:checked').val()) {
            $('input[name="estimated_time"]').closest('.btn-group').addClass('is-invalid');
            isValid = false;
        }

        // Validation for adjusted difficulty
        if (!$('input[name="adjusted_difficulty"]:checked').val()) {
            $('input[name="adjusted_difficulty"]').closest('.btn-group').addClass('is-invalid');
            isValid = false;
        }

        if (!isValid) {
            return;
        }

        if (confirm("Are you sure you want to submit your reflection?")) {
            is_submitted = true;
            $('#query-form').submit();
        }
    });

    // Clear validation on input
    $('input[name="failure_category"]').change(() => {
        $('#unselected-failure-categories').removeClass('is-invalid');
        $('input[name="failure_category_other"]').removeClass('is-invalid');
    });
    $('input[name="failure_category_other"]').on('input', () => $('input[name="failure_category_other"]').removeClass('is-invalid'));
    $('#failure_reason').on('input', () => $('#failure_reason').removeClass('is-invalid'));
    $('input[name="future_plan_actions"]').change(() => {
        $('#unselected-corrective-actions').removeClass('is-invalid');
        $('input[name="future_plan_other"]').removeClass('is-invalid');
    });
    $('input[name="future_plan_other"]').on('input', () => $('input[name="future_plan_other"]').removeClass('is-invalid'));
    $('input[name="estimated_time"]').change(() => $('input[name="estimated_time"]').closest('.btn-group').removeClass('is-invalid'));
    $('input[name="adjusted_difficulty"]').change(() => $('input[name="adjusted_difficulty"]').closest('.btn-group').removeClass('is-invalid'));

    window.addEventListener('beforeunload', function (e) {
        if (!is_submitted) {
            navigator.sendBeacon('/task/stop_annotation/', new Blob());
        }
    });
});
</script>
{% endblock %}
