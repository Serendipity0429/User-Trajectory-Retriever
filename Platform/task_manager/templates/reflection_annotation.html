{% extends "base.html" %}
{% load task_manager_extras %}

{% block title %}Reflection Annotation{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Reflection Required</h4>
                </div>
                <div class="card-body">
                                    <p class="lead text-center"><span class="text-danger">Your answer was incorrect.</span> Please provide feedback and reflection on this trial.</p>
                
                                    <div class="accordion mb-4" id="trajectoriesAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingOne">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                                    <i class="bi bi-signpost-split-fill me-2"></i> <strong>Task Trajectories</strong>&nbsp;(Click to expand)
                                                </button>
                                            </h2>
                                            <div id="collapseTrajectories" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#trajectoriesAccordion">
                                                <div class="accordion-body">
                                                    {% for webpage in webpages %}
                                                    <div class="d-flex flex-column align-items-center mb-4 p-3 border rounded">
                                                        <p class="h5">Webpage {{ forloop.counter }}: <a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                                        <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}" data-events='{{ webpage.rrweb_record|safe }}'></div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                
                                    <form id="query-form" action="" method="post" enctype='multipart/form-data'>
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3 p-3 border rounded bg-light">
                                                    <label class="form-label"><strong>1. Task Description</strong></label>
                                                    <div class="question-text">{{ question }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3 p-3 border rounded bg-light">
                                                    <label class="form-label"><strong>2. Your Answer</strong></label>
                                                    <div class="question-text">{{ user_answer }}</div>
                                                </div>
                                            </div>
                                        </div>
                        <div class="mb-4 p-3 border rounded">
                            <label class="form-label"><strong>3. Primary Reasons for Failure</strong></label>
                            <p class="form-text text-muted"><strong>Select at least one reason and drag to reorder by priority.</strong></p>
                            <div id="selected-failure-categories" class="sortable-list list-group mb-2"></div>
                            <hr id="failure-separator" style="display: none;">
                            <div id="unselected-failure-categories" class="list-group">
                                {% for key, value in FAILURE_CATEGORY_MAP.items %}
                                <div class="list-group-item drag-option d-flex align-items-center mb-2" data-value="{{ key }}">
                                    <input class="form-check-input me-2" type="checkbox" name="failure_category" value="{{ key }}">
                                    <span class="drag-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                                    <span class="priority-number me-2"></span>
                                    {% if key == 'other' %}
                                    <span>{{ value }}</span>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <input type="text" name="failure_category_other" class="form-control form-control-sm ms-2" style="display:none;" placeholder="Please specify...">
                                    </div>
                                    {% else %}
                                    <span class="flex-grow-1">{{ value }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="failure_category_list" id="failure_category_list" />
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <label for="failure_reason" class="form-label"><strong>4. Failure Analysis</strong></label>
                            <p class="form-text text-muted">Please elaborate on what went wrong (e.g., "I trusted an outdated blog post," "I misread the column header.").</p>
                            <textarea class="form-control" id="failure_reason" name="failure_reason" rows="3" required></textarea>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <label class="form-label"><strong>5. Corrective Plan</strong></label>
                            <p class="form-text text-muted"><strong>What will you do in your next attempt? Select at least one and drag to reorder.</strong></p>
                            <div id="selected-corrective-actions" class="sortable-list list-group mb-2"></div>
                            <hr id="corrective-separator" style="display: none;">
                            <div id="unselected-corrective-actions" class="list-group">
                                {% for key, value in CORRECTIVE_PLAN_MAP.items %}
                                <div class="list-group-item drag-option d-flex align-items-center mb-2" data-value="{{ key }}">
                                    <input class="form-check-input me-2" type="checkbox" name="future_plan_actions" value="{{ key }}">
                                    <span class="drag-handle me-2"><i class="bi bi-grip-vertical"></i></span>
                                    <span class="priority-number me-2"></span>
                                    {% if key == 'other' %}
                                    <span>{{ value }}</span>
                                    <div class="d-flex align-items-center flex-grow-1">
                                        <input type="text" name="future_plan_other" class="form-control form-control-sm ms-2" style="display:none;" placeholder="Please specify...">
                                    </div>
                                    {% else %}
                                    <span class="flex-grow-1">{{ value }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="future_plan_actions_list" id="future_plan_actions_list" />
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <label for="remaining_effort" class="form-label"><strong>6. Remaining Effort</strong></label>
                            <p class="form-text text-muted">How do you evaluate the difficulty of the task?</p>
                            <div class="btn-group" role="group" aria-label="Difficulty">
                                {% for key, value in DIFFICULTY_MAP.items %}
                                <input type="radio" class="btn-check" name="remaining_effort" id="remaining_effort{{ key }}" value="{{ key }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="remaining_effort{{ key }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ DIFFICULTY_EXPLANATION_MAP|get_item:key }}">
                                    <strong>{{ key }}</strong><br>{{ value|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <label for="additional_reflection" class="form-label"><strong>7. (Optional) Additional Reflection</strong></label>
                            <p class="form-text text-muted">Any other thoughts on this attempt?</p>
                            <textarea class="form-control" id="additional_reflection" name="additional_reflection" rows="3"></textarea>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" id="query-btn" class="btn btn-primary btn-lg btn-submit">Submit Reflection</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(function () {
    function initializeSortable(selectedListId, unselectedListId, inputName, hiddenInputId, separatorId) {
        const selectedList = $("#" + selectedListId);
        const unselectedList = $("#" + unselectedListId);

        selectedList.sortable({
            handle: ".drag-handle",
            placeholder: "sortable-placeholder list-group-item",
            update: function(event, ui) {
                updateOrderAndPriority(selectedList, hiddenInputId);
            }
        }).disableSelection();

        $('input[name="' + inputName + '"]').change(function() {
            const option = $(this).closest('.drag-option');
            if (this.checked) {
                option.appendTo(selectedList);
            } else {
                option.appendTo(unselectedList);
                option.find('.priority-number').text(''); // Clear the priority number
            }
            
            // Handle 'other' text input visibility
            if (inputName === 'future_plan_actions' && option.data('value') === 'other') {
                option.find('input[type="text"]').toggle(this.checked);
            }
            if (inputName === 'failure_category' && option.data('value') === 'other') {
                option.find('input[type="text"]').toggle(this.checked);
            }

            updateOrderAndPriority(selectedList, hiddenInputId);
            $('#' + separatorId).toggle(selectedList.children().length > 0 && unselectedList.children().length > 0);
        });
    }

    function updateOrderAndPriority(selectedList, hiddenInputId) {
        const order = [];
        selectedList.children('.drag-option').each(function(index) {
            const value = $(this).data('value');
            order.push(value);
            $(this).find('.priority-number').text(index + 1);
        });
        $('#' + hiddenInputId).val(JSON.stringify(order));
    }

    initializeSortable("selected-failure-categories", "unselected-failure-categories", "failure_category", "failure_category_list", "failure-separator");
    initializeSortable("selected-corrective-actions", "unselected-corrective-actions", "future_plan_actions", "future_plan_actions_list", "corrective-separator");

    $('#remaining_effort').on('input', function() {
        $('#effort_val').text($(this).val());
    });

    let is_submitted = false;
    $('#query-btn').click(function () {
        if ($('input[name="failure_category"]:checked').length === 0) {
            alert('Please select at least one primary reason for failure.');
            return;
        }
        if ($('input[name="failure_category"][value="other"]').is(':checked') && $('input[name="failure_category_other"]').val().trim() === '') {
            alert('Please specify your "Other" failure reason.');
            $('input[name="failure_category_other"]').focus();
            return;
        }
        if ($('#failure_reason').val().trim() === '') {
            alert('Please provide a failure analysis.');
            $('#failure_reason').focus();
            return;
        }
        if ($('input[name="future_plan_actions"]:checked').length === 0) {
            alert('Please select at least one corrective action.');
            return;
        }
        if ($('input[name="future_plan_actions"][value="other"]').is(':checked') && $('input[name="future_plan_other"]').val().trim() === '') {
            alert('Please specify your "Other" corrective action.');
            $('input[name="future_plan_other"]').focus();
            return;
        }
        if (!$('input[name="remaining_effort"]:checked').val()) {
            alert('Please select the remaining effort.');
            return;
        }

        if (confirm("Are you sure you want to submit your reflection?")) {
            is_submitted = true;
            $('#query-form').submit();
        }
    });

    window.addEventListener('beforeunload', function (e) {
        if (!is_submitted) {
            navigator.sendBeacon('/task/stop_annotation/', new Blob());
        }
    });
});

function initRrwebPlayer(playerWrapper) {
    if (playerWrapper.dataset.initialized === 'true' || !playerWrapper.dataset.events) {
        return;
    }

    var events;
    try {
        events = JSON.parse(playerWrapper.dataset.events);
    } catch (e) {
        console.error('Could not parse rrweb events for player', playerWrapper.id, e);
        return;
    }

    if (!Array.isArray(events) || events.length === 0) {
        return;
    }

    var containerWidth = playerWrapper.offsetWidth;
    if (containerWidth === 0) {
        return; // Not visible, will be initialized when accordion opens.
    }

    // Clear existing content
    while (playerWrapper.firstChild) {
        playerWrapper.removeChild(playerWrapper.firstChild);
    }

    var calculatedHeight = containerWidth * (9 / 16);

    new rrwebPlayer({
        target: playerWrapper,
        props: {
            events: events,
            autoPlay: false,
            width: '100%',
            height: calculatedHeight,
            UNSAFE_replayCanvas: true,
        },
    });
    playerWrapper.dataset.initialized = 'true';
}

var trajectoriesCollapse = document.getElementById('collapseTrajectories');
if (trajectoriesCollapse) {
    trajectoriesCollapse.addEventListener('shown.bs.collapse', function () {
        trajectoriesCollapse.querySelectorAll('.rrweb-player-wrapper').forEach(initRrwebPlayer);
    });
}

// Init any players that are already visible on load
document.querySelectorAll('.rrweb-player-wrapper').forEach(initRrwebPlayer);
</script>
{% endblock %}
