{% extends "base.html" %}
{% block title %}Task Process Details{% endblock %}
{% block content_title %}Task Process Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xs-offset-1 col-xs-10 task-process-container">
        <!-- General Task Information -->
        <div class="sheet" style="margin-bottom: 20px; border: 1px solid #c2c9c9;">
            <div class="question-wrapper col-xs-12">
                <div class="question-text">Task Question</div>
                <div class="static-task-info">{{ task_question }}</div>
            </div>
            <div class="question-wrapper col-xs-12">
                <div class="question-text">Task Completion Criteria</div>
                <div class="static-task-info" style="font-size: medium; color: #333;">Exact Match (EM)</div>
            </div>
        </div>

        <!-- Pre-Task Annotation -->
        {% if pre_task_annotation %}
        <details open>
            <summary>Pre-Task Annotation</summary>
            <div class="annotation-body">
                <div class="annotation-block">
                    <div class="question-text">Domain Familiarity</div>
                    <div class="annotation-value">{{ pre_task_annotation.familiarity }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Predicted Difficulty</div>
                    <div class="annotation-value">{{ pre_task_annotation.difficulty }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Predicted Effort (minutes)</div>
                    <div class="annotation-value">{{ pre_task_annotation.effort }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Initial Strategy</div>
                    <div class="annotation-value">{{ pre_task_annotation.initial_strategy }}</div>
                </div>
            </div>
        </details>
        {% endif %}

        <!-- Trials Loop -->
        {% for trial in trials %}
        <details>
            <summary>
                Trial {{ trial.num_trial }} -
                {% if trial.is_correct %}
                    <span class="status-right">Correct</span>
                {% else %}
                    <span class="status-wrong">Incorrect</span>
                {% endif %}
            </summary>
            <div class="annotation-body">
                <!-- Session Replay for this Trial -->
                <div class="annotation-block">
                     <div class="question-text" style="font-size: 1.4em; color: #337ab7;">Session Replay</div>
                     {% for webpage in trial.webpages %}
                        <div class="webpage-wrapper">
                            <p style="font-size: 18px">Webpage {{ forloop.counter }}: <a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                            <div class="rrweb-player-wrapper" id="rrweb-player-trial{{trial.num_trial}}-{{ webpage.id }}"></div>
                            <script>
                                new rrwebPlayer({
                                    target: document.getElementById('rrweb-player-trial{{trial.num_trial}}-{{ webpage.id }}'),
                                    props: {
                                        events: {{ webpage.rrweb_events|safe }},
                                        autoPlay: false,
                                        width: 800,
                                        height: 377,
                                    },
                                });
                            </script>
                        </div>
                     {% empty %}
                        <p>No recorded webpages for this trial.</p>
                     {% endfor %}
                </div>

                <!-- Submitted Answer -->
                <div class="annotation-block">
                    <div class="question-text" style="font-size: 1.4em; color: #337ab7;">Submitted Answer</div>
                    <div class="question-text">Answer:</div>
                    <div class="annotation-value">{{ trial.submitted_answer.answer }}</div>
                    
                    <div class="question-text" style="margin-top:15px;">Confidence:</div>
                    <div class="annotation-value">{{ trial.submitted_answer.confidence }}</div>

                    <div class="question-text" style="margin-top:15px;">Justification:</div>
                    <div class="annotation-value">
                        <ul>
                        {% for source in trial.submitted_answer.sources %}
                            <li>
                                <strong>URL:</strong> <a href="{{ source.url }}" target="_blank">{{ source.url }}</a><br>
                                <strong>Text:</strong> {{ source.text }}
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                    
                    <div class="question-text" style="margin-top:15px;">Reasoning Method:</div>
                    <div class="annotation-value">{{ trial.submitted_answer.reasoning_method }}</div>
                    
                    {% if trial.submitted_answer.additional_explanation %}
                    <div class="question-text" style="margin-top:15px;">Additional Explanation:</div>
                    <div class="annotation-value">{{ trial.submitted_answer.additional_explanation }}</div>
                    {% endif %}
                </div>

                <!-- Reflection Annotation (if wrong) -->
                {% if not trial.is_correct and trial.reflection_annotation %}
                <div class="annotation-block">
                    <div class="question-text" style="font-size: 1.4em; color: #337ab7;">Reflection (Incorrect Answer)</div>
                    <div class="question-text">Primary Reasons for Failure:</div>
                    <div class="annotation-value">
                        <ul>
                        {% for reason in trial.reflection_annotation.failure_reasons %}
                            <li>{{ reason }}</li>
                        {% endfor %}
                        </ul>
                    </div>

                    <div class="question-text" style="margin-top:15px;">Failure Analysis:</div>
                    <div class="annotation-value">{{ trial.reflection_annotation.failure_analysis }}</div>

                    <div class="question-text" style="margin-top:15px;">Corrective Plan:</div>
                    <div class="annotation-value">
                         <ul>
                        {% for plan in trial.reflection_annotation.corrective_plan %}
                            <li>{{ plan }}</li>
                        {% endfor %}
                        </ul>
                    </div>

                    <div class="question-text" style="margin-top:15px;">Expected Remaining Effort (minutes):</div>
                    <div class="annotation-value">{{ trial.reflection_annotation.remaining_effort }}</div>
                    
                    {% if trial.reflection_annotation.additional_reflection %}
                    <div class="question-text" style="margin-top:15px;">Additional Reflection:</div>
                    <div class="annotation-value">{{ trial.reflection_annotation.additional_reflection }}</div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </details>
        {% endfor %}

        <!-- Post-Task Annotation (if task was successfully completed) -->
        {% if post_task_annotation %}
        <details open>
            <summary>Final Annotation (Successful Completion)</summary>
            <div class="annotation-body">
                <div class="annotation-block">
                    <div class="question-text">Overall Difficulty</div>
                    <div class="annotation-value">{{ post_task_annotation.difficulty_actual }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">"Aha!" Moment</div>
                    <div class="annotation-value">{{ post_task_annotation.aha_moment_type }}</div>
                     {% if post_task_annotation.aha_moment_source %}
                    <div class="question-text" style="margin-top:15px;">"Aha!" Moment Source:</div>
                    <div class="annotation-value">{{ post_task_annotation.aha_moment_source }}</div>
                    {% endif %}
                </div>
                <div class="annotation-block">
                    <div class="question-text">Unhelpful Paths Encountered</div>
                    <div class="annotation-value">
                        <ul>
                        {% for path in post_task_annotation.unhelpful_paths %}
                            <li>{{ path }}</li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Strategic Shift</div>
                    <div class="annotation-value">{{ post_task_annotation.strategy_shift }}</div>
                </div>
                 {% if post_task_annotation.additional_reflection %}
                <div class="annotation-block">
                    <div class="question-text">Additional Reflection</div>
                    <div class="annotation-value">{{ post_task_annotation.additional_reflection }}</div>
                </div>
                {% endif %}
            </div>
        </details>
        {% endif %}

        <!-- Cancel Annotation (if task was cancelled) -->
        {% if cancel_annotation %}
        <details open>
            <summary>Task Status: <span class="status-cancelled">Cancelled</span></summary>
            <div class="annotation-body">
                <div class="annotation-block">
                    <div class="question-text">Primary Reason for Cancellation</div>
                    <div class="annotation-value">{{ cancel_annotation.cancel_category }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Detailed Explanation</div>
                    <div class="annotation-value">{{ cancel_annotation.cancel_reason }}</div>
                </div>
                <div class="annotation-block">
                    <div class="question-text">Missing Resources</div>
                    <div class="annotation-value">
                        <ul>
                        {% for resource in cancel_annotation.missing_resources %}
                            <li>{{ resource }}</li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
                {% if cancel_annotation.additional_reflection %}
                <div class="annotation-block">
                    <div class="question-text">Additional Reflection</div>
                    <div class="annotation-value">{{ cancel_annotation.additional_reflection }}</div>
                </div>
                {% endif %}
            </div>
        </details>
        {% endif %}

    </div>
</div>
{% endblock %}
