{% extends "base.html" %}
{% load task_manager_extras %}

{% block title %}Task Process Details{% endblock %}

{% block css %}
<style>
    .timeline {
        position: relative;
        padding-left: 2rem; /* Reduced space */
        border-left: 2px solid #e9ecef;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: -2.5rem; /* Adjusted position */
        top: 0.2rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background-color: #fff;
        border: 2px solid #0d6efd;
        z-index: 1; /* Ensure circle is on top */
    }
    .timeline-item.success:before {
        border-color: #198754;
    }
    .timeline-item.danger:before {
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Task Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Task Details</h1>
            <p class="text-muted">A detailed breakdown of the annotation process.</p>
        </div>
        <a href="/task/home" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Task List</a>
    </div>

    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-lg-4">
            <!-- Basic Info -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle-fill me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="loaded-box">
    <p><strong>Task Description:</strong></p>
    <div class="question-text">{{ task_question }}</div>
</div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-check2-all me-2"></i>Correct Answer(s):</h6>
                        <div class="mt-2">
                            <a href="#" id="show-all-answers" class="btn btn-outline-secondary btn-sm" style="display: none;">Show all...</a>
                            <a href="#" id="show-fewer-answers" class="btn btn-outline-secondary btn-sm" style="display: none;">Show fewer...</a>
                        </div>
                    </div>
                    <ul id="answer-list" class="list-group list-group-flush mt-2">
                        {% if user_final_answer %}
                        <li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                            {{ user_final_answer }}
                            <span class="badge bg-success-light">Your Answer</span>
                        </li>
                        {% endif %}
                        {% for item in task_answer %}
                            {% if item != user_final_answer %}
                            <li class="list-group-item">{{ item }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Pre-Task Annotation -->
            {% if pre_task_annotation %}
            <div class="card mb-4 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Pre-Task Annotation</h5>
                </div>
                <div class="card-body">
                    <p><span class="annotation-key"><i class="bi bi-lightbulb me-2"></i>Domain Familiarity:</span> {{ FAMILIARITY_MAP|get_item:pre_task_annotation.familiarity }}</p>
                    <p><span class="annotation-key"><i class="bi bi-bar-chart-line me-2"></i>Difficulty:</span> {{ DIFFICULTY_MAP|get_item:pre_task_annotation.difficulty }}</p>
                    <p><span class="annotation-key"><i class="bi bi-clock-history me-2"></i>Effort:</span> {{ EFFORT_MAP|get_item:pre_task_annotation.effort }}</p>
                    <p><span class="annotation-key"><i class="bi bi-lightbulb me-2"></i>Initial Guess:</span> 
    {% if pre_task_annotation.initial_guess_unknown %}
        I don't know
    {% else %}
        {{ pre_task_annotation.initial_guess }}
    {% endif %}
</p>
<p><span class="annotation-key"><i class="bi bi-compass me-2"></i>Expected Source of Answer:</span> 
    {{ EXPECTED_SOURCES_MAP|get_item:pre_task_annotation.expected_source }}
    {% if pre_task_annotation.expected_source_other %}
        ({{ pre_task_annotation.expected_source_other }})
    {% endif %}
</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Content: Trials Timeline -->
        <div class="col-lg-8">
            <div class="timeline">
                {% for trial in trials %}
                <div class="timeline-item {% if trial.is_correct %}success{% else %}danger{% endif %}">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Trial {{ trial.num_trial }}</h5>
                            {% if trial.is_correct %}
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i> Correct</span>
                            {% else %}
                            <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i> Incorrect</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <!-- Session Replay -->
                            <div class="accordion mb-3" id="accordion-trial-{{ trial.num_trial }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-trial-{{ trial.num_trial }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-trial-{{ trial.num_trial }}" aria-expanded="false" aria-controls="collapse-trial-{{ trial.num_trial }}">
                                            <i class="bi bi-display me-2"></i> <strong>Session Replay</strong>&nbsp;(Click to expand)
                                        </button>
                                    </h2>
                                    <div id="collapse-trial-{{ trial.num_trial }}" class="accordion-collapse collapse" aria-labelledby="heading-trial-{{ trial.num_trial }}">
                                        <div class="accordion-body">
                                            {% for webpage in trial.webpages %}
                                            <div class="d-flex flex-column align-items-center mb-5 p-4 border rounded shadow-sm bg-light">
                                                <p class="h5"><a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                                <div class="rrweb-player-wrapper" id="rrweb-player-trial{{trial.num_trial}}-{{ webpage.id }}" style="margin-top: 20px;"></div>
                                                <script>
                                                    (function() {
                                                        var target = document.getElementById('rrweb-player-trial{{trial.num_trial}}-{{ webpage.id }}');
                                                        var events = {{ webpage.rrweb_record|safe }};
                                                        
                                                        if (!Array.isArray(events) || events.length === 0) {
                                                            return;
                                                        }

                                                        var container = target.closest('.card-body');
                                                        if (container) {
                                                            var containerWidth = container.clientWidth * 0.8;
                                                            var screenRatio = window.innerHeight / window.innerWidth;
                                                            var calculatedHeight = containerWidth * screenRatio;

                                                            new rrwebPlayer({
                                                                target: target,
                                                                props: {
                                                                    events: events,
                                                                    autoPlay: false,
                                                                    width: containerWidth,
                                                                    height: calculatedHeight,
                                                                    UNSAFE_replayCanvas: true,
                                                                },
                                                            });
                                                        }
                                                    })();
                                                </script>
                                            </div>
                                            {% empty %}
                                            <p>No recorded webpages for this trial.</p>
                                            {% endfor %}
                                            <div class="text-center mt-3">
                                                <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-trial-{{ trial.num_trial }}" aria-expanded="false" aria-controls="collapse-trial-{{ trial.num_trial }}">
                                                    Fold
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Submitted Answer & Reflection Card -->
                            <div class="card shadow-sm">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Submitted Answer & Reflection</h6>
                                </div>
                                <div class="card-body p-4">
                                    <p><span class="annotation-key">Your Answer:</span> {{ trial.answer }}</p>
                                    <p><span class="annotation-key">Confidence:</span> {{ CONFIDENCE_MAP|get_item:trial.confidence }}</p>
                                    <p><span class="annotation-key">Justification:</span></p>
                                    <ul class="list-unstyled">
                                        {% for source in trial.submitted_sources %}
                                        <li class="mb-2">
                                            <p class="mb-1"><span class="annotation-key">URL:</span> <a href="{{ source.url }}" target="_blank">{{ source.url }}</a></p>
                                            <blockquote class="blockquote bg-light p-2 rounded" style="font-size: 0.9rem;">
                                                {{ source.text }}
                                            </blockquote>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <p><span class="annotation-key">Reasoning Method:</span> {{ REASONING_METHOD_MAP|get_item:trial.reasoning_method }}</p>
                                    {% if trial.additional_explanation %}
                                    <p><span class="annotation-key">Additional Explanation:</span> {{ trial.additional_explanation }}</p>
                                    {% endif %}

                                    {% if not trial.is_correct and trial.reflection_annotation %}
                                    <hr>
                                    <h6><i class="bi bi-arrow-counterclockwise me-2"></i>Reflection</h6>
                                    <p><span class="annotation-key">Primary Reasons for Failure:</span></p>
                                    <ul>
                                        {% for reason in trial.reflection_annotation.failure_reasons %}
                                        <li>{{ FAILURE_CATEGORY_MAP|get_item:reason }}</li>
                                        {% endfor %}
                                    </ul>
                                    <p><span class="annotation-key">Failure Analysis:</span> {{ trial.reflection_annotation.failure_analysis }}</p>
                                    <p><span class="annotation-key">Corrective Plan:</span></p>
                                    <ul>
                                        {% for plan in trial.reflection_annotation.corrective_plan %}
                                        <li>{{ CORRECTIVE_PLAN_MAP|get_item:plan }}</li>
                                        {% endfor %}
                                    </ul>
                                    <p><span class="annotation-key">Remaining Effort:</span> {{ trial.reflection_annotation.remaining_effort }} minutes</p>
                                    {% if trial.reflection_annotation.additional_reflection %}
                                    <p><span class="annotation-key">Additional Reflection:</span> {{ trial.reflection_annotation.additional_reflection }}</p>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Post-Task & Cancel Annotations -->
                {% if post_task_annotation %}
                <div class="timeline-item success">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-award-fill me-2"></i>Final Annotation</h5>
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i> Successful</span>
                        </div>
                        <div class="card-body">
                            <p><span class="annotation-key">Overall Difficulty:</span> {{ DIFFICULTY_MAP|get_item:post_task_annotation.difficulty_actual }}</p>
                            <p><span class="annotation-key">"Aha!" Moment:</span> {{ AHA_MOMENT_MAP|get_item:post_task_annotation.aha_moment_type }}</p>
                            {% if post_task_annotation.aha_moment_other %}<p><span class="annotation-key">Details:</span> {{ post_task_annotation.aha_moment_other }}</p>{% endif %}
                            <p><span class="annotation-key">Strategic Shift:</span> {{ STRATEGY_SHIFT_MAP|get_item:post_task_annotation.strategy_shift }}</p>
                            {% if post_task_annotation.strategy_shift_other %}<p><span class="annotation-key">Details:</span> {{ post_task_annotation.strategy_shift_other }}</p>{% endif %}
                            {% if post_task_annotation.additional_reflection %}<p><span class="annotation-key">Additional Reflection:</span> {{ post_task_annotation.additional_reflection }}</p>{% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if cancel_annotation %}
                <div class="timeline-item danger">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Task Cancelled</h5>
                            <span class="badge bg-danger"><i class="bi bi-x-circle-fill me-1"></i> Cancelled</span>
                        </div>
                        <div class="card-body">
                            <p><span class="annotation-key">Reason for Cancellation:</span> {{ CANCEL_CATEGORY_MAP|get_item:cancel_annotation.cancel_category }}</p>
                            {% if cancel_annotation.cancel_reason %}<p><span class="annotation-key">Detailed Explanation:</span> {{ cancel_annotation.cancel_reason }}</p>{% endif %}
                            {% if cancel_annotation.cancel_additional_reflection %}<p><span class="annotation-key">Additional Reflection:</span> {{ cancel_annotation.cancel_additional_reflection }}</p>{% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(function () {
        var answerList = $('#answer-list');
        var listItems = answerList.find('li');
        var showAllButton = $('#show-all-answers');
        var showFewerButton = $('#show-fewer-answers');
        var initialItemCount = 2;

        if (listItems.length > initialItemCount) {
            listItems.slice(initialItemCount).hide();
            showAllButton.show();
        }

        showAllButton.on('click', function(e) {
            e.preventDefault();
            answerList.find('li:hidden').show();
            $(this).hide();
            showFewerButton.show();
        });

        showFewerButton.on('click', function(e) {
            e.preventDefault();
            listItems.slice(initialItemCount).hide();
            $(this).hide();
            showAllButton.show();
        });

        // Add event listener to all session replay accordions
        document.querySelectorAll('[id^="collapse-trial-"]').forEach(function(collapseEl) {
            collapseEl.addEventListener('shown.bs.collapse', function () {
                window.dispatchEvent(new Event('resize'));
            });
        });
    });
</script>
{% endblock %}