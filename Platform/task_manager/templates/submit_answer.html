{% extends "base.html" %}
{% load task_manager_extras %}
{% block title %}Answer Submission{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-lg mt-5">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="card-title mb-0">Trial {{ num_trial }} Submission</h2>
                </div>
                <div class="card-body p-5" id="card-body">
                    <div class="accordion mb-4" id="trajectoriesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                    <i class="bi bi-signpost-split-fill me-2"></i> <strong>View Trajectories</strong>&nbsp;(Click to expand)
                                </button>
                            </h2>
                            <div id="collapseTrajectories" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#trajectoriesAccordion">
                                <div class="accordion-body">
                                    {% for webpage in webpages %}
                                    <div class="d-flex flex-column align-items-center mb-5 p-4 border rounded shadow-sm bg-light">
                                        <p class="h5"><a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                        <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}" style="margin-top: 20px;"></div>
                                        <script>
                                            (function() {
                                                var target = document.getElementById('rrweb-player-{{ webpage.id }}');
                                                var events = {{ webpage.rrweb_record|safe }};
                                                
                                                if (!Array.isArray(events) || events.length === 0) {
                                                    return;
                                                }

                                                // Get screen width and height ratio
                                                var screenRatio = window.innerHeight / window.innerWidth;

                                                var accordionWidth = document.querySelector('#card-body').clientWidth;
                                                var containerWidth = 0.8 * accordionWidth;
                                                var calculatedHeight = containerWidth * screenRatio;

                                                new rrwebPlayer({
                                                    target: target,
                                                    props: {
                                                        events: events,
                                                        autoPlay: false,
                                                        width: containerWidth,
                                                        height: calculatedHeight,
                                                        UNSAFE_replayCanvas: true,
                                                    },
                                                });
                                            })();
                                        </script>
                                    </div>
                                    {% endfor %}
                                    <div class="text-center mt-3">
                                        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                            Fold
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="query-form" action="" method="post">
                        {% csrf_token %}
                        <div class="mb-4 p-3 border rounded">
                            <h5><i class="bi bi-question-circle-fill me-2"></i><strong>Question</strong></h5>
                             <div class="p-3 bg-light rounded loaded-box">
                                 <div class="question-text">
                                     {{ question }}
                                 </div>
                             </div>                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>1. Your Answer</strong></h5>
                            <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
                            <div class="invalid-feedback">Please provide your answer.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>2. Confidence</strong></h5>
                            <p>How confident are you in your answer?</p>
                            <div class="btn-group" role="group" aria-label="Confidence">
                                {% for value, text in confidence_choices %}
                                <input type="radio" class="btn-check" name="confidence_radio" id="c{{ forloop.counter }}" value="{{ value }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="c{{ forloop.counter }}">
                                    <strong>{{ value }}</strong><br>{{ text|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="confidence" id="confidence_hidden" required>
                            <div class="invalid-feedback">Please select your confidence level.</div>
                        </div>

                        <div id="source-container" class="mb-4 p-3 border rounded">
                            <h5><strong>3. Justification</strong></h5>
                            <p>Please provide at least one source URL and the relevant text from that source.</p>
                            <div class="source-entry card p-3 mb-2">
                                <div class="form-floating mb-2">
                                    <input type="url" class="form-control" name="source_url_0" required placeholder="Source URL">
                                    <label>Source URL</label>
                                    <div class="invalid-feedback">Please provide a source URL.</div>
                                </div>
                                <div class="form-floating">
                                    <textarea class="form-control" name="source_text_0" rows="3" required placeholder="Source Text"></textarea>
                                    <label>Source Text</label>
                                    <div class="invalid-feedback">Please provide the source text.</div>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm remove-source mt-2 align-self-end" style="display: none;">Remove</button>
                            </div>
                        </div>
                        <button type="button" id="add-source" class="btn btn-outline-success btn-sm mb-3"><i class="bi bi-plus-circle-fill me-2"></i>Add Another Source</button>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>4. Reasoning Method</strong></h5>
                            <p> Which reasoning method did you primarily use to arrive at your answer?</p>
                            <div class="w-100" role="group" aria-label="Reasoning Method">
                                {% for value, text in reasoning_choices %}
                                <div class="d-flex mb-2">
                                    <input type="radio" class="btn-check" name="reasoning_method" id="rm{{ forloop.counter }}" value="{{ value }}" autocomplete="off" required>
                                    <label class="btn btn-outline-primary {% if value != 'other' %}w-100{% endif %} text-start" for="rm{{ forloop.counter }}">{{ text }}</label>
                                    {% if value == 'other' %}
                                    <input type="text" class="form-control form-control-sm ms-2" name="reasoning_method_other" placeholder="Please specify..." disabled>
                                    <div class="invalid-feedback">Please specify your "Other" reasoning method.</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select a reasoning method.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>5. (Optional) Additional Explanation</strong></h5>
                            <textarea class="form-control" id="additional_explanation" name="additional_explanation" rows="3"></textarea>
                        </div>
                    </form>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" id="cancel-btn" class="btn btn-secondary btn-lg">Cancel</button>
                        <button type="button" id="query-btn" class="btn btn-primary btn-lg btn-submit">Submit Answer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confidence Radio Buttons
    document.querySelectorAll('input[name="confidence_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('confidence_hidden').value = this.value;
        });
    });

    // Add/Remove Sources
    document.getElementById('add-source').addEventListener('click', function() {
        const container = document.getElementById('source-container');
        const count = container.getElementsByClassName('source-entry').length;
        const newSource = document.createElement('div');
        newSource.className = 'source-entry card p-3 mb-2';
        newSource.innerHTML = `
            <div class="form-floating mb-2">
                <input type="url" class="form-control" name="source_url_${count}" required placeholder="Source URL">
                <label>Source URL</label>
            </div>
            <div class="form-floating">
                <textarea class="form-control" name="source_text_${count}" rows="3" required placeholder="Source Text"></textarea>
                <label>Source Text</label>
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-source mt-2 align-self-end">Remove</button>`;
        container.appendChild(newSource);
        updateRemoveButtons();
    });

    document.getElementById('source-container').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-source')) {
            e.target.closest('.source-entry').remove();
            reindexSources();
            updateRemoveButtons();
        }
    });

    function reindexSources() {
        const entries = document.getElementsByClassName('source-entry');
        Array.from(entries).forEach((entry, i) => {
            entry.querySelector('input[type="url"]').name = `source_url_${i}`;
            entry.querySelector('textarea').name = `source_text_${i}`;
        });
    }

    function updateRemoveButtons() {
        const buttons = document.getElementsByClassName('remove-source');
        const display = buttons.length > 1 ? 'block' : 'none';
        Array.from(buttons).forEach(btn => btn.style.display = display);
    }

    // Reasoning Method Other
    document.querySelectorAll('input[name="reasoning_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const otherInput = document.querySelector('input[name="reasoning_method_other"]');
            if (otherInput) {
                otherInput.disabled = this.value !== 'other';
            }
        });
    });

    // Form Submission
    let is_submitted = false;
    document.getElementById('query-btn').addEventListener('click', function() {
        // Reset validation states
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        let isValid = true;

        // Validation for answer
        const answer = document.getElementById('answer');
        if (answer.value.trim() === '') {
            answer.classList.add('is-invalid');
            answer.focus();
            isValid = false;
        }

        // Validation for confidence
        const confidence = document.getElementById('confidence_hidden');
        if (confidence.value === '') {
            document.querySelector('.btn-group[aria-label="Confidence"]').classList.add('is-invalid');
            isValid = false;
        }

        // Validation for justification
        const sourceUrl = document.querySelector('input[name="source_url_0"]');
        const sourceText = document.querySelector('textarea[name="source_text_0"]');
        if (sourceUrl.value.trim() === '') {
            sourceUrl.classList.add('is-invalid');
            isValid = false;
        }
        if (sourceText.value.trim() === '') {
            sourceText.classList.add('is-invalid');
            isValid = false;
        }

        // Validation for reasoning method
        const reasoningMethod = document.querySelector('input[name="reasoning_method"]:checked');
        const reasoningMethodOther = document.querySelector('input[name="reasoning_method_other"]');
        if (!reasoningMethod) {
            document.querySelector('.w-100[aria-label="Reasoning Method"]').classList.add('is-invalid');
            isValid = false;
        } else if (reasoningMethod.value === 'other' && reasoningMethodOther.value.trim() === '') {
            reasoningMethodOther.classList.add('is-invalid');
            reasoningMethodOther.focus();
            isValid = false;
        }

        if (!isValid) {
            return;
        }

        if (confirm("Are you sure you want to submit your answer?")) {
            is_submitted = true;
            document.getElementById('query-form').submit();
        }
    });

    // Clear validation on input
    document.getElementById('answer').addEventListener('input', () => {
        document.getElementById('answer').classList.remove('is-invalid');
    });
    document.querySelectorAll('input[name="confidence_radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelector('.btn-group[aria-label="Confidence"]').classList.remove('is-invalid');
        });
    });
    document.querySelector('input[name="source_url_0"]').addEventListener('input', () => {
        document.querySelector('input[name="source_url_0"]').classList.remove('is-invalid');
    });
    document.querySelector('textarea[name="source_text_0"]').addEventListener('input', () => {
        document.querySelector('textarea[name="source_text_0"]').classList.remove('is-invalid');
    });
    document.querySelectorAll('input[name="reasoning_method"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelector('.w-100[aria-label="Reasoning Method"]').classList.remove('is-invalid');
            const reasoningMethodOther = document.querySelector('input[name="reasoning_method_other"]');
            if (reasoningMethodOther) {
                reasoningMethodOther.classList.remove('is-invalid');
            }
        });
    });
    const reasoningMethodOtherInput = document.querySelector('input[name="reasoning_method_other"]');
    if (reasoningMethodOtherInput) {
        reasoningMethodOtherInput.addEventListener('input', () => {
            reasoningMethodOtherInput.classList.remove('is-invalid');
        });
    }

    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (confirm("Are you sure you want to cancel? This will close the window.")) {
            window.close();
        }
    });

    window.addEventListener('beforeunload', function() {
        if (!is_submitted) {
            navigator.sendBeacon('/task/stop_annotation/', new Blob());
        }
    });

    updateRemoveButtons();

    var trajectoriesCollapse = document.getElementById('collapseTrajectories');
    if (trajectoriesCollapse) {
        trajectoriesCollapse.addEventListener('shown.bs.collapse', function () {
            window.dispatchEvent(new Event('resize'));
        });
    }
});
</script>
{% endblock %}
