{% extends "base.html" %}
{% load task_manager_extras %}
{% block title %}Answer Submission{% endblock %}

{% block head %}
<style>
    .justification-item.abandoned {
        opacity: 0.6;
    }
    .justification-item.abandoned blockquote {
        text-decoration: line-through;
    }
    .justification-item.is-invalid {
        border: 1px solid #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-lg mt-5">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="card-title mb-0">Trial {{ num_trial }} Submission</h2>
                </div>
                <div class="card-body p-5" id="card-body">
                    <div class="accordion mb-4" id="trajectoriesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                    <i class="bi bi-signpost-split-fill me-2"></i> <strong>View Trajectories</strong>&nbsp;(Click to expand)
                                </button>
                            </h2>
                            <div id="collapseTrajectories" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#trajectoriesAccordion">
                                <div class="accordion-body">
                                    {% for webpage in webpages %}
                                    <div class="d-flex flex-column align-items-center mb-5 p-4 border rounded shadow-sm bg-light">
                                        <p class="h5"><a href="{{ webpage.url }}" target="_blank">{{ webpage.title }}</a></p>
                                        <div class="rrweb-player-wrapper" id="rrweb-player-{{ webpage.id }}" style="margin-top: 20px;"></div>
                                        <script>
                                            (function() {
                                                var target = document.getElementById('rrweb-player-{{ webpage.id }}');
                                                var events = {{ webpage.rrweb_record|safe }};
                                                
                                                if (!Array.isArray(events) || events.length === 0) {
                                                    return;
                                                }

                                                // Get screen width and height ratio
                                                var screenRatio = window.innerHeight / window.innerWidth;

                                                var accordionWidth = document.querySelector('#card-body').clientWidth;
                                                var containerWidth = 0.8 * accordionWidth;
                                                var calculatedHeight = containerWidth * screenRatio;

                                                new rrwebPlayer({
                                                    target: target,
                                                    props: {
                                                        events: events,
                                                        autoPlay: false,
                                                        width: containerWidth,
                                                        height: calculatedHeight,
                                                        UNSAFE_replayCanvas: true,
                                                    },
                                                });
                                            })();
                                        </script>
                                    </div>
                                    {% endfor %}
                                    <div class="text-center mt-3">
                                        <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrajectories" aria-expanded="false" aria-controls="collapseTrajectories">
                                            Fold
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="query-form" action="" method="post">
                        {% csrf_token %}
                        <div class="mb-4 p-3 border rounded">
                            <h5><i class="bi bi-question-circle-fill me-2"></i><strong>Question</strong></h5>
                             <div class="p-3 bg-light rounded loaded-box">
                                 <div class="question-text">
                                     {{ question }}
                                 </div>
                             </div>                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>1. Your Answer</strong></h5>
                            <textarea class="form-control" id="answer" name="answer" rows="3" required></textarea>
                            <div class="invalid-feedback">Please provide your answer.</div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>2. Confidence</strong></h5>
                            <p>How confident are you in your answer?</p>
                            <div class="btn-group" role="group" aria-label="Confidence">
                                {% for value, text in confidence_choices %}
                                <input type="radio" class="btn-check" name="confidence_radio" id="c{{ forloop.counter }}" value="{{ value }}" autocomplete="off" required>
                                <label class="btn btn-outline-primary" for="c{{ forloop.counter }}">
                                    <strong>{{ value }}</strong><br>{{ text|split:" - "|slice:"1:"|join:" - " }}
                                </label>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="confidence" id="confidence_hidden" required>
                            <div class="invalid-feedback">Please select your confidence level.</div>
                        </div>

                        <div id="justification-container" class="mb-4 p-3 border rounded">
                            <h5><strong>3. Justifications</strong></h5>
                            <p>Use the right-click menu on any webpage to add a justification.</p>
                            
                            <div class="accordion" id="text-evidence-accordion" style="display: none;">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="text-evidence-heading">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-text-evidence" aria-expanded="true" aria-controls="collapse-text-evidence">
                                            Textual Evidence
                                        </button>
                                    </h2>
                                    <div id="collapse-text-evidence" class="accordion-collapse collapse show" aria-labelledby="text-evidence-heading" data-bs-parent="#text-evidence-accordion">
                                        <div class="accordion-body" id="text-justification-list">
                                            <!-- Text justifications will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                                                            <div class="accordion mt-3" id="element-evidence-accordion" style="display: none;">
                                                            <div class="accordion-item">
                                                                <h2 class="accordion-header" id="element-evidence-heading">
                                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-element-evidence" aria-expanded="false" aria-controls="collapse-element-evidence">
                                                                        Other Evidence
                                                                    </button>
                                                                </h2>
                                                                <div id="collapse-element-evidence" class="accordion-collapse collapse" aria-labelledby="element-evidence-heading" data-bs-parent="#element-evidence-accordion">
                                                                    <div class="accordion-body" id="element-justification-list">
                                                                        <!-- Element justifications will be loaded here -->
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                            <div class="accordion mt-3" id="abandoned-accordion" style="display: none;">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="abandoned-heading">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-abandoned" aria-expanded="false" aria-controls="collapse-abandoned">
                                            Abandoned Justifications
                                        </button>
                                    </h2>
                                    <div id="collapse-abandoned" class="accordion-collapse collapse" aria-labelledby="abandoned-heading" data-bs-parent="#abandoned-accordion">
                                        <div class="accordion-body" id="abandoned-justification-list">
                                            <!-- Abandoned justifications will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 p-3 border rounded">
                            <h5><strong>4. Answer Formulation Method</strong></h5>
                            <p> Which method did you primarily use to formulate your answer?</p>
                            <div class="w-100" role="group" aria-label="Answer Formulation Method">
                                {% for value, text in answer_formulation_choices %}
                                <div class="d-flex mb-2">
                                    <input type="radio" class="btn-check" name="answer_formulation_method" id="afm{{ forloop.counter }}" value="{{ value }}" autocomplete="off" required>
                                    <label class="btn btn-outline-primary {% if value != 'other' %}w-100{% endif %} text-start" for="afm{{ forloop.counter }}">{{ text|safe }}</label>
                                    {% if value == 'other' %}
                                    <input type="text" class="form-control form-control-sm ms-2" name="answer_formulation_method_other" placeholder="Please specify..." disabled>
                                    <div class="invalid-feedback">Please specify your "Other" method.</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="invalid-feedback">Please select a method.</div>
                        </div>

                    </form>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" id="cancel-btn" class="btn btn-secondary btn-lg">Cancel</button>
                        <button type="button" id="query-btn" class="btn btn-primary btn-lg btn-submit">Submit Answer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confidence Radio Buttons
    document.querySelectorAll('input[name="confidence_radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('confidence_hidden').value = this.value;
        });
    });

    // Justification fetching and rendering
    const justificationList = document.getElementById('justification-list');
    const taskId = {{ task_id }};

    async function fetchJustifications() {
        try {
            const response = await fetch(`/task/justification/get/${taskId}/`);
            const data = await response.json();
            renderJustifications(data.justifications);
        } catch (error) {
            console.error('Error fetching justifications:', error);
        }
    }

    function renderJustifications(justifications) {
        const textList = document.getElementById('text-justification-list');
        const elementList = document.getElementById('element-justification-list');
        const abandonedList = document.getElementById('abandoned-justification-list');
        
        const textAccordion = document.getElementById('text-evidence-accordion');
        const elementAccordion = document.getElementById('element-evidence-accordion');
        const abandonedAccordion = document.getElementById('abandoned-accordion');

        // Clear all lists
        textList.innerHTML = '';
        elementList.innerHTML = '';
        abandonedList.innerHTML = '';

        const activeJustifications = justifications.filter(j => j.status === 'active');
        const textJustifications = activeJustifications.filter(j => j.evidence_type === 'text_selection');
        const elementJustifications = activeJustifications.filter(j => j.evidence_type === 'element');
        const abandonedJustifications = justifications.filter(j => j.status === 'abandoned');

        // Populate Textual Evidence
        if (textJustifications.length > 0) {
            textAccordion.style.display = 'block';
            textJustifications.forEach(j => textList.appendChild(createJustificationElement(j)));
        } else {
            textAccordion.style.display = 'none';
        }

        // Populate Other Evidence
        if (elementJustifications.length > 0) {
            elementAccordion.style.display = 'block';
            elementJustifications.forEach(j => elementList.appendChild(createJustificationElement(j)));
        } else {
            elementAccordion.style.display = 'none';
        }

        // Populate Abandoned Justifications
        if (abandonedJustifications.length > 0) {
            abandonedAccordion.style.display = 'block';
            abandonedJustifications.forEach(j => abandonedList.appendChild(createJustificationElement(j)));
        } else {
            abandonedAccordion.style.display = 'none';
        }
    }

    function createJustificationElement(j) {
        const justificationEl = document.createElement('div');
        justificationEl.className = `card p-3 mb-2 justification-item ${j.status === 'abandoned' ? 'abandoned' : ''}`;
        justificationEl.dataset.id = j.id;

        // Ensure element_details is an object
        if (typeof j.element_details === 'string') {
            try {
                j.element_details = JSON.parse(j.element_details);
            } catch (e) {
                console.error("Failed to parse element_details:", e);
                j.element_details = null;
            }
        }

        let contentHtml = '';
        if (j.evidence_type === 'element' && j.element_details) {
            const tagName = j.element_details.tagName || 'Element';
            contentHtml = `<p class="mb-1"><strong>Evidence:</strong> [${tagName.toUpperCase()}]</p>`;
        } else {
            contentHtml = `<blockquote class="blockquote bg-light p-2 rounded" style="font-size: 0.9rem;">${j.text || ''}</blockquote>`;
        }

        let relevanceHtml = '';
        if (j.status !== 'abandoned' && j.evidence_type === 'text_selection') {
            relevanceHtml = `
                <div class="relevance-annotation d-flex align-items-center">
                    <div>
                        <strong>Relevance:</strong>
                        <div class="btn-group ms-2" role="group" aria-label="Relevance">
                            <input type="radio" class="btn-check" name="relevance_${j.id}" id="relevance_low_${j.id}" value="1" ${j.relevance == 1 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="relevance_low_${j.id}">Low</label>

                            <input type="radio" class="btn-check" name="relevance_${j.id}" id="relevance_medium_${j.id}" value="2" ${j.relevance == 2 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="relevance_medium_${j.id}">Medium</label>

                            <input type="radio" class="btn-check" name="relevance_${j.id}" id="relevance_high_${j.id}" value="3" ${j.relevance == 3 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="relevance_high_${j.id}">High</label>
                        </div>
                    </div>
                    <div class="ms-4">
                        <strong>Credibility:</strong>
                        <div class="btn-group ms-2" role="group" aria-label="Credibility">
                            <input type="radio" class="btn-check" name="credibility_${j.id}" id="credibility_low_${j.id}" value="1" ${j.credibility == 1 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="credibility_low_${j.id}">Low</label>

                            <input type="radio" class="btn-check" name="credibility_${j.id}" id="credibility_medium_${j.id}" value="2" ${j.credibility == 2 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="credibility_medium_${j.id}">Medium</label>

                            <input type="radio" class="btn-check" name="credibility_${j.id}" id="credibility_high_${j.id}" value="3" ${j.credibility == 3 ? 'checked' : ''} autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="credibility_high_${j.id}">High</label>
                        </div>
                    </div>
                </div>
            `;
        }

        const buttonsHtml = `
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger btn-abandon" style="${j.status === 'abandoned' ? 'display:none;' : ''}">Abandon</button>
                <button type="button" class="btn btn-sm btn-outline-success btn-recover" style="${j.status !== 'abandoned' ? 'display:none;' : ''}">Recover</button>
            </div>
        `;

        justificationEl.innerHTML = `
            <p class="mb-1"><strong>Title:</strong> ${j.page_title || 'No title found'}</p>
            <p class="mb-1"><strong>URL:</strong> <a href="${j.url}" target="_blank">${j.url}</a></p>
            ${contentHtml}
            <div class="d-flex justify-content-between align-items-center mt-3">
                ${relevanceHtml}
                ${buttonsHtml}
            </div>
        `;
        return justificationEl;
    }

    const justificationContainer = document.getElementById('justification-container');

    async function updateJustificationStatus(id, status) {
        try {
            await fetch(`/task/justification/update/${id}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status: status })
            });
            fetchJustifications(); // Re-fetch to update the UI
        } catch (error) {
            console.error('Error updating justification status:', error);
        }
    }

    justificationContainer.addEventListener('click', function(e) {
        const target = e.target;
        const justificationItem = target.closest('.justification-item');
        if (!justificationItem) return;

        const justificationId = justificationItem.dataset.id;
        if (target.classList.contains('btn-abandon')) {
            updateJustificationStatus(justificationId, 'abandoned');
        } else if (target.classList.contains('btn-recover')) {
            updateJustificationStatus(justificationId, 'active');
        }
    });


    // Initial fetch
    fetchJustifications();

    // Reasoning Method Other
    document.querySelectorAll('input[name="answer_formulation_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const otherInput = document.querySelector('input[name="answer_formulation_method_other"]');
            if (otherInput) {
                otherInput.disabled = this.value !== 'other';
            }
        });
    });

    justificationContainer.addEventListener('change', function(e) {
        if (e.target.type === 'radio' && e.target.name.startsWith('relevance_')) {
            const justificationItem = e.target.closest('.justification-item');
            if (justificationItem) {
                justificationItem.classList.remove('is-invalid');
            }
        }
    });

    // Form Submission
    let is_submitted = false;
    document.getElementById('query-btn').addEventListener('click', function() {
        // Reset validation states
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        let isValid = true;

        // Validation for answer
        const answer = document.getElementById('answer');
        if (answer.value.trim() === '') {
            answer.classList.add('is-invalid');
            answer.focus();
            isValid = false;
        }

        // Validation for confidence
        const confidence = document.getElementById('confidence_hidden');
        if (confidence.value === '') {
            document.querySelector('.btn-group[aria-label="Confidence"]').classList.add('is-invalid');
            isValid = false;
        }

        // Validation for answer formulation method
        const answerFormulationMethod = document.querySelector('input[name="answer_formulation_method"]:checked');
        const answerFormulationMethodOther = document.querySelector('input[name="answer_formulation_method_other"]');
        if (!answerFormulationMethod) {
            document.querySelector('.w-100[aria-label="Answer Formulation Method"]').classList.add('is-invalid');
            isValid = false;
        } else if (answerFormulationMethod.value === 'other' && answerFormulationMethodOther.value.trim() === '') {
            answerFormulationMethodOther.classList.add('is-invalid');
            answerFormulationMethodOther.focus();
            isValid = false;
        }

        // Validation for textual evidence relevance
        const textJustifications = document.querySelectorAll('#text-justification-list .justification-item');
        textJustifications.forEach(item => {
            const justificationId = item.dataset.id;
            const relevanceSelection = item.querySelector(`input[name="relevance_${justificationId}"]:checked`);
            if (!relevanceSelection) {
                item.classList.add('is-invalid');
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                isValid = false;
            }
            const credibilitySelection = item.querySelector(`input[name="credibility_${justificationId}"]:checked`);
            if (!credibilitySelection) {
                item.classList.add('is-invalid');
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                isValid = false;
            }
        });

        if (!isValid) {
            return;
        }

        if (confirm("Are you sure you want to submit your answer?")) {
            is_submitted = true;
            // Disable button and show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
            document.getElementById('query-form').submit();
        }
    });

    // Clear validation on input
    document.getElementById('answer').addEventListener('input', () => {
        document.getElementById('answer').classList.remove('is-invalid');
    });
    document.querySelectorAll('input[name="confidence_radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelector('.btn-group[aria-label="Confidence"]').classList.remove('is-invalid');
        });
    });
    document.querySelectorAll('input[name="answer_formulation_method"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.querySelector('.w-100[aria-label="Answer Formulation Method"]').classList.remove('is-invalid');
            const answerFormulationMethodOther = document.querySelector('input[name="answer_formulation_method_other"]');
            if (answerFormulationMethodOther) {
                answerFormulationMethodOther.classList.remove('is-invalid');
            }
        });
    });
    const answerFormulationMethodOtherInput = document.querySelector('input[name="answer_formulation_method_other"]');
    if (answerFormulationMethodOtherInput) {
        answerFormulationMethodOtherInput.addEventListener('input', () => {
            answerFormulationMethodOtherInput.classList.remove('is-invalid');
        });
    }

    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (confirm("Are you sure you want to cancel? This will close the window.")) {
            window.close();
        }
    });

    window.addEventListener('beforeunload', function() {
        if (!is_submitted) {
            navigator.sendBeacon('/task/stop_annotation/', new Blob());
        }
    });

    updateRemoveButtons();

    var trajectoriesCollapse = document.getElementById('collapseTrajectories');
    if (trajectoriesCollapse) {
        trajectoriesCollapse.addEventListener('shown.bs.collapse', function () {
            window.dispatchEvent(new Event('resize'));
        });
    }

    // Listen for messages from the background script
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
        if (message.command === "add_justification") {
            const container = document.getElementById('source-container');
            const firstEntry = container.querySelector('.source-entry');
            const firstUrlInput = firstEntry.querySelector('input[type="url"]');
            const firstTextInput = firstEntry.querySelector('textarea');

            // If the first justification is empty, use it
            if (firstUrlInput.value.trim() === '' && firstTextInput.value.trim() === '') {
                firstUrlInput.value = message.url;
                firstTextInput.value = message.text;
            } else {
                // Otherwise, add a new one
                document.getElementById('add-source').click();
                const newEntry = container.querySelector('.source-entry:last-child');
                newEntry.querySelector('input[type="url"]').value = message.url;
                newEntry.querySelector('textarea').value = message.text;
            }
            
            // Bring the window to the front
            window.focus();
        }
    });
});
</script>
{% endblock %}
