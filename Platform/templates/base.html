{% load static %}
{% load msg_system_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}THUIR Annotation Platform{% endblock %}</title>
    <link rel="icon" href="{% static 'img/THUIR32.png' %}" type="image/png"/>

    <!-- Font Awesome -->
    <link href="{% static 'css/vendor/fontawesome.min.css' %}" rel="stylesheet">

    <!-- Modern Bootstrap 5 -->
    <link href="{% static 'css/vendor/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/vendor/easymde.min.css' %}" rel="stylesheet">
    
    <!-- Google Fonts Alternative (Noto Sans) -->
    <link href="{% static 'css/vendor/noto-sans.css' %}" rel="stylesheet">

    <!-- Chart.js -->
    <script src="{% static 'js/vendor/chart.js' %}"></script>
    <script src="{% static 'js/vendor/chartjs-chart-boxplot.js' %}"></script>

    <!-- Plotly.js -->
    <script src="{% static 'js/vendor/plotly.min.js' %}"></script>

    <!-- CSS Variables and Utilities -->
    <link href="{% static 'css/_variables.css' %}" rel="stylesheet">
    <link href="{% static 'css/_utilities.css' %}" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{% static 'css/custom.css' %}" rel="stylesheet">
    <link href="{% static 'css/responsive.css' %}" rel="stylesheet">
    <link href="{% static 'css/vendor/bootstrap-icons.css' %}" rel="stylesheet">
    <link href="{% static 'css/rrweb-player.css' %}" rel="stylesheet"/>
    <link id="dark-mode-stylesheet" href="{% static 'css/dark.css' %}" rel="stylesheet" disabled>

    <!-- Bootstrap 5 JS -->
    <script src="{% static 'js/vendor/bootstrap.bundle.min.js' %}"></script>
    
    <!-- jQuery -->
    <script src="{% static 'js/vendor/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/vendor/jquery-ui.min.js' %}"></script>

    <script>
        // Apply settings immediately to prevent flickering
        (function() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.documentElement.classList.add('dark-mode');
                document.getElementById('dark-mode-stylesheet').disabled = false;
            }
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                document.documentElement.style.fontSize = savedFontSize + 'px';
            }
        })();
    </script>


    <!-- rrweb-player.js -->
    <script src="{% static 'js/vendor/rrweb-player.umd.min.cjs' %}"></script>

    {% block css %}{% endblock %}
    {% block head %}{% endblock %}
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark">
            <div class="sidebar-header">
                <h2>
                    <div class="flex-between">
                        <img src="{% static 'img/IR4.png' %}" alt="Logo" class="icon-sq-40">
                        <span class="header-text">THUIR</span>
                    </div>
                    <div class="text-end header-text">
                        Annotation
                    </div>
                    <div class="text-end header-text">
                        Platform
                    </div>
                </h2>
            </div>

            <hr class="sidebar-divider">

            <ul class="list-unstyled components">
                <li class="active">
                    <a href="/"><i class="bi bi-house-door-fill"></i> Home</a>
                </li>
                <li>
                    <a href="/user/info"><i class="bi bi-person-circle"></i> User Info</a>
                </li>
                <li>
                    <a href="{% url 'discussion_home' %}"><i class="bi bi-github"></i> Discussion</a>
                </li>
                <li>
                    <a href="{% url 'msg_system:message_list' %}"><i class="bi bi-envelope-fill"></i> Messages {% unread_message_count %}</a>
                </li>
                {% if user.is_superuser %}
                <li>
                    <a href="{% url 'dashboard:index' %}"><i class="bi bi-person-badge-fill"></i> Dashboard</a>
                </li>
                {% endif %}
                {% if request.session.original_user_token %}
                <li>
                    <form id="return-to-admin-form" action="{% url 'dashboard:return_to_admin' %}" method="post" class="d-none">
                        {% csrf_token %}
                    </form>
                    <a href="#" onclick="event.preventDefault(); document.getElementById('return-to-admin-form').submit();">
                        <i class="bi bi-box-arrow-in-left"></i> Return to Admin
                    </a>
                </li>
                {% endif %}
                {% if user.is_authenticated %}
                <li>
                    <a href="{% url 'user_system:logout' %}" onclick="return confirm('Are you sure you want to log out?');"><i class="bi bi-box-arrow-right"></i> Log out</a>
                </li>
                {% else %}
                <li>
                    <a href="{% url 'user_system:login' %}"><i class="bi bi-box-arrow-in-right"></i> Log in</a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <div id="sidebar-backdrop"></div>
        <!-- Page Content -->
        <div id="content">
            <header class="sticky-top">
                <nav class="navbar navbar-light bg-light custom-navbar">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center w-100 justify-content-between">
                            <div class="d-flex align-items-center">
                                <button type="button" id="sidebarCollapse">
                                    <span class="sidebar-toggle-text">Toggle Sidebar</span>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div class="navbar-center-content d-flex justify-content-center">
                                {% block navbar_extra %}{% endblock %}
                            </div>
                            <div class="d-flex align-items-center">
                                {% block navbar_right %}{% endblock %}
                                <div class="dropdown me-2">
                                    <button type="button" id="messageDropdown" class="btn btn-light" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-envelope-fill"></i> {% unread_message_count %}
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="messageDropdown">
                                        <div id="message-popover-content">
                                            {% message_popover %}
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-center text-primary" href="{% url 'msg_system:message_list' %}"><strong>View All Messages</strong></a>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button type="button" id="pageSettingsDropdown" class="btn btn-light" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-gear-fill"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end page-settings-dropdown-menu" aria-labelledby="pageSettingsDropdown">
                                        <div class="px-3 py-1">
                                            <label class="form-label d-flex align-items-center pb-1"><i class="bi bi-fonts me-2"></i>Font Size</label>
                                            <div class="btn-group font-size-controls" role="group" aria-label="Font size controls">
                                                <button id="decrease-font" class="btn btn-sm btn-outline-secondary"><i class="bi bi-zoom-out"></i></button>
                                                <button id="increase-font" class="btn btn-sm btn-outline-secondary"><i class="bi bi-zoom-in"></i></button>
                                                <button id="restore-font" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i></button>
                                            </div>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <div class="px-3 py-1">
                                            <label class="form-label d-flex align-items-center"><i class="bi bi-palette-fill me-2 pb-1"></i>Theme</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                                                <label class="form-check-label" for="darkModeSwitch">
                                                    <span class="light-mode-elements">
                                                        <i class="bi bi-sun-fill px-2"></i><span class="mode-text"> Light Mode</span>
                                                    </span>
                                                    <span class="dark-mode-elements">
                                                        <i class="bi bi-moon-fill px-2"></i><span class="mode-text"> Dark Mode</span>
                                                    </span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <div class="px-3 py-1">
                                            <button id="clear-settings" class="btn btn-sm btn-danger w-100"><i class="bi bi-trash-fill me-2"></i>Clear Cached Settings</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>

            <main class="container-fluid">
                {% block content %}
                {% endblock %}
            </main>

            <footer class="footer mt-auto py-3 bg-light">
                <div class="container text-center">
                    <span class="text-muted">&copy; 2025 THUIR. All Rights Reserved.</span>
                </div>
            </footer>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
                $(this).find('i').toggleClass('bi-chevron-right bi-chevron-left');
            });

            $('#sidebar-backdrop').on('click', function () {
                $('#sidebarCollapse').trigger('click');
            });

            // Listener for when an alert is about to be closed
            $(document).on('close.bs.alert', '.alert', function() {
                var $alert = $(this);
                var $messageCard = $alert.closest('.message-card');

                // Check if this is the last alert in the card
                if ($messageCard.length && $messageCard.find('.alert').length === 1) {
                    // When the alert's fade out transition ends, remove the whole card
                    $alert.on('transitionend', function () {
                        $messageCard.remove();
                    });
                }
            });

            // Dark Mode Switcher
            const darkModeSwitch = document.getElementById('darkModeSwitch');
            const rootElement = document.documentElement;

            // Set the switch to the correct state on page load
            if (localStorage.getItem('darkMode') === 'enabled') {
                darkModeSwitch.checked = true;
                document.getElementById('dark-mode-stylesheet').disabled = false;
            }

            darkModeSwitch.addEventListener('change', () => {
                if (darkModeSwitch.checked) {
                    rootElement.classList.add('dark-mode');
                    document.getElementById('dark-mode-stylesheet').disabled = false;
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    rootElement.classList.remove('dark-mode');
                    document.getElementById('dark-mode-stylesheet').disabled = true;
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // Font Size Adjuster
            const increaseFontButton = document.getElementById('increase-font');
            const decreaseFontButton = document.getElementById('decrease-font');
            const restoreFontButton = document.getElementById('restore-font');
            const body = document.body;
            const defaultFontSize = 16;

            function checkFontSize() {
                const currentFontSize = parseFloat(window.getComputedStyle(document.documentElement, null).getPropertyValue('font-size'));
                if (currentFontSize > 20) { // Threshold for "too large"
                    document.documentElement.classList.add('font-size-large');
                } else {
                    document.documentElement.classList.remove('font-size-large');
                }
            }

            // Clear Settings Button
            const clearSettingsButton = document.getElementById('clear-settings');

            clearSettingsButton.addEventListener('click', (event) => {
                event.stopPropagation();
                if (confirm('Are you sure you want to clear all cached settings and restore defaults?')) {
                    localStorage.clear();
                    window.location.reload();
                }
            });

            // Function to initialize all settings from localStorage on page load
            function initializeSettings() {
                // Font Size
                const savedFontSize = localStorage.getItem('fontSize');
                if (savedFontSize) {
                    document.documentElement.style.fontSize = savedFontSize + 'px';
                }
                checkFontSize();

                // Dark Mode
                if (localStorage.getItem('darkMode') === 'enabled') {
                    darkModeSwitch.checked = true;
                    rootElement.classList.add('dark-mode');
                    document.getElementById('dark-mode-stylesheet').disabled = false;
                }
            }

            // Initialize all settings when the document is ready
            initializeSettings();

            increaseFontButton.addEventListener('click', (event) => {
                event.stopPropagation();
                changeFontSize(1);
            });

            decreaseFontButton.addEventListener('click', (event) => {
                event.stopPropagation();
                changeFontSize(-1);
            });

            restoreFontButton.addEventListener('click', (event) => {
                event.stopPropagation();
                document.documentElement.style.fontSize = defaultFontSize + 'px';
                localStorage.removeItem('fontSize');
            });

            function changeFontSize(step) {
                const currentFontSize = parseFloat(window.getComputedStyle(document.documentElement, null).getPropertyValue('font-size'));
                const newSize = currentFontSize + step;
                document.documentElement.style.fontSize = newSize + 'px';
                localStorage.setItem('fontSize', newSize);
                checkFontSize();
            }

            // Handle floating labels for select elements
            function updateUserInterface() {
                document.querySelectorAll('.form-select').forEach(function(select) {
                    if (select.value) {
                        select.classList.add('has-value');
                    } else {
                        select.classList.remove('has-value');
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', updateUserInterface);

            document.querySelectorAll('.form-select').forEach(function(select) {
                select.addEventListener('change', function() {
                    if (this.value) {
                        this.classList.add('has-value');
                    } else {
                        this.classList.remove('has-value');
                    }
                });
            });

            // Page Settings Dropdown Icon Toggle
            const pageSettingsDropdown = document.getElementById('pageSettingsDropdown');
            if (pageSettingsDropdown) {
                pageSettingsDropdown.addEventListener('show.bs.dropdown', function () {
                    this.querySelector('i').classList.replace('bi-chevron-down', 'bi-chevron-up');
                });
                pageSettingsDropdown.addEventListener('hide.bs.dropdown', function () {
                    this.querySelector('i').classList.replace('bi-chevron-up', 'bi-chevron-down');
                });
            }

            // Message Dropdown Hover
            const messageDropdown = document.getElementById('messageDropdown');
            if(messageDropdown) {
                const dropdownMenu = messageDropdown.nextElementSibling;
                let timeout;

                messageDropdown.addEventListener('mouseenter', function () {
                    clearTimeout(timeout);
                    new bootstrap.Dropdown(messageDropdown).show();
                });

                messageDropdown.addEventListener('mouseleave', function () {
                    timeout = setTimeout(() => {
                        if (!dropdownMenu.matches(':hover')) {
                            new bootstrap.Dropdown(messageDropdown).hide();
                        }
                    }, 200);
                });

                dropdownMenu.addEventListener('mouseleave', function () {
                    timeout = setTimeout(() => {
                        new bootstrap.Dropdown(messageDropdown).hide();
                    }, 200);
                });

                dropdownMenu.addEventListener('mouseenter', function () {
                    clearTimeout(timeout);
                });
            }
        });

        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>

    
    <script src="{% static 'js/vendor/easymde.min.js' %}"></script>
    <script src="{% static 'js/easymde_config.js' %}"></script>
    <script src="{% static 'js/captcha_refresh.js' %}"></script>
    {% block scripts %}{% endblock %}

    <!-- Image Preview Modal -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imagePreviewModalLabel">Image Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" class="img-fluid" alt="Image Preview">
                </div>
            </div>
        </div>
    </div>

    {% block modal_container %}{% endblock %}
</body>
</html>