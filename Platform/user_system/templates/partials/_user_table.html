{% load query_extras %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th scope="col">#</th>
                <th scope="col">
                    <a href="?{% url_replace user_sort_by='username' user_sort_dir=next_user_sort_dirs.username %}">
                        Username
                        {% if user_sort_by == 'username' %}
                            <i class="bi bi-arrow-{% if user_sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col" class="d-none d-md-table-cell">
                    <a href="?{% url_replace user_sort_by='email' user_sort_dir=next_user_sort_dirs.email %}">
                        Email
                        {% if user_sort_by == 'email' %}
                            <i class="bi bi-arrow-{% if user_sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col" class="d-none d-sm-table-cell">
                    <a href="?{% url_replace user_sort_by='profile__name' user_sort_dir=next_user_sort_dirs.profile__name %}">
                        Name
                        {% if user_sort_by == 'profile__name' %}
                            <i class="bi bi-arrow-{% if user_sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col">
                    <a href="?{% url_replace user_sort_by='is_superuser' user_sort_dir=next_user_sort_dirs.is_superuser %}">
                        Level
                        {% if user_sort_by == 'is_superuser' %}
                            <i class="bi bi-arrow-{% if user_sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col" class="d-none d-md-table-cell">
                    <a href="?{% url_replace user_sort_by='last_login' user_sort_dir=next_user_sort_dirs.last_login %}">
                        Last Login
                        {% if user_sort_by == 'last_login' %}
                            <i class="bi bi-arrow-{% if user_sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <th scope="row">{{ forloop.counter0 | add:users.start_index }}</th>
                <td>{{ user.username }}</td>
                <td class="d-none d-md-table-cell">{{ user.email }}</td>
                <td class="d-none d-sm-table-cell">{{ user.profile.name }}</td>
                <td>
                    {% if user.is_primary_superuser %}
                        <span class="badge bg-primary">Primary</span>
                    {% elif user.is_superuser %}
                        <span class="badge bg-success">Superuser</span>
                    {% else %}
                        <span class="badge bg-secondary">Normal</span>
                    {% endif %}
                </td>
                <td class="d-none d-md-table-cell">{{ user.last_login|date:"Y-m-d H:i:s" }}</td>
                <td class="user-actions">
                    <div class="btn-group" role="group">
                        <a href="{% url 'user_system:view_user_info' user.id %}" class="btn btn-outline-dark btn-sm" title="View">
                            <i class="bi bi-eye"></i>
                        </a>
                        <div class="btn-group" role="group">
                            <button id="btnGroupDrop-{{ user.id }}" type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="More Actions">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="btnGroupDrop-{{ user.id }}">
                                <li>
                                    <form action="{% url 'user_system:login_as_user' user.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item" {% if user.id == request.user.id or user.is_primary_superuser %}disabled{% endif %}>
                                            <i class="bi bi-person-bounding-box me-2"></i>Login As
                                        </button>
                                    </form>
                                </li>
                                {% if request.user.is_primary_superuser %}
                                <li>
                                    <button type="button" class="dropdown-item user-action-btn"
                                            data-action-url="{% url 'user_system:toggle_superuser' user.id %}"
                                            data-action-method="POST"
                                            {% if user.id == request.user.id %}disabled{% endif %}>
                                        {% if user.is_superuser %}
                                            <i class="bi bi-person-dash me-2"></i>Demote
                                        {% else %}
                                            <i class="bi bi-person-plus me-2"></i>Promote
                                        {% endif %}
                                    </button>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button type="button" class="dropdown-item text-danger user-action-btn"
                                            data-action-url="{% url 'user_system:delete_user' user.id %}"
                                            data-action-method="POST"
                                            data-confirm="Are you sure you want to delete this user?"
                                            {% if user.id == request.user.id %}disabled{% endif %}>
                                        <i class="bi bi-trash me-2"></i>Delete
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">No users found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if users.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% url_replace user_page=1 %}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% url_replace user_page=users.previous_page_number %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        {% endif %}

        {% for num in users.paginator.page_range %}
            {% if users.number == num %}
                <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
            {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?{% url_replace user_page=num %}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if users.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% url_replace user_page=users.next_page_number %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% url_replace user_page=users.paginator.num_pages %}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
